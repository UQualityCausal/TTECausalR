<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Peirong Hao, Kevin Ying, Yizhe Xu" />

<meta name="date" content="2025-11-02" />

<title>A new-user, active comparator design; Intention-to-treat analysis</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">A new-user, active comparator design;
Intention-to-treat analysis</h1>
<h4 class="author">Peirong Hao, Kevin Ying, Yizhe Xu</h4>
<h4 class="date">2025-11-02</h4>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  <span class="at">collapse =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>  <span class="at">comment =</span> <span class="st">&quot;#&gt;&quot;</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">options</span>(<span class="at">warn =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="co"># Ignore all warnings</span></span></code></pre></div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>The <em>intention-to-treat (ITT)</em> effect estimates the causal
effect of initiating treatment regardless of patients adhere to their
initial treatment or not. It estimates the difference in potential
outcomes, which defined as the risk it would be if all individuals had
been assigned to the treatment versus the control group, regardless of
subsequent adherence to the assigned treatment. The <em>per-protocol
(PP)</em> effect considers the sustained treatment effect on outcome
from trial baseline, which is discussed in a separate vignette (add
link). Identification of the ITT effect in observational studies relies
on four assumptions listed below.</p>
<div id="no-interference" class="section level3">
<h3>1. No Interference</h3>
<p>One individual’s treatment assignment does not affect other
individuals’ outcomes.</p>
</div>
<div id="consistency" class="section level3">
<h3>2. Consistency</h3>
<p>The observed outcome is the potential outcome under the treatment one
actually received.</p>
</div>
<div id="positivity" class="section level3">
<h3>3. Positivity</h3>
<p>Every individual has a non-zero probability of receiving each
treatment strategy.</p>
</div>
<div id="conditional-exchangebility" class="section level3">
<h3>4. Conditional Exchangebility</h3>
<p>Treatment and outcome are assumed to be independent conditional on
all measured confounders, under the assumption that all variables
affecting both treatment assignment and outcome have been measured.</p>
</div>
<div id="load-packages" class="section level2">
<h2>Load packages</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">library</span>(TrialEmulation)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="fu">library</span>(survminer)</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="fu">library</span>(cobalt)</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>working_dir <span class="ot">&lt;-</span> <span class="fu">getwd</span>()</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>knitr<span class="sc">::</span>opts_knit<span class="sc">$</span><span class="fu">set</span>(<span class="at">root.dir =</span> working_dir)</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a><span class="co"># Set seed for reproducibility</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">412</span>)</span></code></pre></div>
</div>
<div id="simulate-observational-data" class="section level2">
<h2>Simulate observational data</h2>
<p>In this section, we simulate observational data that will be used in
the next section for emulating target trials.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Load pre-built R function for simulating data</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;generate_data_ITT.R&quot;</span>)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co"># Simulate data for n=1,000 eligible subjects over J=10 time points</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>simdata0 <span class="ot">&lt;-</span> <span class="fu">generate.final.data</span>(<span class="at">n=</span><span class="dv">1000</span>, <span class="at">J=</span><span class="dv">10</span>, <span class="at">n_ineligible=</span><span class="dv">100</span>) <span class="co"># 100 ineligible subjects never initiate treatment</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>simdata <span class="ot">&lt;-</span> simdata0 <span class="sc">%&gt;%</span> <span class="fu">select</span>(id, Time, X1, X2, X3, X4, Age, A, Y, C) </span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="fu">summary</span>(simdata<span class="sc">$</span>Time)</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co">#&gt;  -5.000  -1.000   1.000   1.512   4.000   9.000</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="co"># id: Subject identifier</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="co"># Time: Follow-up time in years, starts from 0 (baseline) to 9 (end of the study)</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="co"># X1: Time-varying categorical variable</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="co"># X2: Time-varying numeric variable</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a><span class="co"># X3: Fixed categorical variable</span></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a><span class="co"># X4: Fixed numeric variable </span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="co"># Age: Subject&#39;s age</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a><span class="co"># A: Treatment indicator (0=one treatment, 1=another treatment)</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="co"># Y: Outcome indicator (0=no event, 1=event occurred)</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a><span class="co"># C: Censoring indicator (0=not censored, 1=censored). Note that censoring occurs in two scenarios: </span></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a><span class="do">### 1) administrative censoring, when participants are followed through</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a><span class="do">###    until the study end time but do not develop an event.</span></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a><span class="do">### 2) early dropout, when participants leave the study before developing </span></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a><span class="do">###    an event or the end of study.</span></span></code></pre></div>
</div>
</div>
<div id="target-trial-emulation" class="section level1">
<h1>Target Trial Emulation</h1>
<p>We need to specify the target trial we want to emulate and that would
answer our research questions of interst before we build the dataset.
Below, we present a side-by-side illustration of how to specify a
hypothetical target trial and how to emulate such a trial using
observational data, i.e., emulated target trial. The emulation process
has several key components and we will go through each of them. In this
emulation example, we estimate the ITT effect of ARB versus ACEI on all
cause mortality.</p>
<div id="target-trial-design-table" class="section level3">
<h3>Target Trial Design Table</h3>
<table style="width:100%;">
<colgroup>
<col width="8%" />
<col width="41%" />
<col width="48%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Component</strong></th>
<th><strong>Hypothetical Target Trial</strong></th>
<th><strong>Emulated Target Trial</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Eligibility Criteria</strong></td>
<td><ol style="list-style-type: decimal">
<li><p>Age ≥ 18 years.</p></li>
<li><p>No history of ARB or ACEI use.</p></li>
</ol></td>
<td>Same but with the following: Patients did not use ARB or ACEI in the
past two years according to recorded data.</td>
</tr>
<tr class="even">
<td><strong>Treatment Strategies</strong></td>
<td>One group initiates ACEI treatment, while the other group initiates
ARB.</td>
<td>Classify patients as ACEI initiators vs. ARB initiators.</td>
</tr>
<tr class="odd">
<td><strong>Treatment Assignment</strong></td>
<td>Subjects are randomly assigned to ARB or ACEI and aware of the
treatment assignment.</td>
<td>Assignment is based on observed ARB or ACEI initiation using
observed data. Randomization is emulated using propensity score
weighting approach.</td>
</tr>
<tr class="even">
<td><strong>Follow-up</strong></td>
<td>Participants are followed from randomization until the earliest
occurrence of: death, loss to follow-up, or study end date.</td>
<td>From treatment initiation until the earliest of: death, loss to
follow-up, or study end date.</td>
</tr>
<tr class="odd">
<td><strong>Outcome</strong></td>
<td>All-cause mortality.</td>
<td>Same.</td>
</tr>
<tr class="even">
<td><strong>Causal Contrast</strong></td>
<td>ITT effect of initiating ARB vs. ACEI on the risk of death.</td>
<td>Observational analog.</td>
</tr>
<tr class="odd">
<td><strong>Statistical Analysis</strong></td>
<td>ITT analysis estimating risk differences at 5 and 8 years between
treatment groups.</td>
<td>Same, but apply propensity score weighting approach to account for
baseline confounding by indication.</td>
</tr>
</tbody>
</table>
<p>We now prepare an analysis-ready dataset using the simulated
observational data by emulating the hypothetical randomized trial
specified above. First, we create an eligibility indicator, denoted as
<span class="math inline">\(E\)</span>, based on the criteria defined
under the first key component.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>simdata <span class="ot">&lt;-</span> simdata <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  <span class="fu">filter</span>((<span class="fu">max</span>(Time) <span class="sc">-</span> <span class="fu">min</span>(Time)) <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="co"># Have at least two years of recorded data</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>  <span class="fu">ungroup</span>()                    </span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>  </span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="co"># Eligibility indicator E is binary (1=eligible, 0=not eligible)</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="co"># lag(A) gives the treatment status from 1 period ago, lag(A, 2) is from 2 periods ago.</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>simdata <span class="ot">&lt;-</span> simdata <span class="sc">%&gt;%</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">E =</span> <span class="fu">case_when</span>(</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>      <span class="co"># First two observations per ID are not eligible</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>      Time <span class="sc">&lt;=</span> (<span class="fu">min</span>(Time) <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">~</span> <span class="cn">NA</span>, </span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>      <span class="co"># At least 18 years old, have not experienced outcome of interest/censoring</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>      <span class="at">.default =</span> <span class="fu">as.integer</span>(Age <span class="sc">&gt;=</span> <span class="dv">18</span> <span class="sc">&amp;</span> <span class="fu">cumsum</span>(Y) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">cumsum</span>(C) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>                           (<span class="fu">lag</span>(A) <span class="sc">+</span> <span class="fu">lag</span>(A, <span class="dv">2</span>)) <span class="sc">==</span> <span class="dv">0</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code></pre></div>
<p>Let us examine how eligibility changes over time using the first
subject as an example.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>simdata <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="fu">select</span>(id, Time, Age, A, Y, C, E)</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="co">#&gt; # A tibble: 15 × 7</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="co">#&gt;       id  Time   Age     A     Y     C     E</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="co">#&gt;    &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="co">#&gt;  1     1    -5  30.8    NA     0     0    NA</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="co">#&gt;  2     1    -4  31.8    NA     0     0    NA</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="co">#&gt;  3     1    -3  32.8    NA     0     0    NA</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="co">#&gt;  4     1    -2  33.8    NA     0     0    NA</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="co">#&gt;  5     1    -1  34.8    NA     0     0    NA</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a><span class="co">#&gt;  6     1     0  35.8     0     0     0    NA</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a><span class="co">#&gt;  7     1     1  36.8     1     0     0    NA</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a><span class="co">#&gt;  8     1     2  37.8     1     0     0     0</span></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a><span class="co">#&gt;  9     1     3  38.8     1     0     0     0</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a><span class="co">#&gt; 10     1     4  39.8     1     0     0     0</span></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a><span class="co">#&gt; 11     1     5  40.8     1     0     0     0</span></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a><span class="co">#&gt; 12     1     6  41.8     0     0     0     0</span></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a><span class="co">#&gt; 13     1     7  42.8     0     0     0     0</span></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a><span class="co">#&gt; 14     1     8  43.8     0     0     0     1</span></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a><span class="co">#&gt; 15     1     9  44.8     1     0     0     1</span></span></code></pre></div>
<p>Subject 1’s eligibility status over time:</p>
<ul>
<li>Time -5 to -1: Not eligible due to missing historical treatment
data.</li>
<li>Time 0 to 1: Not eligible due to fewer than 2 years of historical
treatment data.</li>
<li>Time 2 to 7: Still not eligible. ARB treatment within the previous 2
years.</li>
<li>Time 8 to 9: Eligible because satisfies all criteria.</li>
</ul>
<p>The next step is to identify all individuals who were ever eligible
and record the first time they met the eligibility criteria.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>eligible_info <span class="ot">&lt;-</span> simdata <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">ever_eligible =</span> <span class="fu">any</span>(E <span class="sc">==</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>            <span class="at">first_eligible_time =</span> <span class="fu">ifelse</span>(<span class="fu">any</span>(E <span class="sc">==</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>                                <span class="fu">min</span>(Time[E <span class="sc">==</span> <span class="dv">1</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="cn">NA</span>),</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">&#39;drop&#39;</span>) </span></code></pre></div>
<p>In this data, 360 subjects are eligible.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">table</span>(eligible_info<span class="sc">$</span>ever_eligible)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="co">#&gt; FALSE  TRUE </span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="co">#&gt;   724   360</span></span></code></pre></div>
<p>We now add the eligibility information to our main dataset.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>simdata <span class="ot">&lt;-</span> simdata <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  <span class="fu">left_join</span>(eligible_info, <span class="at">by =</span> <span class="st">&quot;id&quot;</span>) </span></code></pre></div>
<p>In our example, follow-up begins at the time of patients become
eligible and initiate ACEI or ARB.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>simdata.one.trial <span class="ot">&lt;-</span> simdata <span class="sc">%&gt;%</span> <span class="co"># Only include eligible times</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>  <span class="fu">filter</span>(ever_eligible <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> Time <span class="sc">&gt;=</span> first_eligible_time) <span class="sc">%&gt;%</span> </span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">follow_up =</span> Time <span class="sc">-</span> first_eligible_time) <span class="sc">%&gt;%</span> <span class="co"># Time since first eligibility</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>ever_eligible, <span class="sc">-</span>first_eligible_time, <span class="sc">-</span>E)</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>baseline <span class="ot">&lt;-</span> simdata.one.trial <span class="sc">%&gt;%</span> </span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>  <span class="fu">filter</span>(follow_up <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="co"># Baseline is first eligible time</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>  <span class="fu">select</span>(id, A, X1, X2, X3, X4, Age) <span class="sc">%&gt;%</span> <span class="co"># Baseline treatment and covariate values</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">assigned_treatment =</span> A, <span class="at">X1_0 =</span> X1, <span class="at">X2_0 =</span> X2, </span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>         <span class="at">X3_0 =</span> X3, <span class="at">X4_0 =</span> X4, <span class="at">Age_0 =</span> Age) </span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>simdata.one.trial <span class="ot">&lt;-</span> simdata.one.trial <span class="sc">%&gt;%</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>  <span class="fu">filter</span>(follow_up <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="co"># Exclude baseline info</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(X3, X4)) <span class="sc">%&gt;%</span> <span class="co"># Exclude fixed covariates</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>  <span class="fu">left_join</span>(baseline, <span class="at">by =</span> <span class="st">&quot;id&quot;</span>) <span class="sc">%&gt;%</span> <span class="co"># Merge baseline information as columns</span></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>  <span class="fu">arrange</span>(id, follow_up)</span></code></pre></div>
<p>The appropriate statistical analysis depends on the censoring
mechanisms:</p>
</div>
<div id="scenario-1-non-informative-censoring" class="section level3">
<h3>Scenario 1: Non-informative Censoring</h3>
<ul>
<li><p>Example: Observational study where early dropout is independent
of patient characteristics.</p></li>
<li><p>Method: 1) Inverse probability (IP) weighting of propensity score
to account for baseline confounding, and 2) IP-weighted cox model to
estimate hazard ratio or risk difference.</p></li>
</ul>
</div>
<div id="scenario-2-informative-censoring" class="section level3">
<h3>Scenario 2: Informative Censoring</h3>
<ul>
<li><p>Example: Observational study with sicker patients drop out
early.</p></li>
<li><p>Method: 1) IP weighting of propensity score, 2) IP of censoring
weighting (IPCW), and 3) weighted pooled logistic regression using both
baseline treatment and censoring weights.</p></li>
</ul>
<p>Below, we demonstrate the analysis for each of the 2 scenarios.</p>
</div>
<div id="scenario-1-non-informative-censoring-1" class="section level2">
<h2>Scenario 1: Non-informative Censoring</h2>
<ul>
<li>Step 1 Data Preparation: Convert long format data (multiple rows per
subject) to wide format (one row per subject), retaining baseline
covariates, treatment variable, follow-up time, and outcome status.</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co"># Find event/censoring time (min time of the two) for subjects who experience it </span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="co"># Find follow-up time (max time) for subjects who never experience event/censoring </span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>simdata.short <span class="ot">&lt;-</span> simdata.one.trial <span class="sc">%&gt;%</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>    <span class="at">event_or_cens =</span> <span class="fu">any</span>(Y <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> C <span class="sc">==</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>    <span class="at">follow_up =</span> <span class="fu">ifelse</span>(event_or_cens,</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>                       <span class="fu">min</span>(follow_up[Y <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> C <span class="sc">==</span> <span class="dv">1</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>                       <span class="fu">max</span>(follow_up, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="fu">ifelse</span>(<span class="fu">any</span>(Y <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> C <span class="sc">==</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>, <span class="dv">0</span>), </span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>  <span class="fu">left_join</span>(simdata.one.trial, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;follow_up&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>  <span class="fu">select</span>(id, assigned_treatment, X1_0, X2_0, X3_0, X4_0, Age_0, follow_up, outcome) <span class="sc">%&gt;%</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>  <span class="fu">arrange</span>(id)</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a><span class="co"># Check if all subjects are included</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a><span class="fu">setequal</span>(<span class="fu">unique</span>(simdata.one.trial<span class="sc">$</span>id), <span class="fu">unique</span>(simdata.short<span class="sc">$</span>id))</span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<ul>
<li>Step 2 Treatment Weights: Estimate propensity scores, i.e., the
probabilities of initiating ARB using logistic regression with baseline
covariates as predictors. Compute unstabilized IP of treatment weights
(IPTW) as one over propensity scores. We evaluate covariate balance
using the absolute standardized mean difference (ASMD) metric and
examine overlap of treatment by visualizing the distributions of
propensity score between two treatment groups.</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># Fit a logistic regression</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>ps_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(assigned_treatment <span class="sc">~</span> X1_0 <span class="sc">+</span> X2_0 <span class="sc">+</span> X3_0 <span class="sc">+</span> X4_0 <span class="sc">+</span> Age_0, </span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>                 <span class="at">data =</span> simdata.short, </span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>                 <span class="at">family =</span> binomial)</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="co"># Calculate propensity scores</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">predict</span>(ps_model, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="co"># Calculate inverse probability of treatment weights (IPTW)</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>simdata.short <span class="ot">&lt;-</span> simdata.short <span class="sc">%&gt;%</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>    <span class="at">trt_weight =</span> <span class="fu">if_else</span>(</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>      assigned_treatment <span class="sc">==</span> <span class="dv">1</span>, </span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>      <span class="dv">1</span><span class="sc">/</span>p, <span class="co"># 1/P(treatment) for treated subjects</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>      <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>p) <span class="co"># 1/(1-P(treatment)) for control subjects</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>  ))</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a><span class="co"># Visualize weight overlap</span></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>trt_weight_plot <span class="ot">&lt;-</span> simdata.short <span class="sc">%&gt;%</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">treatment_group =</span> <span class="fu">factor</span>(assigned_treatment, </span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>                                  <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>                                  <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Control&quot;</span>, <span class="st">&quot;Treated&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> trt_weight, <span class="at">fill =</span> treatment_group, <span class="at">group =</span> treatment_group)) <span class="sc">+</span></span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> . <span class="sc">%&gt;%</span> <span class="fu">filter</span>(treatment_group <span class="sc">==</span> <span class="st">&quot;Treated&quot;</span>),</span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> . <span class="sc">%&gt;%</span> <span class="fu">filter</span>(treatment_group <span class="sc">==</span> <span class="st">&quot;Control&quot;</span>), </span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">y =</span> <span class="sc">-</span><span class="fu">after_stat</span>(density)), <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Treatment Weight&quot;</span>) <span class="sc">+</span></span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;Treatment Group&quot;</span>,</span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Distribution of Treatment Weights&quot;</span>) <span class="sc">+</span></span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>))</span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a><span class="fu">print</span>(trt_weight_plot)</span></code></pre></div>
<p><img role="img" src="data:image/png;base64,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" /><!-- --></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="co"># Truncate weights above 99th percentile to improve stability</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="co"># Alternative approaches for selecting a threshold: summary statistics/histogram</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>trt_weight_cutoff <span class="ot">&lt;-</span> <span class="fu">quantile</span>(simdata.short<span class="sc">$</span>trt_weight, <span class="fl">0.99</span>)</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>simdata.short <span class="ot">&lt;-</span> simdata.short <span class="sc">%&gt;%</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trt_weight =</span> <span class="fu">ifelse</span>(trt_weight <span class="sc">&gt;</span> trt_weight_cutoff, </span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>                             trt_weight_cutoff, trt_weight))</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="co"># Check covariate balance</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>bal_s2 <span class="ot">&lt;-</span> <span class="fu">bal.tab</span>(assigned_treatment <span class="sc">~</span> X1_0 <span class="sc">+</span> X2_0 <span class="sc">+</span> X3_0 <span class="sc">+</span> X4_0 <span class="sc">+</span> Age_0, </span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>        <span class="at">data =</span> simdata.short, <span class="at">estimand =</span> <span class="st">&quot;ATE&quot;</span>, <span class="at">un =</span> <span class="cn">TRUE</span>, <span class="co"># Include unadjusted balance</span></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>        <span class="at">weights =</span> simdata.short<span class="sc">$</span>trt_weight,</span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>        <span class="at">disp.means =</span> <span class="cn">TRUE</span>, <span class="at">disp.sds =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a><span class="co"># A threshold of 0.1 is used to determine an acceptable balance.</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a><span class="fu">love.plot</span>(bal_s2, <span class="at">var.order =</span> <span class="st">&quot;unadjusted&quot;</span>, <span class="at">abs =</span> <span class="cn">TRUE</span>, <span class="at">thresholds =</span> <span class="fu">c</span>(<span class="at">m =</span> <span class="fl">0.1</span>),</span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a>          <span class="at">stats =</span> <span class="st">&quot;mean.diffs&quot;</span>, <span class="at">sample.names =</span> <span class="fu">c</span>(<span class="st">&quot;Unweighted&quot;</span>, <span class="st">&quot;Weighted&quot;</span>),</span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>          <span class="at">title =</span> <span class="st">&quot;Covariate Balance Before and After Weighting&quot;</span>, </span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a>          <span class="at">stars =</span> <span class="st">&quot;raw&quot;</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>))</span></code></pre></div>
<p><img role="img" src="data:image/png;base64,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" /><!-- --></p>
<ul>
<li>Step 3 Outcome Model: Fit a IP weighted Cox Proportional Hazards
(CPH) model.</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># Fit weighted CPH model</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>weighted_cox_model <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(follow_up, outcome) <span class="sc">~</span> assigned_treatment, </span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>                             <span class="at">data =</span> simdata.short, <span class="at">weights =</span> trt_weight)</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="fu">summary</span>(weighted_cox_model)</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="co">#&gt; coxph(formula = Surv(follow_up, outcome) ~ assigned_treatment, </span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="co">#&gt;     data = simdata.short, weights = trt_weight)</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a><span class="co">#&gt;   n= 352, number of events= 23 </span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a><span class="co">#&gt;                       coef exp(coef) se(coef) robust se      z Pr(&gt;|z|)</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a><span class="co">#&gt; assigned_treatment -0.2607    0.7705   0.3144    0.4414 -0.591    0.555</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a><span class="co">#&gt;                    exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a><span class="co">#&gt; assigned_treatment    0.7705      1.298    0.3244      1.83</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a><span class="co">#&gt; Concordance= 0.544  (se = 0.056 )</span></span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a><span class="co">#&gt; Likelihood ratio test= 0.7  on 1 df,   p=0.4</span></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a><span class="co">#&gt; Wald test            = 0.35  on 1 df,   p=0.6</span></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a><span class="co">#&gt; Score (logrank) test = 0.69  on 1 df,   p=0.4,   Robust = 0.35  p=0.6</span></span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a><span class="co">#&gt;   (Note: the likelihood ratio and score tests assume independence of</span></span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a><span class="co">#&gt;      observations within a cluster, the Wald and robust score tests do not).</span></span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a><span class="do">##### Interpretation:</span></span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a><span class="co"># Hazard ratio (HR) = exp(coef)</span></span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a><span class="co"># coef &lt; 0 &amp; HR &lt; 1: treatment is associated with lower risk.</span></span>
<span id="cb13-28"><a href="#cb13-28" tabindex="-1"></a><span class="co"># coef &gt; 0 &amp; HR &gt; 1: treatment is associated with higher risk.</span></span>
<span id="cb13-29"><a href="#cb13-29" tabindex="-1"></a><span class="co"># P-value &lt;= alpha = 0.05 &amp; 95% confidence interval excluding 1 suggest a statistically significant effect (not in this case).</span></span></code></pre></div>
<ul>
<li>Step 4 Assumption Check: Conduct visual checks for PH assumption in
the Cox model.</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co"># Schoenfeld Residuals plot: A flat line indicates that the proportional hazards assumption holds.</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">cox.zph</span>(weighted_cox_model))</span></code></pre></div>
<p><img role="img" src="data:image/png;base64,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" /><!-- --></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="co"># Log-log plot: Parallel lines indicate proportional hazards assumption is met.</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>simdata.short.nonzero <span class="ot">&lt;-</span> simdata.short <span class="sc">%&gt;%</span> <span class="fu">filter</span>(follow_up <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>surv_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(follow_up, outcome) <span class="sc">~</span> assigned_treatment, <span class="at">data =</span> simdata.short.nonzero)</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="fu">ggsurvplot</span>(surv_fit, <span class="at">data =</span> simdata.short, <span class="at">fun =</span> <span class="st">&quot;cloglog&quot;</span>, </span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>           <span class="at">title =</span> <span class="st">&quot;Log-log Plot&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;log(Time)&quot;</span>,</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>           <span class="at">legend.title =</span> <span class="st">&quot;Treatment Group&quot;</span>, </span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>           <span class="at">legend.labs =</span> <span class="fu">c</span>(<span class="st">&quot;Control&quot;</span>, <span class="st">&quot;Treatment&quot;</span>),</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>           <span class="at">ggtheme =</span> <span class="fu">theme</span>(<span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),      </span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>              <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)))</span></code></pre></div>
<p><img role="img" src="data:image/png;base64,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" /><!-- --></p>
</div>
<div id="scenario-2-informative-censoring-1" class="section level2">
<h2>Scenario 2: Informative Censoring</h2>
<ul>
<li><p>Step 1 Data Preparation: Keep the data in long format.</p></li>
<li><p>Step 2 Treatment and Censoring Weights: Estimate censoring
probabilities at each time point using logistic regression. Use inverse
probability of censoring weights (IPCW) to adjust for the bias caused by
informative censoring. Calculate cumulative censoring weights over time.
Then, apply a combination of treatment and censoring weights.</p></li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="co"># Fit logistic regression to predict censoring based on treatment and covariates</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="co"># Skip baseline observations since baseline censoring weight is always 1</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="co"># Recall C=1: censored, but we want to know the probability of not being censored (C_neg=0)</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>simdata.one.trial <span class="ot">&lt;-</span> simdata.one.trial <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">C_neg =</span> <span class="dv">1</span><span class="sc">-</span>C)</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>censor_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(C_neg <span class="sc">~</span> A <span class="sc">+</span> X1_0 <span class="sc">+</span> X2_0 <span class="sc">+</span> X3_0 <span class="sc">+</span> X4_0 <span class="sc">+</span> Age_0, </span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="at">data =</span> simdata.one.trial <span class="sc">%&gt;%</span> <span class="fu">filter</span>(follow_up <span class="sc">&gt;</span> <span class="dv">0</span>), <span class="at">family =</span> binomial)</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>simdata.one.trial <span class="ot">&lt;-</span> simdata.one.trial <span class="sc">%&gt;%</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>    <span class="at">censor_probs =</span> <span class="fu">predict</span>(censor_model, <span class="at">newdata =</span> ., <span class="at">type =</span> <span class="st">&quot;response&quot;</span>), <span class="co"># Calculate censoring probabilities</span></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>    </span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>    <span class="at">censor_weight =</span> <span class="fu">ifelse</span>(C_neg <span class="sc">==</span> <span class="dv">1</span>, <span class="co"># Calculate censoring weights (unstablized)</span></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>                           <span class="dv">1</span> <span class="sc">/</span> censor_probs,  <span class="co"># Not censored</span></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a>                           <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> censor_probs))  <span class="co"># Censored</span></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a>  )</span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a><span class="co"># Calculate cumulative censoring weights up to current time</span></span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a>simdata.one.trial <span class="ot">&lt;-</span> simdata.one.trial <span class="sc">%&gt;%</span></span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>  <span class="fu">arrange</span>(id, follow_up) <span class="sc">%&gt;%</span></span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cumulative_censor_weight =</span> <span class="fu">cumprod</span>(censor_weight)) <span class="sc">%&gt;%</span> </span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a><span class="co"># Calculate summary statistics for cumulative censoring weights by treatment group</span></span>
<span id="cb16-25"><a href="#cb16-25" tabindex="-1"></a>censor_weight_summary <span class="ot">&lt;-</span> simdata.one.trial <span class="sc">%&gt;%</span></span>
<span id="cb16-26"><a href="#cb16-26" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">treatment_group =</span> <span class="fu">factor</span>(assigned_treatment, </span>
<span id="cb16-27"><a href="#cb16-27" tabindex="-1"></a>                                  <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb16-28"><a href="#cb16-28" tabindex="-1"></a>                                  <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Control&quot;</span>, <span class="st">&quot;Treated&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb16-29"><a href="#cb16-29" tabindex="-1"></a>  <span class="fu">group_by</span>(treatment_group) <span class="sc">%&gt;%</span></span>
<span id="cb16-30"><a href="#cb16-30" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb16-31"><a href="#cb16-31" tabindex="-1"></a>    <span class="at">min =</span> <span class="fu">min</span>(cumulative_censor_weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-32"><a href="#cb16-32" tabindex="-1"></a>    <span class="at">max =</span> <span class="fu">max</span>(cumulative_censor_weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-33"><a href="#cb16-33" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(cumulative_censor_weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-34"><a href="#cb16-34" tabindex="-1"></a>    <span class="at">sd =</span> <span class="fu">sd</span>(cumulative_censor_weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-35"><a href="#cb16-35" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">&#39;drop&#39;</span>)<span class="sc">%&gt;%</span></span>
<span id="cb16-36"><a href="#cb16-36" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(min, max, mean, sd), <span class="sc">~</span> <span class="fu">round</span>(.x, <span class="dv">2</span>)))</span>
<span id="cb16-37"><a href="#cb16-37" tabindex="-1"></a><span class="fu">print</span>(censor_weight_summary)</span>
<span id="cb16-38"><a href="#cb16-38" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 × 5</span></span>
<span id="cb16-39"><a href="#cb16-39" tabindex="-1"></a><span class="co">#&gt;   treatment_group   min   max  mean    sd</span></span>
<span id="cb16-40"><a href="#cb16-40" tabindex="-1"></a><span class="co">#&gt;   &lt;fct&gt;           &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb16-41"><a href="#cb16-41" tabindex="-1"></a><span class="co">#&gt; 1 Control          1.01 120.   2.53  6.12</span></span>
<span id="cb16-42"><a href="#cb16-42" tabindex="-1"></a><span class="co">#&gt; 2 Treated          1.01  39.8  2.32  4.25</span></span>
<span id="cb16-43"><a href="#cb16-43" tabindex="-1"></a></span>
<span id="cb16-44"><a href="#cb16-44" tabindex="-1"></a><span class="co"># Truncate extreme censoring weights above 99th percentile</span></span>
<span id="cb16-45"><a href="#cb16-45" tabindex="-1"></a>censor_weight_cutoff <span class="ot">&lt;-</span> <span class="fu">quantile</span>(simdata.one.trial<span class="sc">$</span>cumulative_censor_weight, <span class="fl">0.99</span>, <span class="at">na.rm=</span>T)</span>
<span id="cb16-46"><a href="#cb16-46" tabindex="-1"></a>simdata.one.trial <span class="ot">&lt;-</span> simdata.one.trial <span class="sc">%&gt;%</span></span>
<span id="cb16-47"><a href="#cb16-47" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cumulative_censor_weight =</span> <span class="fu">ifelse</span>(cumulative_censor_weight <span class="sc">&gt;</span> censor_weight_cutoff, </span>
<span id="cb16-48"><a href="#cb16-48" tabindex="-1"></a>                                           censor_weight_cutoff, cumulative_censor_weight))</span>
<span id="cb16-49"><a href="#cb16-49" tabindex="-1"></a></span>
<span id="cb16-50"><a href="#cb16-50" tabindex="-1"></a><span class="co"># Combined weight</span></span>
<span id="cb16-51"><a href="#cb16-51" tabindex="-1"></a>simdata.one.trial <span class="ot">&lt;-</span> simdata.one.trial <span class="sc">%&gt;%</span></span>
<span id="cb16-52"><a href="#cb16-52" tabindex="-1"></a>  <span class="fu">left_join</span>(simdata.short <span class="sc">%&gt;%</span> <span class="fu">select</span>(id, trt_weight), <span class="at">by =</span> <span class="st">&quot;id&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-53"><a href="#cb16-53" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">combi_weight =</span> trt_weight <span class="sc">*</span> cumulative_censor_weight) </span></code></pre></div>
<ul>
<li>Step 3 Outcome Model: Fit a weighted pooled logistic
regression.</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co"># Fit weighted pooled logistic regression (start from baseline time)</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="co"># Do not need to add X1_0 + X2_0 + X3_0 + X4_0 + age_0 as predictors for the unstablized weights case</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>weighted_iptw_ipcw_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> assigned_treatment <span class="sc">+</span> follow_up <span class="sc">+</span> <span class="fu">I</span>(follow_up<span class="sc">^</span><span class="dv">2</span>), </span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>  <span class="at">data =</span> simdata.one.trial <span class="sc">%&gt;%</span> <span class="fu">filter</span>(C <span class="sc">!=</span> <span class="dv">1</span>), <span class="co"># Exclude censored observations (C=1) because their outcomes are unknown</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>  <span class="at">weights =</span> combi_weight, <span class="at">family =</span> binomial)</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="fu">summary</span>(weighted_iptw_ipcw_model)</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a><span class="co">#&gt; glm(formula = Y ~ assigned_treatment + follow_up + I(follow_up^2), </span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a><span class="co">#&gt;     family = binomial, data = simdata.one.trial %&gt;% filter(C != </span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a><span class="co">#&gt;         1), weights = combi_weight)</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a><span class="co">#&gt;                     Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a><span class="co">#&gt; (Intercept)        -4.223368   0.553317  -7.633  2.3e-14 ***</span></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a><span class="co">#&gt; assigned_treatment -0.357266   0.280857  -1.272    0.203    </span></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a><span class="co">#&gt; follow_up           0.060933   0.322972   0.189    0.850    </span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a><span class="co">#&gt; I(follow_up^2)     -0.003961   0.041174  -0.096    0.923    </span></span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a><span class="co">#&gt;     Null deviance: 563.18  on 1485  degrees of freedom</span></span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a><span class="co">#&gt; Residual deviance: 561.33  on 1482  degrees of freedom</span></span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a><span class="co">#&gt; AIC: 560.21</span></span>
<span id="cb17-27"><a href="#cb17-27" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb17-28"><a href="#cb17-28" tabindex="-1"></a><span class="co">#&gt; Number of Fisher Scoring iterations: 6</span></span></code></pre></div>
<ul>
<li>Step 4 Output: Calculate cumulative incidences with each treatment
group at specific time points and then compute risk differences and risk
ratios between treatment groups.</li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co"># Create 2 counterfactual datasets such that all individuals are assigned to treatment/control</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>gen_cf_data <span class="ot">&lt;-</span> <span class="cf">function</span>(data, treatment_value) {</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>  data_cf <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">assigned_treatment =</span> treatment_value)</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>  <span class="fu">return</span>(data_cf)</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>}</span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>data_all_treated <span class="ot">&lt;-</span> <span class="fu">gen_cf_data</span>(simdata.one.trial <span class="sc">%&gt;%</span> <span class="fu">filter</span>(C <span class="sc">!=</span> <span class="dv">1</span>), <span class="dv">1</span>)</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>data_all_untreated <span class="ot">&lt;-</span> <span class="fu">gen_cf_data</span>(simdata.one.trial <span class="sc">%&gt;%</span> <span class="fu">filter</span>(C <span class="sc">!=</span> <span class="dv">1</span>), <span class="dv">0</span>)</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co"># Calculate conditional cumulative incidences (combined weights)</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>calc_condit_cum_inc <span class="ot">&lt;-</span> <span class="cf">function</span>(outcome_model, data) {</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>  </span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>  pred_data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">select</span>(id, follow_up, assigned_treatment)</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>  <span class="co"># Predict probabilities</span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>  pred_data<span class="sc">$</span>prob_outcome <span class="ot">&lt;-</span> <span class="fu">predict</span>(outcome_model, <span class="at">newdata =</span> pred_data, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>) </span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>  </span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>  <span class="co"># Calculate cumulative incidence for each subject</span></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>  cum_inc <span class="ot">&lt;-</span> pred_data <span class="sc">%&gt;%</span></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>    <span class="fu">arrange</span>(id, follow_up) <span class="sc">%&gt;%</span></span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a>    <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>      <span class="at">survival_prob =</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">-</span> prob_outcome), <span class="co"># P(alive up to current time)</span></span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a>      <span class="at">survival_prob_lag =</span> <span class="fu">lag</span>(survival_prob, <span class="at">default =</span> <span class="dv">1</span>), <span class="co"># P(alive up to last time)</span></span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a>      <span class="at">death_prob =</span> survival_prob_lag <span class="sc">*</span> prob_outcome, <span class="co"># P(dead at current time)</span></span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a>      <span class="at">cumulative_incidence =</span> <span class="fu">cumsum</span>(death_prob) </span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>()</span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a>  </span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a>  <span class="fu">return</span>(cum_inc)</span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a>}</span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" tabindex="-1"></a>condit_cum_inc_treated <span class="ot">&lt;-</span> <span class="fu">calc_condit_cum_inc</span>(weighted_iptw_ipcw_model, data_all_treated)</span>
<span id="cb19-24"><a href="#cb19-24" tabindex="-1"></a>condit_cum_inc_untreated <span class="ot">&lt;-</span> <span class="fu">calc_condit_cum_inc</span>(weighted_iptw_ipcw_model, data_all_untreated)</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co"># Calculate marginal cumulative incidences</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="co"># Average conditional cumulative incidence at each visit across all individuals in two data sets</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>marginal_res <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>  condit_cum_inc_treated <span class="sc">%&gt;%</span> </span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>    <span class="fu">group_by</span>(follow_up) <span class="sc">%&gt;%</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">mean_cum_inc =</span> <span class="fu">mean</span>(cumulative_incidence, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">&#39;drop&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">treatment =</span> <span class="st">&quot;Treated&quot;</span>),</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>  </span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>  condit_cum_inc_untreated <span class="sc">%&gt;%</span> </span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>    <span class="fu">group_by</span>(follow_up) <span class="sc">%&gt;%</span></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">mean_cum_inc =</span> <span class="fu">mean</span>(cumulative_incidence, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">&#39;drop&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">treatment =</span> <span class="st">&quot;Untreated&quot;</span>)</span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a>)</span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a><span class="co"># Calculate incidence differences and ratios</span></span>
<span id="cb20-16"><a href="#cb20-16" tabindex="-1"></a>inc_comp <span class="ot">&lt;-</span> marginal_res <span class="sc">%&gt;%</span></span>
<span id="cb20-17"><a href="#cb20-17" tabindex="-1"></a>  <span class="fu">select</span>(follow_up, treatment, mean_cum_inc) <span class="sc">%&gt;%</span></span>
<span id="cb20-18"><a href="#cb20-18" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> treatment, <span class="at">values_from =</span> mean_cum_inc) <span class="sc">%&gt;%</span></span>
<span id="cb20-19"><a href="#cb20-19" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">incidence_diff =</span> Treated <span class="sc">-</span> Untreated, <span class="at">incidence_ratio =</span> Treated <span class="sc">/</span> Untreated)</span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># Marginal Cumulative Incidences at different Time Points</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>key_times <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">7</span>)</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>marginal_res <span class="sc">%&gt;%</span> </span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>  <span class="fu">filter</span>(follow_up <span class="sc">%in%</span> key_times) <span class="sc">%&gt;%</span></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>  <span class="fu">arrange</span>(treatment, follow_up)<span class="sc">%&gt;%</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> treatment, <span class="at">values_from =</span> mean_cum_inc)</span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 × 3</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a><span class="co">#&gt;   follow_up Treated Untreated</span></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a><span class="co">#&gt;       &lt;int&gt;   &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a><span class="co">#&gt; 1         4  0.0451    0.0637</span></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a><span class="co">#&gt; 2         7  0.0808    0.113</span></span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a><span class="co"># Risk Differences and Ratios at different Time Points</span></span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a>inc_comp <span class="sc">%&gt;%</span> </span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a>  <span class="fu">filter</span>(follow_up <span class="sc">%in%</span> key_times) <span class="sc">%&gt;%</span></span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a>  <span class="fu">select</span>(follow_up, Treated, Untreated, incidence_diff, incidence_ratio)</span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 × 5</span></span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a><span class="co">#&gt;   follow_up Treated Untreated incidence_diff incidence_ratio</span></span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a><span class="co">#&gt;       &lt;int&gt;   &lt;dbl&gt;     &lt;dbl&gt;          &lt;dbl&gt;           &lt;dbl&gt;</span></span>
<span id="cb21-20"><a href="#cb21-20" tabindex="-1"></a><span class="co">#&gt; 1         4  0.0451    0.0637        -0.0186           0.708</span></span>
<span id="cb21-21"><a href="#cb21-21" tabindex="-1"></a><span class="co">#&gt; 2         7  0.0808    0.113         -0.0324           0.714</span></span></code></pre></div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
