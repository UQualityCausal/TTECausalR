<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Kevin Ying" />

<meta name="date" content="2025-07-29" />

<title>Target Trial Emulation</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Target Trial Emulation</h1>
<h4 class="author">Kevin Ying</h4>
<h4 class="date">2025-07-29</h4>



<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>Randomized controlled trials (RCTs) are the gold standard for
evaluating medical interventions, but they are often impractical, slow,
or costly. Modern causal inference methods, coupled with real-world data
(RWD), provide a faster, well-powered alternative for estimating
treatment effects across diverse patient populations.Despite this
potential, several barriers hinder their effective use in transnational
research. A key challenge is aligning “time zero,” the point at which a
patient cohort is defined, eligibility, and treatment assignment, which
leads to intractable bias. Target trial emulation (TTE) is a major
innovation that addresses these barriers by emulating RCT protocols
using RWD . The TTE framework has proven especially useful in fostering
improved communication between statisticians and clinicians to align
sound study design, incisive data analysis and clinical insight to
improve the quality of research. Furthermore, high-quality observational
studies can complement findings from RCTs and provide actionable
evidence (Wang et al. 2003). <br></p>
<p>This vignette aims to demonstrate how to create a study sample with
minimal bias. We briefly review the five key components in TTE and why
it is crucial to define a clear definition for each component.</p>
<div id="eligibility-criteria" class="section level2">
<h2>Eligibility Criteria</h2>
<ul>
<li>Eligibility criteria include inclusion and exclusion criteria and
both need to be defined using <strong>only information prior to or at
baseline</strong></li>
<li>Eligibility criteria that use post-baseline information induce
selection bias</li>
<li>Not all trials of interest can be emulated using observational data,
e.g., electronic health records (EHRs). TTE is only feasible when the
observational data contains all the information needed to apply the
pre-defined eligibility criteria</li>
</ul>
</div>
<div id="treatment-strategies" class="section level2">
<h2>Treatment Strategies</h2>
<ul>
<li>Observational data is best used to emulate <strong>a pragmatic
trial</strong> in the sense that
<ul>
<li>Treatment are compared under the usual conditions used</li>
<li>Cannot compare new treatment due to lack of data</li>
</ul></li>
<li>New user design is highly recommended to avoid <strong>prevalent
user bias</strong>
<ul>
<li>Treatment of interest (Hernan, 2015): Hormone therapy versus no
treatment, current users are likely to be CHD free</li>
<li>Given that hormone therapy may cause a short-term increase in the
risk of coronary heart disease (CHD)</li>
<li>Biased results due to not including patients who initiated hormone
therapy then switched due to side effects</li>
</ul></li>
<li>Benefits of using active control
<ul>
<li>Treatment of interest: ACEI versus ARB</li>
<li>Both medications are first-line antihypertensive medications that
are prescribed interchangeably by physicians</li>
<li>Thus, patients in these two treatment groups are much more similar,
which leads to smaller confounding by indication bias. We refer to this
as <strong>pseudo-randomized</strong></li>
<li>In contrast, in the example where hormone therapy is compared to no
therapy, patients who use the treatment can be very different than those
do not use the therapy, such as socioeconomic status and body mass
index</li>
</ul></li>
</ul>
</div>
<div id="assignment-procedures" class="section level2">
<h2>Assignment Procedures</h2>
<ul>
<li>Individuals are aware of the treatment they received, i.e., no blind
assignment</li>
<li>To mimic the randomized treatment assignment in RCTs, we restore
comparability between treatment groups within strata defined by baseline
covariates, and we refer to this as conditional exchangeability</li>
<li>To achieve conditional exchangeability, we need to adjust for all
confounding factors using methods in modern causal inference (see xx for
more etails)</li>
</ul>
</div>
<div id="outcome-identification-and-validation" class="section level2">
<h2>Outcome Identification and Validation</h2>
<ul>
<li>Outcomes are typically identified using ICD 9/10</li>
<li>It is challenging to conduct blind ascertainment for outcomes in
observational data since healthcare providers are often aware of the
treatment a patient received</li>
</ul>
</div>
<div id="time-zero" class="section level2">
<h2>Time Zero</h2>
<ul>
<li><span style="color:red">This is the most important component in
TTE</span></li>
<li>Time zero is the start of follow-up, also referred to as
baseline</li>
<li>In RCTs, the time of treatment randomization/initiation (A), the
time of meeting eligibility criteria (E), and the time of starting
following up participants (<span class="math inline">\(T_0\)</span>) are
often well-aligned, which provides key advantages including preventing
<strong>selection bias</strong> and <strong>immortal time
bias</strong></li>
<li>Check out the four classic failure modes in the figure below</li>
</ul>
<p>the TTE framework using the TrialEmulation R package. We will use a
simulated data set to illustrate how an analysis-ready data set for a
target trial emulation, for either itenton to treatment (ITT) or per
protocal(PP) analysis, is created under hood. Then we will demostrate
how to utilze the functions in the TrialEmulation R package to create
the analysis-ready data sets and analyze the data.</p>
<p>#Fist we will illustrate how to create an analysis-ready data set for
a target trial emulation using our own code. We developed a function
that can simulate a data set that similar to what we would get from a
real-world data source. The data set is a simulated cohort of patients
with a chronic disease, such as diabetes or hypertension, who are
followed over time. The data set includes baseline covariates, treatment
assignment, and outcomes of interest. For details of the simulated data
please refer to ????. The data set is used to illustrate how to create
an analysis-ready data set for a target trial emulation.</p>
<pre><code>#&gt; 
#&gt; Attaching package: &#39;dplyr&#39;
#&gt; The following objects are masked from &#39;package:stats&#39;:
#&gt; 
#&gt;     filter, lag
#&gt; The following objects are masked from &#39;package:base&#39;:
#&gt; 
#&gt;     intersect, setdiff, setequal, union
#&gt; Joining with `by = join_by(id)`</code></pre>
<p>Now we start to create a analysis-ready from the simulated data. We
will emulate a randomized clinic trial described below. Add a table here
to describe the trial design.</p>
<p>First, we create an eligible indicator. Our inclusion criteria are:
1)age &gt;=50, 2)no history of Y by current time, and 3)no treatment in
previous 2 years of current time</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>simdata <span class="ot">&lt;-</span> simdata <span class="sc">%&gt;%</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">eligible =</span> <span class="fu">as.integer</span>(age <span class="sc">&gt;=</span> <span class="dv">50</span> <span class="sc">&amp;</span> <span class="fu">cumsum</span>(Y) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> (<span class="fu">lag</span>(A)<span class="sc">+</span><span class="fu">lag</span>(A,<span class="dv">2</span>)) <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> <span class="co"># lag(A) gives the treatment status from one time point ago, lag(A, 2) is from two time points ago.</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code></pre></div>
<p>Let’s take a look on a sample.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>simdata<span class="sc">%&gt;%</span><span class="fu">filter</span>(id<span class="sc">==</span><span class="dv">2</span>)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="co">#&gt; # A tibble: 20 × 12</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co">#&gt;       id  time    X1      X2    X3    X4   age     A     Y     C age_s eligible</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;int&gt;</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co">#&gt;  1     2     0     1  0.177      1 0.654  43.7     1     0     0 0.722        0</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="co">#&gt;  2     2     1     1 -0.0711     1 0.654  44.7     1     0     0 0.805        0</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="co">#&gt;  3     2     2     0 -0.363      1 0.654  45.7     1     0     0 0.888        0</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="co">#&gt;  4     2     3     0 -1.27       1 0.654  46.7     1     0     0 0.972        0</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co">#&gt;  5     2     4     0  0.387      1 0.654  47.7     1     0     0 1.06         0</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="co">#&gt;  6     2     5     0 -1.96       1 0.654  48.7     1     0     0 1.14         0</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="co">#&gt;  7     2     6     1  1.20       1 0.654  49.7     1     0     0 1.22         0</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="co">#&gt;  8     2     7     0  0.960      1 0.654  50.7     1     0     0 1.31         0</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="co">#&gt;  9     2     8     0 -0.624      1 0.654  51.7     0     0     0 1.39         0</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a><span class="co">#&gt; 10     2     9     1  1.36       1 0.654  52.7     0     0     0 1.47         0</span></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a><span class="co">#&gt; 11     2    10     0 -0.893      1 0.654  53.7     0     0     0 1.56         1</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="co">#&gt; 12     2    11     1 -0.0871     1 0.654  54.7     0     0     0 1.64         1</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a><span class="co">#&gt; 13     2    12     0 -0.752      1 0.654  55.7     0     0     0 1.72         1</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="co">#&gt; 14     2    13     1 -0.142      1 0.654  56.7     1     0     0 1.81         1</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a><span class="co">#&gt; 15     2    14     1 -0.0428     1 0.654  57.7     1     0     0 1.89         0</span></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a><span class="co">#&gt; 16     2    15     0  0.965      1 0.654  58.7     1     0     0 1.97         0</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a><span class="co">#&gt; 17     2    16     0  0.887      1 0.654  59.7     1     0     0 2.06         0</span></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a><span class="co">#&gt; 18     2    17     1  0.0558     1 0.654  60.7     1     0     0 2.14         0</span></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a><span class="co">#&gt; 19     2    18     1  0.327      1 0.654  61.7     1     0     0 2.22         0</span></span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a><span class="co">#&gt; 20     2    19     0 -0.0961     1 0.654  62.7     0     0     0 2.31         0</span></span></code></pre></div>
<p>We can see that:<br />
At time 0 through 6, his age is below 50 and so e is not eligible for
the study. At time 7 through 9, his age is over 50 and he has no history
of Y but he has treatment within previous 2 years, so he is not
eligible. At time 10 through 13, his age is 50 and he has no history of
Y and no treatment in previous 2 years, so he is eligible. At time 14
and after, he has treatment in previous 2 years, so he is not eligible.
Now we identify the subjects who are eligible ever and the first time
they are eligible</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>eligible_info <span class="ot">&lt;-</span> simdata <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    <span class="co">#first_eligible_time = min(time[eligible == 1], na.rm = TRUE), ever_eligible = any(eligible == 1)</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    <span class="at">ever_eligible =</span> <span class="fu">any</span>(eligible <span class="sc">==</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>    <span class="at">first_eligible_time =</span> <span class="cf">if</span> (<span class="fu">any</span>(eligible <span class="sc">==</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="fu">min</span>(time[eligible <span class="sc">==</span> <span class="dv">1</span>]) <span class="cf">else</span> <span class="cn">NA_real_</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code></pre></div>
<p>How many ever eligible?</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">table</span>(eligible_info<span class="sc">$</span>ever_eligible)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co">#&gt; FALSE  TRUE </span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="co">#&gt;   744   256</span></span></code></pre></div>
<p>Check a few of them.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>eligible_info <span class="sc">%&gt;%</span> <span class="fu">filter</span>(id <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3 × 3</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co">#&gt;      id ever_eligible first_eligible_time</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;lgl&gt;                       &lt;dbl&gt;</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co">#&gt; 1     1 FALSE                          NA</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co">#&gt; 2     2 TRUE                           10</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="co">#&gt; 3     3 FALSE                          NA</span></span></code></pre></div>
<p>As we explained above, subject 2 is first eligible at time 10. And we
can also see that subject 1 and 3 are never eligible.</p>
<p>Now merge the information</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>simdata <span class="ot">&lt;-</span> simdata <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  <span class="fu">left_join</span>(eligible_info, <span class="at">by =</span> <span class="st">&quot;id&quot;</span>) </span></code></pre></div>
<p>now we are ready to do the analysis We will perform
intention-to-treatment (ITT) analysis and per-protocol (PP) analysis.
Explain ITT and PP here. #Case I: A new-user, active comparator design;
Intention-to-treat analysis</p>
<p>Subjects become eligible at multiple times. One option is just use
the first time they are eligible. Below we prepare the data for analysis
using this option. In this option, we start follow up from the first
eligible time Select the eligible subjects and keep rows at and after
first eligible time.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>simdata1 <span class="ot">&lt;-</span> simdata <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  <span class="fu">filter</span>(time <span class="sc">&gt;=</span> first_eligible_time) <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>ever_eligible)</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>simdata.one.trial <span class="ot">&lt;-</span> simdata1 <span class="sc">%&gt;%</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">follow_up =</span> time <span class="sc">-</span> first_eligible_time) <span class="sc">%&gt;%</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>first_eligible_time, <span class="sc">-</span>eligible) </span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>baseline<span class="ot">=</span>simdata.one.trial <span class="sc">%&gt;%</span><span class="fu">filter</span>(follow_up<span class="sc">==</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>  <span class="fu">select</span>(id, A, X1, X2, X3, X4, age) <span class="sc">%&gt;%</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">assigned_treatment =</span> A, <span class="at">X1_0 =</span> X1, <span class="at">X2_0 =</span> X2, <span class="at">X3_0 =</span> X3, <span class="at">X4_0 =</span> X4, <span class="at">age_0 =</span> age) </span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>simdata.one.trial<span class="ot">=</span>simdata.one.trial <span class="sc">%&gt;%</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>  <span class="fu">left_join</span>(baseline, <span class="at">by =</span> <span class="st">&quot;id&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>  <span class="fu">arrange</span>(id, follow_up)</span></code></pre></div>
<p>This data is ready for ITT analysis.</p>
<p>Another option is to use every time they are eligible
(reference).<br />
The function data_preparation() in the R package TrialEmulation can
handle this option. But in order to demonstrate what is done, we use our
own code to prepare the data step by step. To make it simple, we will
only enroll subjects at time 2,3 and 4. Trial 2</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>iligible2<span class="ot">=</span>simdata <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>  <span class="fu">filter</span>(eligible <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> time <span class="sc">==</span><span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>  <span class="fu">select</span>(id,A, X1, X2, X3,X4,age) <span class="sc">%&gt;%</span><span class="fu">rename</span>(<span class="at">assigned_treatment=</span>A, <span class="at">X1_0=</span>X1,<span class="at">X2_0=</span>X2, <span class="at">X3_0=</span>X3, <span class="at">X4_0=</span>X4, <span class="at">age_0=</span>age )<span class="sc">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trial =</span> <span class="dv">2</span>)</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>trial<span class="fl">.2</span><span class="ot">=</span>simdata <span class="sc">%&gt;%</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> iligible2<span class="sc">$</span>id <span class="sc">&amp;</span> time <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trial =</span> <span class="dv">2</span>, <span class="at">follow_up =</span> time <span class="sc">-</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>first_eligible_time, <span class="sc">-</span>eligible, <span class="sc">-</span>ever_eligible)<span class="sc">%&gt;%</span><span class="fu">left_join</span>(iligible2)</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(id, trial)`</span></span></code></pre></div>
<p>Trial 3</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>iligible3<span class="ot">=</span>simdata <span class="sc">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>  <span class="fu">filter</span>(eligible <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> time <span class="sc">==</span><span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>  <span class="fu">select</span>(id,A, X1, X2, X3,X4,age) <span class="sc">%&gt;%</span><span class="fu">rename</span>(<span class="at">assigned_treatment=</span>A, <span class="at">X1_0=</span>X1,<span class="at">X2_0=</span>X2, <span class="at">X3_0=</span>X3, <span class="at">X4_0=</span>X4, <span class="at">age_0=</span>age )<span class="sc">%&gt;%</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trial =</span> <span class="dv">3</span>)</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>trial<span class="fl">.3</span><span class="ot">=</span>simdata <span class="sc">%&gt;%</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> iligible3<span class="sc">$</span>id <span class="sc">&amp;</span> time <span class="sc">&gt;=</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trial =</span> <span class="dv">3</span>, <span class="at">follow_up =</span> time <span class="sc">-</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>first_eligible_time, <span class="sc">-</span>eligible, <span class="sc">-</span>ever_eligible)<span class="sc">%&gt;%</span><span class="fu">left_join</span>(iligible3)</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(id, trial)`</span></span></code></pre></div>
<p>Trial 4</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>iligible4<span class="ot">=</span>simdata <span class="sc">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>  <span class="fu">filter</span>(eligible <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> time <span class="sc">==</span><span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  <span class="fu">select</span>(id,A, X1, X2, X3,X4,age) <span class="sc">%&gt;%</span><span class="fu">rename</span>(<span class="at">assigned_treatment=</span>A, <span class="at">X1_0=</span>X1,<span class="at">X2_0=</span>X2, <span class="at">X3_0=</span>X3, <span class="at">X4_0=</span>X4, <span class="at">age_0=</span>age )<span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trial =</span> <span class="dv">4</span>)</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>trial<span class="fl">.4</span><span class="ot">=</span>simdata <span class="sc">%&gt;%</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> iligible4<span class="sc">$</span>id <span class="sc">&amp;</span> time <span class="sc">&gt;=</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trial =</span> <span class="dv">4</span>, <span class="at">follow_up =</span> time <span class="sc">-</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>first_eligible_time, <span class="sc">-</span>eligible, <span class="sc">-</span>ever_eligible)<span class="sc">%&gt;%</span><span class="fu">left_join</span>(iligible4)</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(id, trial)`</span></span></code></pre></div>
<p>Combine the trials together, we get a data set for ITT analysis of
sequential trials.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>simdata.all.trials <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(trial<span class="fl">.2</span>, trial<span class="fl">.3</span>, trial<span class="fl">.4</span>)</span></code></pre></div>
<p>Rename the variables to make it have the same variable names as the
data prepared by the package.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>simdata.all.trials<span class="ot">=</span>simdata.all.trials<span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>    <span class="at">trial_period =</span> trial,</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>    <span class="at">followup_time =</span> follow_up,</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>    <span class="at">treatment =</span> A,</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>    <span class="at">outcome =</span> Y,</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>    <span class="at">censoring =</span> C,</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>    <span class="at">age =</span> age</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>  )<span class="sc">%&gt;%</span><span class="fu">arrange</span>(trial_period,id,  followup_time)</span></code></pre></div>
<p>Now use the R package TrialEmulation to prepare the data for ITT
analysis.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>prep_ITT_data <span class="ot">&lt;-</span> <span class="fu">data_preparation</span>(</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>  <span class="at">data =</span> simdata,</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>  <span class="at">id =</span> <span class="st">&quot;id&quot;</span>, <span class="at">period =</span> <span class="st">&quot;time&quot;</span>, <span class="at">treatment =</span> <span class="st">&quot;A&quot;</span>,</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">&quot;Y&quot;</span>, <span class="at">eligible =</span> <span class="st">&quot;eligible&quot;</span>, <span class="co"># Exclude data before a patient becomes eligible</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>  <span class="at">estimand_type =</span> <span class="st">&quot;ITT&quot;</span>,</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>  <span class="at">outcome_cov =</span> <span class="sc">~</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3 <span class="sc">+</span> X4 <span class="sc">+</span> age,</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>  <span class="at">model_var =</span> <span class="st">&quot;assigned_treatment&quot;</span>,</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>  <span class="at">use_censor_weights =</span> F, </span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>  <span class="at">first_period =</span> <span class="dv">2</span>,</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>  <span class="at">last_period =</span> <span class="dv">4</span>,</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span>,<span class="at">control =</span> <span class="fu">list</span>(<span class="at">maxit =</span> <span class="dv">100</span>))</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>dt<span class="ot">=</span>prep_ITT_data<span class="sc">$</span>data</span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>dt<span class="ot">=</span><span class="fu">data.frame</span>(dt)</span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>dt<span class="ot">=</span>dt<span class="sc">%&gt;%</span><span class="fu">rename</span>(<span class="at">X1_0=</span>X1,<span class="at">X2_0=</span>X2, <span class="at">X3_0=</span>X3, <span class="at">X4_0=</span>X4, <span class="at">age_0=</span>age )<span class="sc">%&gt;%</span></span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>  <span class="fu">arrange</span>(trial_period,id,  followup_time)</span></code></pre></div>
<p>Below we compare the data sets prepared by the two ways.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">table</span>(dt<span class="sc">$</span>trial_period<span class="sc">==</span>simdata.all.trials<span class="sc">$</span>trial_period)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="co">#&gt; TRUE </span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co">#&gt; 1968</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="fu">table</span>(dt<span class="sc">$</span>id<span class="sc">==</span>simdata.all.trials<span class="sc">$</span>id)</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="co">#&gt; TRUE </span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="co">#&gt; 1968</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="fu">table</span>(dt<span class="sc">$</span>followup_time<span class="sc">==</span>simdata.all.trials<span class="sc">$</span>followup_time)</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="co">#&gt; TRUE </span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a><span class="co">#&gt; 1968</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a><span class="fu">table</span>(dt<span class="sc">$</span>treatment<span class="sc">==</span>simdata.all.trials<span class="sc">$</span>treatment)</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a><span class="co">#&gt; TRUE </span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a><span class="co">#&gt; 1968</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a><span class="fu">table</span>(dt<span class="sc">$</span>outcome<span class="sc">==</span>simdata.all.trials<span class="sc">$</span>outcome)</span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a><span class="co">#&gt; TRUE </span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a><span class="co">#&gt; 1968</span></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a><span class="fu">table</span>(dt<span class="sc">$</span>age_0<span class="sc">==</span>simdata.all.trials<span class="sc">$</span>age_0)</span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a><span class="co">#&gt; TRUE </span></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a><span class="co">#&gt; 1968</span></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a><span class="fu">table</span>(dt<span class="sc">$</span>X1_0<span class="sc">==</span>simdata.all.trials<span class="sc">$</span>X1_0)</span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a><span class="co">#&gt; TRUE </span></span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a><span class="co">#&gt; 1968</span></span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a><span class="fu">table</span>(dt<span class="sc">$</span>X2_0<span class="sc">==</span>simdata.all.trials<span class="sc">$</span>X2_0)</span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a><span class="co">#&gt; TRUE </span></span>
<span id="cb15-32"><a href="#cb15-32" tabindex="-1"></a><span class="co">#&gt; 1968</span></span>
<span id="cb15-33"><a href="#cb15-33" tabindex="-1"></a><span class="fu">table</span>(dt<span class="sc">$</span>X3_0<span class="sc">==</span>simdata.all.trials<span class="sc">$</span>X3_0)</span>
<span id="cb15-34"><a href="#cb15-34" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-35"><a href="#cb15-35" tabindex="-1"></a><span class="co">#&gt; TRUE </span></span>
<span id="cb15-36"><a href="#cb15-36" tabindex="-1"></a><span class="co">#&gt; 1968</span></span>
<span id="cb15-37"><a href="#cb15-37" tabindex="-1"></a><span class="fu">table</span>(dt<span class="sc">$</span>X4_0<span class="sc">==</span>simdata.all.trials<span class="sc">$</span>X4_0)</span>
<span id="cb15-38"><a href="#cb15-38" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-39"><a href="#cb15-39" tabindex="-1"></a><span class="co">#&gt; TRUE </span></span>
<span id="cb15-40"><a href="#cb15-40" tabindex="-1"></a><span class="co">#&gt; 1968</span></span></code></pre></div>
<p>We see that all are TRUE, so the two data sets are the same. Now we
can use the data for analysis.</p>
<p>With the simulated data ready, now we transfer the data to a form
ready for different analysis.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="co">#working_dir &lt;- getwd()</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>trial_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> working_dir, <span class="at">pattern =</span> <span class="st">&quot;^trial_.*</span><span class="sc">\\</span><span class="st">.csv$&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(trial_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>  <span class="fu">file.remove</span>(trial_files)</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>}</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>prep_ITT_data <span class="ot">&lt;-</span> <span class="fu">data_preparation</span>(</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>   <span class="at">data =</span> simdata,</span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>   <span class="at">id =</span> <span class="st">&quot;id&quot;</span>, <span class="at">period =</span> <span class="st">&quot;time&quot;</span>, <span class="at">treatment =</span> <span class="st">&quot;A&quot;</span>,</span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>   <span class="at">outcome =</span> <span class="st">&quot;Y&quot;</span>, <span class="at">eligible =</span> <span class="st">&quot;eligible&quot;</span>,</span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>   <span class="at">estimand_type =</span> <span class="st">&quot;ITT&quot;</span>,</span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>    <span class="at">outcome_cov =</span> <span class="sc">~</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3 <span class="sc">+</span> X4 <span class="sc">+</span> age_s,</span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>    <span class="at">model_var =</span> <span class="st">&quot;assigned_treatment&quot;</span>,</span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a>    <span class="at">use_censor_weights =</span> <span class="cn">TRUE</span>, <span class="at">cense =</span> <span class="st">&quot;C&quot;</span>,</span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a>    <span class="at">cense_d_cov =</span> <span class="sc">~</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3 <span class="sc">+</span> X4 <span class="sc">+</span> age_s,</span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a>    <span class="at">cense_n_cov =</span> <span class="sc">~</span> X3 <span class="sc">+</span> X4,</span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a>    <span class="at">pool_cense =</span> <span class="st">&quot;numerator&quot;</span>,</span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a>    <span class="at">data_dir =</span> working_dir, <span class="at">save_weight_models =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>    <span class="at">glm_function =</span> <span class="st">&quot;parglm&quot;</span>, <span class="at">nthreads =</span> <span class="dv">4</span>, <span class="at">method =</span> <span class="st">&quot;FAST&quot;</span>,</span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>    <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>Let’s take a look on the data generated.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>dt<span class="ot">=</span>prep_ITT_data<span class="sc">$</span>data</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>dt<span class="sc">%&gt;%</span><span class="fu">filter</span>(id<span class="sc">==</span><span class="dv">2</span>)</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="co">#&gt;        id trial_period followup_time outcome    weight treatment    X1</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="co">#&gt;     &lt;num&gt;        &lt;int&gt;         &lt;num&gt;   &lt;num&gt;     &lt;num&gt;     &lt;num&gt; &lt;num&gt;</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="co">#&gt;  1:     2           10             0       0 1.0000000         0     0</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="co">#&gt;  2:     2           10             1       0 1.0176793         0     0</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="co">#&gt;  3:     2           11             0       0 1.0000000         0     1</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a><span class="co">#&gt;  4:     2           10             2       0 1.0162402         0     0</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a><span class="co">#&gt;  5:     2           11             1       0 0.9985859         0     1</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a><span class="co">#&gt;  6:     2           12             0       0 1.0000000         0     0</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a><span class="co">#&gt;  7:     2           10             3       0 1.0267496         1     0</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a><span class="co">#&gt;  8:     2           11             2       0 1.0089127         1     1</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a><span class="co">#&gt;  9:     2           12             1       0 1.0103415         1     0</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a><span class="co">#&gt; 10:     2           13             0       0 1.0000000         1     1</span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a><span class="co">#&gt; 11:     2           10             4       0 1.0106446         1     0</span></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a><span class="co">#&gt; 12:     2           11             3       0 0.9930875         1     1</span></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a><span class="co">#&gt; 13:     2           12             2       0 0.9944939         1     0</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a><span class="co">#&gt; 14:     2           13             1       0 0.9843146         1     1</span></span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a><span class="co">#&gt; 15:     2           10             5       0 1.0169210         1     0</span></span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a><span class="co">#&gt; 16:     2           11             4       0 0.9992548         1     1</span></span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a><span class="co">#&gt; 17:     2           12             3       0 1.0006699         1     0</span></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a><span class="co">#&gt; 18:     2           13             2       0 0.9904275         1     1</span></span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a><span class="co">#&gt; 19:     2           10             6       0 1.0212999         1     0</span></span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a><span class="co">#&gt; 20:     2           11             5       0 1.0035576         1     1</span></span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a><span class="co">#&gt; 21:     2           12             4       0 1.0049788         1     0</span></span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a><span class="co">#&gt; 22:     2           13             3       0 0.9946922         1     1</span></span>
<span id="cb17-27"><a href="#cb17-27" tabindex="-1"></a><span class="co">#&gt; 23:     2           10             7       0 1.0062038         1     0</span></span>
<span id="cb17-28"><a href="#cb17-28" tabindex="-1"></a><span class="co">#&gt; 24:     2           11             6       0 0.9887238         1     1</span></span>
<span id="cb17-29"><a href="#cb17-29" tabindex="-1"></a><span class="co">#&gt; 25:     2           12             5       0 0.9901240         1     0</span></span>
<span id="cb17-30"><a href="#cb17-30" tabindex="-1"></a><span class="co">#&gt; 26:     2           13             4       0 0.9799895         1     1</span></span>
<span id="cb17-31"><a href="#cb17-31" tabindex="-1"></a><span class="co">#&gt; 27:     2           10             8       0 0.9938688         1     0</span></span>
<span id="cb17-32"><a href="#cb17-32" tabindex="-1"></a><span class="co">#&gt; 28:     2           11             7       0 0.9766031         1     1</span></span>
<span id="cb17-33"><a href="#cb17-33" tabindex="-1"></a><span class="co">#&gt; 29:     2           12             6       0 0.9779861         1     0</span></span>
<span id="cb17-34"><a href="#cb17-34" tabindex="-1"></a><span class="co">#&gt; 30:     2           13             5       0 0.9679758         1     1</span></span>
<span id="cb17-35"><a href="#cb17-35" tabindex="-1"></a><span class="co">#&gt; 31:     2           10             9       0 0.9818354         0     0</span></span>
<span id="cb17-36"><a href="#cb17-36" tabindex="-1"></a><span class="co">#&gt; 32:     2           11             8       0 0.9647787         0     1</span></span>
<span id="cb17-37"><a href="#cb17-37" tabindex="-1"></a><span class="co">#&gt; 33:     2           12             7       0 0.9661450         0     0</span></span>
<span id="cb17-38"><a href="#cb17-38" tabindex="-1"></a><span class="co">#&gt; 34:     2           13             6       0 0.9562559         0     1</span></span>
<span id="cb17-39"><a href="#cb17-39" tabindex="-1"></a><span class="co">#&gt;        id trial_period followup_time outcome    weight treatment    X1</span></span>
<span id="cb17-40"><a href="#cb17-40" tabindex="-1"></a><span class="co">#&gt;              X2    X3        X4    age_s assigned_treatment</span></span>
<span id="cb17-41"><a href="#cb17-41" tabindex="-1"></a><span class="co">#&gt;           &lt;num&gt; &lt;num&gt;     &lt;num&gt;    &lt;num&gt;              &lt;num&gt;</span></span>
<span id="cb17-42"><a href="#cb17-42" tabindex="-1"></a><span class="co">#&gt;  1: -0.89312929     1 0.6537974 1.555100                  0</span></span>
<span id="cb17-43"><a href="#cb17-43" tabindex="-1"></a><span class="co">#&gt;  2: -0.89312929     1 0.6537974 1.555100                  0</span></span>
<span id="cb17-44"><a href="#cb17-44" tabindex="-1"></a><span class="co">#&gt;  3: -0.08714471     1 0.6537974 1.638433                  0</span></span>
<span id="cb17-45"><a href="#cb17-45" tabindex="-1"></a><span class="co">#&gt;  4: -0.89312929     1 0.6537974 1.555100                  0</span></span>
<span id="cb17-46"><a href="#cb17-46" tabindex="-1"></a><span class="co">#&gt;  5: -0.08714471     1 0.6537974 1.638433                  0</span></span>
<span id="cb17-47"><a href="#cb17-47" tabindex="-1"></a><span class="co">#&gt;  6: -0.75152942     1 0.6537974 1.721767                  0</span></span>
<span id="cb17-48"><a href="#cb17-48" tabindex="-1"></a><span class="co">#&gt;  7: -0.89312929     1 0.6537974 1.555100                  0</span></span>
<span id="cb17-49"><a href="#cb17-49" tabindex="-1"></a><span class="co">#&gt;  8: -0.08714471     1 0.6537974 1.638433                  0</span></span>
<span id="cb17-50"><a href="#cb17-50" tabindex="-1"></a><span class="co">#&gt;  9: -0.75152942     1 0.6537974 1.721767                  0</span></span>
<span id="cb17-51"><a href="#cb17-51" tabindex="-1"></a><span class="co">#&gt; 10: -0.14188387     1 0.6537974 1.805100                  1</span></span>
<span id="cb17-52"><a href="#cb17-52" tabindex="-1"></a><span class="co">#&gt; 11: -0.89312929     1 0.6537974 1.555100                  0</span></span>
<span id="cb17-53"><a href="#cb17-53" tabindex="-1"></a><span class="co">#&gt; 12: -0.08714471     1 0.6537974 1.638433                  0</span></span>
<span id="cb17-54"><a href="#cb17-54" tabindex="-1"></a><span class="co">#&gt; 13: -0.75152942     1 0.6537974 1.721767                  0</span></span>
<span id="cb17-55"><a href="#cb17-55" tabindex="-1"></a><span class="co">#&gt; 14: -0.14188387     1 0.6537974 1.805100                  1</span></span>
<span id="cb17-56"><a href="#cb17-56" tabindex="-1"></a><span class="co">#&gt; 15: -0.89312929     1 0.6537974 1.555100                  0</span></span>
<span id="cb17-57"><a href="#cb17-57" tabindex="-1"></a><span class="co">#&gt; 16: -0.08714471     1 0.6537974 1.638433                  0</span></span>
<span id="cb17-58"><a href="#cb17-58" tabindex="-1"></a><span class="co">#&gt; 17: -0.75152942     1 0.6537974 1.721767                  0</span></span>
<span id="cb17-59"><a href="#cb17-59" tabindex="-1"></a><span class="co">#&gt; 18: -0.14188387     1 0.6537974 1.805100                  1</span></span>
<span id="cb17-60"><a href="#cb17-60" tabindex="-1"></a><span class="co">#&gt; 19: -0.89312929     1 0.6537974 1.555100                  0</span></span>
<span id="cb17-61"><a href="#cb17-61" tabindex="-1"></a><span class="co">#&gt; 20: -0.08714471     1 0.6537974 1.638433                  0</span></span>
<span id="cb17-62"><a href="#cb17-62" tabindex="-1"></a><span class="co">#&gt; 21: -0.75152942     1 0.6537974 1.721767                  0</span></span>
<span id="cb17-63"><a href="#cb17-63" tabindex="-1"></a><span class="co">#&gt; 22: -0.14188387     1 0.6537974 1.805100                  1</span></span>
<span id="cb17-64"><a href="#cb17-64" tabindex="-1"></a><span class="co">#&gt; 23: -0.89312929     1 0.6537974 1.555100                  0</span></span>
<span id="cb17-65"><a href="#cb17-65" tabindex="-1"></a><span class="co">#&gt; 24: -0.08714471     1 0.6537974 1.638433                  0</span></span>
<span id="cb17-66"><a href="#cb17-66" tabindex="-1"></a><span class="co">#&gt; 25: -0.75152942     1 0.6537974 1.721767                  0</span></span>
<span id="cb17-67"><a href="#cb17-67" tabindex="-1"></a><span class="co">#&gt; 26: -0.14188387     1 0.6537974 1.805100                  1</span></span>
<span id="cb17-68"><a href="#cb17-68" tabindex="-1"></a><span class="co">#&gt; 27: -0.89312929     1 0.6537974 1.555100                  0</span></span>
<span id="cb17-69"><a href="#cb17-69" tabindex="-1"></a><span class="co">#&gt; 28: -0.08714471     1 0.6537974 1.638433                  0</span></span>
<span id="cb17-70"><a href="#cb17-70" tabindex="-1"></a><span class="co">#&gt; 29: -0.75152942     1 0.6537974 1.721767                  0</span></span>
<span id="cb17-71"><a href="#cb17-71" tabindex="-1"></a><span class="co">#&gt; 30: -0.14188387     1 0.6537974 1.805100                  1</span></span>
<span id="cb17-72"><a href="#cb17-72" tabindex="-1"></a><span class="co">#&gt; 31: -0.89312929     1 0.6537974 1.555100                  0</span></span>
<span id="cb17-73"><a href="#cb17-73" tabindex="-1"></a><span class="co">#&gt; 32: -0.08714471     1 0.6537974 1.638433                  0</span></span>
<span id="cb17-74"><a href="#cb17-74" tabindex="-1"></a><span class="co">#&gt; 33: -0.75152942     1 0.6537974 1.721767                  0</span></span>
<span id="cb17-75"><a href="#cb17-75" tabindex="-1"></a><span class="co">#&gt; 34: -0.14188387     1 0.6537974 1.805100                  1</span></span>
<span id="cb17-76"><a href="#cb17-76" tabindex="-1"></a><span class="co">#&gt;              X2    X3        X4    age_s assigned_treatment</span></span></code></pre></div>
<p>Besides the expended data for a sequence of trials, a censoring
weight is also created. Let’s check how the weighting models were
fitted</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>model_cens_pool_n<span class="ot">=</span>prep_ITT_data<span class="sc">$</span>censor_models<span class="sc">$</span>cens_pool_n <span class="co"># Pooled numerator model for censoring</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="co"># Denominator models for different treatment arms:</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>model_cens_d0<span class="ot">=</span>prep_ITT_data<span class="sc">$</span>censor_models<span class="sc">$</span>cens_d0</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>model_cens_d1<span class="ot">=</span>prep_ITT_data<span class="sc">$</span>censor_models<span class="sc">$</span>cens_d1</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>simdata.one.trial<span class="ot">=</span>simdata.one.trial<span class="sc">%&gt;%</span><span class="fu">mutate</span>(<span class="at">C_neg=</span><span class="dv">1</span><span class="sc">-</span>C) <span class="co"># Not censored???</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>fit.pooled.n<span class="ot">=</span><span class="fu">glm</span>(C_neg<span class="sc">~</span>X3<span class="sc">+</span>X4, <span class="at">data=</span>simdata.one.trial, <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>)</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>fit.pooled.n</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="co">#&gt; Call:  glm(formula = C_neg ~ X3 + X4, family = &quot;binomial&quot;, data = simdata.one.trial)</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a><span class="co">#&gt; (Intercept)           X3           X4  </span></span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a><span class="co">#&gt;      2.9294       0.8817       0.1011  </span></span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a><span class="co">#&gt; Degrees of Freedom: 1303 Total (i.e. Null);  1301 Residual</span></span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a><span class="co">#&gt; Null Deviance:       404.7 </span></span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a><span class="co">#&gt; Residual Deviance: 395.9     AIC: 401.9</span></span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a>model_cens_pool_n</span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a><span class="co">#&gt; Model for P(cense = 0 | X) for numerator </span></span>
<span id="cb18-20"><a href="#cb18-20" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-21"><a href="#cb18-21" tabindex="-1"></a><span class="co">#&gt;         term   estimate std.error  statistic      p.value</span></span>
<span id="cb18-22"><a href="#cb18-22" tabindex="-1"></a><span class="co">#&gt;  (Intercept) 3.05305745 0.1602432 19.0526486 6.246056e-81</span></span>
<span id="cb18-23"><a href="#cb18-23" tabindex="-1"></a><span class="co">#&gt;           X3 0.66464029 0.2481119  2.6787921 7.388826e-03</span></span>
<span id="cb18-24"><a href="#cb18-24" tabindex="-1"></a><span class="co">#&gt;           X4 0.04470987 0.1376415  0.3248285 7.453109e-01</span></span>
<span id="cb18-25"><a href="#cb18-25" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-26"><a href="#cb18-26" tabindex="-1"></a><span class="co">#&gt;  null.deviance df.null    logLik      AIC      BIC deviance df.residual nobs</span></span>
<span id="cb18-27"><a href="#cb18-27" tabindex="-1"></a><span class="co">#&gt;       641.5864    2114 -317.0269 640.0539 657.0243 634.0539        2112 2115</span></span>
<span id="cb18-28"><a href="#cb18-28" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-29"><a href="#cb18-29" tabindex="-1"></a><span class="co">#&gt; Object saved at &quot;C:/Users/u6067002/Documents/GitHub/TargetTrialEmulation/cense_model_pool_n.rds&quot;</span></span>
<span id="cb18-30"><a href="#cb18-30" tabindex="-1"></a><span class="co">#fit.pooled.n and model_cens_pool_n are the same</span></span>
<span id="cb18-31"><a href="#cb18-31" tabindex="-1"></a></span>
<span id="cb18-32"><a href="#cb18-32" tabindex="-1"></a>simdata.one.trial<span class="ot">=</span>simdata.one.trial<span class="sc">%&gt;%</span><span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span><span class="fu">mutate</span>(<span class="at">prev_A=</span><span class="fu">lag</span>(A, <span class="at">default=</span><span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb18-33"><a href="#cb18-33" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb18-34"><a href="#cb18-34" tabindex="-1"></a>fit.d0<span class="ot">=</span><span class="fu">glm</span>(C_neg<span class="sc">~</span>X1<span class="sc">+</span>X2<span class="sc">+</span>X3<span class="sc">+</span>X4<span class="sc">+</span>age_s, <span class="at">data=</span>simdata.one.trial<span class="sc">%&gt;%</span><span class="fu">filter</span>(prev_A<span class="sc">==</span><span class="dv">0</span>), <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>)</span>
<span id="cb18-35"><a href="#cb18-35" tabindex="-1"></a>fit.d0</span>
<span id="cb18-36"><a href="#cb18-36" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-37"><a href="#cb18-37" tabindex="-1"></a><span class="co">#&gt; Call:  glm(formula = C_neg ~ X1 + X2 + X3 + X4 + age_s, family = &quot;binomial&quot;, </span></span>
<span id="cb18-38"><a href="#cb18-38" tabindex="-1"></a><span class="co">#&gt;     data = simdata.one.trial %&gt;% filter(prev_A == 0))</span></span>
<span id="cb18-39"><a href="#cb18-39" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-40"><a href="#cb18-40" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb18-41"><a href="#cb18-41" tabindex="-1"></a><span class="co">#&gt; (Intercept)           X1           X2           X3           X4        age_s  </span></span>
<span id="cb18-42"><a href="#cb18-42" tabindex="-1"></a><span class="co">#&gt;    -0.21469      0.03464     -0.58506      0.96645     -0.10064      1.75554  </span></span>
<span id="cb18-43"><a href="#cb18-43" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-44"><a href="#cb18-44" tabindex="-1"></a><span class="co">#&gt; Degrees of Freedom: 1029 Total (i.e. Null);  1024 Residual</span></span>
<span id="cb18-45"><a href="#cb18-45" tabindex="-1"></a><span class="co">#&gt; Null Deviance:       369.8 </span></span>
<span id="cb18-46"><a href="#cb18-46" tabindex="-1"></a><span class="co">#&gt; Residual Deviance: 336.2     AIC: 348.2</span></span>
<span id="cb18-47"><a href="#cb18-47" tabindex="-1"></a>model_cens_d0</span>
<span id="cb18-48"><a href="#cb18-48" tabindex="-1"></a><span class="co">#&gt; Model for P(cense = 0 | X, previous treatment = 0) for denominator </span></span>
<span id="cb18-49"><a href="#cb18-49" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-50"><a href="#cb18-50" tabindex="-1"></a><span class="co">#&gt;         term   estimate std.error  statistic      p.value</span></span>
<span id="cb18-51"><a href="#cb18-51" tabindex="-1"></a><span class="co">#&gt;  (Intercept)  0.9830203 0.5698213  1.7251379 0.0845026219</span></span>
<span id="cb18-52"><a href="#cb18-52" tabindex="-1"></a><span class="co">#&gt;           X1 -0.2617175 0.2509620 -1.0428571 0.2970144944</span></span>
<span id="cb18-53"><a href="#cb18-53" tabindex="-1"></a><span class="co">#&gt;           X2 -0.4263993 0.1225076 -3.4805945 0.0005003024</span></span>
<span id="cb18-54"><a href="#cb18-54" tabindex="-1"></a><span class="co">#&gt;           X3  0.7786120 0.2612698  2.9801073 0.0028814743</span></span>
<span id="cb18-55"><a href="#cb18-55" tabindex="-1"></a><span class="co">#&gt;           X4 -0.1270487 0.1499747 -0.8471342 0.3969203099</span></span>
<span id="cb18-56"><a href="#cb18-56" tabindex="-1"></a><span class="co">#&gt;        age_s  1.0519619 0.2813613  3.7388296 0.0001848790</span></span>
<span id="cb18-57"><a href="#cb18-57" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-58"><a href="#cb18-58" tabindex="-1"></a><span class="co">#&gt;  null.deviance df.null    logLik      AIC      BIC deviance df.residual nobs</span></span>
<span id="cb18-59"><a href="#cb18-59" tabindex="-1"></a><span class="co">#&gt;        576.936    1694 -269.8079 551.6157 584.2283 539.6157        1689 1695</span></span>
<span id="cb18-60"><a href="#cb18-60" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-61"><a href="#cb18-61" tabindex="-1"></a><span class="co">#&gt; Object saved at &quot;C:/Users/u6067002/Documents/GitHub/TargetTrialEmulation/cense_model_d0.rds&quot;</span></span>
<span id="cb18-62"><a href="#cb18-62" tabindex="-1"></a>fit.d1<span class="ot">=</span><span class="fu">glm</span>(C_neg<span class="sc">~</span>X1<span class="sc">+</span>X2<span class="sc">+</span>X3<span class="sc">+</span>X4<span class="sc">+</span>age_s, <span class="at">data=</span>simdata.one.trial<span class="sc">%&gt;%</span><span class="fu">filter</span>(prev_A<span class="sc">==</span><span class="dv">1</span>), <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>)</span>
<span id="cb18-63"><a href="#cb18-63" tabindex="-1"></a>fit.d1</span>
<span id="cb18-64"><a href="#cb18-64" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-65"><a href="#cb18-65" tabindex="-1"></a><span class="co">#&gt; Call:  glm(formula = C_neg ~ X1 + X2 + X3 + X4 + age_s, family = &quot;binomial&quot;, </span></span>
<span id="cb18-66"><a href="#cb18-66" tabindex="-1"></a><span class="co">#&gt;     data = simdata.one.trial %&gt;% filter(prev_A == 1))</span></span>
<span id="cb18-67"><a href="#cb18-67" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-68"><a href="#cb18-68" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb18-69"><a href="#cb18-69" tabindex="-1"></a><span class="co">#&gt; (Intercept)           X1           X2           X3           X4        age_s  </span></span>
<span id="cb18-70"><a href="#cb18-70" tabindex="-1"></a><span class="co">#&gt;     14.6025      -1.2486      -1.6220       0.6833      -2.6035      -3.8944  </span></span>
<span id="cb18-71"><a href="#cb18-71" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-72"><a href="#cb18-72" tabindex="-1"></a><span class="co">#&gt; Degrees of Freedom: 273 Total (i.e. Null);  268 Residual</span></span>
<span id="cb18-73"><a href="#cb18-73" tabindex="-1"></a><span class="co">#&gt; Null Deviance:       23.67 </span></span>
<span id="cb18-74"><a href="#cb18-74" tabindex="-1"></a><span class="co">#&gt; Residual Deviance: 16.28     AIC: 28.28</span></span>
<span id="cb18-75"><a href="#cb18-75" tabindex="-1"></a>model_cens_d1</span>
<span id="cb18-76"><a href="#cb18-76" tabindex="-1"></a><span class="co">#&gt; Model for P(cense = 0 | X, previous treatment = 1) for denominator </span></span>
<span id="cb18-77"><a href="#cb18-77" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-78"><a href="#cb18-78" tabindex="-1"></a><span class="co">#&gt;         term    estimate std.error  statistic    p.value</span></span>
<span id="cb18-79"><a href="#cb18-79" tabindex="-1"></a><span class="co">#&gt;  (Intercept)  4.50610399 2.2298951  2.0207695 0.04330363</span></span>
<span id="cb18-80"><a href="#cb18-80" tabindex="-1"></a><span class="co">#&gt;           X1  0.41072076 1.1365006  0.3613907 0.71780738</span></span>
<span id="cb18-81"><a href="#cb18-81" tabindex="-1"></a><span class="co">#&gt;           X2 -0.95450267 0.4330389 -2.2041964 0.02751054</span></span>
<span id="cb18-82"><a href="#cb18-82" tabindex="-1"></a><span class="co">#&gt;           X3  0.45101634 0.9469993  0.4762584 0.63389032</span></span>
<span id="cb18-83"><a href="#cb18-83" tabindex="-1"></a><span class="co">#&gt;           X4 -0.54503329 0.7207519 -0.7562009 0.44952872</span></span>
<span id="cb18-84"><a href="#cb18-84" tabindex="-1"></a><span class="co">#&gt;        age_s -0.08691101 0.9748786 -0.0891506 0.92896223</span></span>
<span id="cb18-85"><a href="#cb18-85" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-86"><a href="#cb18-86" tabindex="-1"></a><span class="co">#&gt;  null.deviance df.null    logLik      AIC      BIC deviance df.residual nobs</span></span>
<span id="cb18-87"><a href="#cb18-87" tabindex="-1"></a><span class="co">#&gt;       54.24841     419 -24.18373 60.36745 84.60898 48.36745         414  420</span></span>
<span id="cb18-88"><a href="#cb18-88" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-89"><a href="#cb18-89" tabindex="-1"></a><span class="co">#&gt; Object saved at &quot;C:/Users/u6067002/Documents/GitHub/TargetTrialEmulation/cense_model_d1.rds&quot;</span></span></code></pre></div>
<p>So we can see the way that the weighting models are fitted is the
same as what we did above. The data is ready for the analysis. We can
fit a marginal structure model (MSM).</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;splines&quot;</span>)</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>ITT_result <span class="ot">&lt;-</span> <span class="fu">trial_msm</span>(prep_ITT_data<span class="sc">$</span>data,</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a> <span class="at">estimand_type =</span> <span class="st">&quot;ITT&quot;</span>,</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a> <span class="at">outcome_cov =</span> <span class="sc">~</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3 <span class="sc">+</span> X4 <span class="sc">+</span> age_s,</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a> <span class="at">model_var =</span> <span class="st">&quot;assigned_treatment&quot;</span>,</span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a> <span class="at">include_followup_time =</span> <span class="sc">~</span> <span class="fu">ns</span>(followup_time, <span class="at">df =</span> <span class="dv">3</span>),</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a> <span class="at">glm_function =</span> <span class="st">&quot;glm&quot;</span>,</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a> <span class="at">use_sample_weights =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a> <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>ITT_result </span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a><span class="co">#&gt; $model</span></span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a><span class="co">#&gt; Call:  glm(formula = outcome ~ assigned_treatment + trial_period + I(trial_period^2) + </span></span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a><span class="co">#&gt;     ns(followup_time, df = 3) + X1 + X2 + X3 + X4 + age_s, family = binomial(link = &quot;logit&quot;), </span></span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a><span class="co">#&gt;     data = data, weights = w)</span></span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a><span class="co">#&gt;                (Intercept)          assigned_treatment  </span></span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a><span class="co">#&gt;                  -6.346145                    0.030656  </span></span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a><span class="co">#&gt;               trial_period           I(trial_period^2)  </span></span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a><span class="co">#&gt;                   0.062685                   -0.002606  </span></span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)1  ns(followup_time, df = 3)2  </span></span>
<span id="cb19-23"><a href="#cb19-23" tabindex="-1"></a><span class="co">#&gt;                   0.856825                    3.721347  </span></span>
<span id="cb19-24"><a href="#cb19-24" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)3                          X1  </span></span>
<span id="cb19-25"><a href="#cb19-25" tabindex="-1"></a><span class="co">#&gt;                   1.988815                   -0.157997  </span></span>
<span id="cb19-26"><a href="#cb19-26" tabindex="-1"></a><span class="co">#&gt;                         X2                          X3  </span></span>
<span id="cb19-27"><a href="#cb19-27" tabindex="-1"></a><span class="co">#&gt;                  -0.044053                    0.760817  </span></span>
<span id="cb19-28"><a href="#cb19-28" tabindex="-1"></a><span class="co">#&gt;                         X4                       age_s  </span></span>
<span id="cb19-29"><a href="#cb19-29" tabindex="-1"></a><span class="co">#&gt;                   0.799449                    0.623210  </span></span>
<span id="cb19-30"><a href="#cb19-30" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-31"><a href="#cb19-31" tabindex="-1"></a><span class="co">#&gt; Degrees of Freedom: 9949 Total (i.e. Null);  9938 Residual</span></span>
<span id="cb19-32"><a href="#cb19-32" tabindex="-1"></a><span class="co">#&gt; Null Deviance:       2628 </span></span>
<span id="cb19-33"><a href="#cb19-33" tabindex="-1"></a><span class="co">#&gt; Residual Deviance: 2407  AIC: 2510</span></span>
<span id="cb19-34"><a href="#cb19-34" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-35"><a href="#cb19-35" tabindex="-1"></a><span class="co">#&gt; $robust</span></span>
<span id="cb19-36"><a href="#cb19-36" tabindex="-1"></a><span class="co">#&gt; $summary</span></span>
<span id="cb19-37"><a href="#cb19-37" tabindex="-1"></a><span class="co">#&gt;                         names     estimate   robust_se        2.5%        97.5%</span></span>
<span id="cb19-38"><a href="#cb19-38" tabindex="-1"></a><span class="co">#&gt; 1                 (Intercept) -6.346145453 0.733749894 -7.78429525 -4.907995661</span></span>
<span id="cb19-39"><a href="#cb19-39" tabindex="-1"></a><span class="co">#&gt; 2          assigned_treatment  0.030655665 0.141339555 -0.24636986  0.307681192</span></span>
<span id="cb19-40"><a href="#cb19-40" tabindex="-1"></a><span class="co">#&gt; 3                trial_period  0.062685450 0.075150972 -0.08461045  0.209981354</span></span>
<span id="cb19-41"><a href="#cb19-41" tabindex="-1"></a><span class="co">#&gt; 4           I(trial_period^2) -0.002605629 0.004151788 -0.01074313  0.005531876</span></span>
<span id="cb19-42"><a href="#cb19-42" tabindex="-1"></a><span class="co">#&gt; 5  ns(followup_time, df = 3)1  0.856825167 0.405972343  0.06111937  1.652530960</span></span>
<span id="cb19-43"><a href="#cb19-43" tabindex="-1"></a><span class="co">#&gt; 6  ns(followup_time, df = 3)2  3.721346701 0.648861377  2.44957840  4.993114999</span></span>
<span id="cb19-44"><a href="#cb19-44" tabindex="-1"></a><span class="co">#&gt; 7  ns(followup_time, df = 3)3  1.988814861 0.695920183  0.62481130  3.352818419</span></span>
<span id="cb19-45"><a href="#cb19-45" tabindex="-1"></a><span class="co">#&gt; 8                          X1 -0.157996523 0.127969201 -0.40881616  0.092823111</span></span>
<span id="cb19-46"><a href="#cb19-46" tabindex="-1"></a><span class="co">#&gt; 9                          X2 -0.044053185 0.064233063 -0.16994999  0.081843619</span></span>
<span id="cb19-47"><a href="#cb19-47" tabindex="-1"></a><span class="co">#&gt; 10                         X3  0.760816719 0.319712255  0.13418070  1.387452739</span></span>
<span id="cb19-48"><a href="#cb19-48" tabindex="-1"></a><span class="co">#&gt; 11                         X4  0.799448606 0.172309216  0.46172254  1.137174670</span></span>
<span id="cb19-49"><a href="#cb19-49" tabindex="-1"></a><span class="co">#&gt; 12                      age_s  0.623209715 0.230098220  0.17221720  1.074202226</span></span>
<span id="cb19-50"><a href="#cb19-50" tabindex="-1"></a><span class="co">#&gt;             z      p_value</span></span>
<span id="cb19-51"><a href="#cb19-51" tabindex="-1"></a><span class="co">#&gt; 1  -8.6489218 0.000000e+00</span></span>
<span id="cb19-52"><a href="#cb19-52" tabindex="-1"></a><span class="co">#&gt; 2   0.2168937 8.282912e-01</span></span>
<span id="cb19-53"><a href="#cb19-53" tabindex="-1"></a><span class="co">#&gt; 3   0.8341269 4.042095e-01</span></span>
<span id="cb19-54"><a href="#cb19-54" tabindex="-1"></a><span class="co">#&gt; 4  -0.6275920 5.302712e-01</span></span>
<span id="cb19-55"><a href="#cb19-55" tabindex="-1"></a><span class="co">#&gt; 5   2.1105506 3.481096e-02</span></span>
<span id="cb19-56"><a href="#cb19-56" tabindex="-1"></a><span class="co">#&gt; 6   5.7351953 9.740006e-09</span></span>
<span id="cb19-57"><a href="#cb19-57" tabindex="-1"></a><span class="co">#&gt; 7   2.8578204 4.265618e-03</span></span>
<span id="cb19-58"><a href="#cb19-58" tabindex="-1"></a><span class="co">#&gt; 8  -1.2346449 2.169627e-01</span></span>
<span id="cb19-59"><a href="#cb19-59" tabindex="-1"></a><span class="co">#&gt; 9  -0.6858335 4.928181e-01</span></span>
<span id="cb19-60"><a href="#cb19-60" tabindex="-1"></a><span class="co">#&gt; 10  2.3796921 1.732711e-02</span></span>
<span id="cb19-61"><a href="#cb19-61" tabindex="-1"></a><span class="co">#&gt; 11  4.6396161 3.490571e-06</span></span>
<span id="cb19-62"><a href="#cb19-62" tabindex="-1"></a><span class="co">#&gt; 12  2.7084508 6.759813e-03</span></span>
<span id="cb19-63"><a href="#cb19-63" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-64"><a href="#cb19-64" tabindex="-1"></a><span class="co">#&gt; $matrix</span></span>
<span id="cb19-65"><a href="#cb19-65" tabindex="-1"></a><span class="co">#&gt;                              (Intercept) assigned_treatment  trial_period</span></span>
<span id="cb19-66"><a href="#cb19-66" tabindex="-1"></a><span class="co">#&gt; (Intercept)                 0.5383889071      -1.890811e-02 -0.0288565832</span></span>
<span id="cb19-67"><a href="#cb19-67" tabindex="-1"></a><span class="co">#&gt; assigned_treatment         -0.0189081126       1.997687e-02  0.0007746221</span></span>
<span id="cb19-68"><a href="#cb19-68" tabindex="-1"></a><span class="co">#&gt; trial_period               -0.0288565832       7.746221e-04  0.0056476685</span></span>
<span id="cb19-69"><a href="#cb19-69" tabindex="-1"></a><span class="co">#&gt; I(trial_period^2)           0.0008684435      -3.226787e-06 -0.0002669462</span></span>
<span id="cb19-70"><a href="#cb19-70" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)1 -0.0767226733       8.962942e-04 -0.0018032151</span></span>
<span id="cb19-71"><a href="#cb19-71" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)2 -0.3126695877       6.820982e-03  0.0111608658</span></span>
<span id="cb19-72"><a href="#cb19-72" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)3 -0.3530244097       1.305781e-02  0.0192808022</span></span>
<span id="cb19-73"><a href="#cb19-73" tabindex="-1"></a><span class="co">#&gt; X1                          0.0206019426      -4.192509e-03 -0.0008613511</span></span>
<span id="cb19-74"><a href="#cb19-74" tabindex="-1"></a><span class="co">#&gt; X2                         -0.0011505886      -2.583488e-03 -0.0010725905</span></span>
<span id="cb19-75"><a href="#cb19-75" tabindex="-1"></a><span class="co">#&gt; X3                         -0.1105007548       3.844742e-03  0.0022318831</span></span>
<span id="cb19-76"><a href="#cb19-76" tabindex="-1"></a><span class="co">#&gt; X4                         -0.0182830172      -3.809964e-03  0.0002360861</span></span>
<span id="cb19-77"><a href="#cb19-77" tabindex="-1"></a><span class="co">#&gt; age_s                      -0.1066948200       7.871538e-04  0.0010452233</span></span>
<span id="cb19-78"><a href="#cb19-78" tabindex="-1"></a><span class="co">#&gt;                            I(trial_period^2) ns(followup_time, df = 3)1</span></span>
<span id="cb19-79"><a href="#cb19-79" tabindex="-1"></a><span class="co">#&gt; (Intercept)                     8.684435e-04              -7.672267e-02</span></span>
<span id="cb19-80"><a href="#cb19-80" tabindex="-1"></a><span class="co">#&gt; assigned_treatment             -3.226787e-06               8.962942e-04</span></span>
<span id="cb19-81"><a href="#cb19-81" tabindex="-1"></a><span class="co">#&gt; trial_period                   -2.669462e-04              -1.803215e-03</span></span>
<span id="cb19-82"><a href="#cb19-82" tabindex="-1"></a><span class="co">#&gt; I(trial_period^2)               1.723734e-05               5.785192e-04</span></span>
<span id="cb19-83"><a href="#cb19-83" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)1      5.785192e-04               1.648135e-01</span></span>
<span id="cb19-84"><a href="#cb19-84" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)2      5.289010e-04               9.870248e-02</span></span>
<span id="cb19-85"><a href="#cb19-85" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)3      9.562196e-05               7.742255e-02</span></span>
<span id="cb19-86"><a href="#cb19-86" tabindex="-1"></a><span class="co">#&gt; X1                              2.724990e-05              -8.680265e-03</span></span>
<span id="cb19-87"><a href="#cb19-87" tabindex="-1"></a><span class="co">#&gt; X2                              7.367637e-05               2.860359e-03</span></span>
<span id="cb19-88"><a href="#cb19-88" tabindex="-1"></a><span class="co">#&gt; X3                             -6.531043e-05               1.080325e-02</span></span>
<span id="cb19-89"><a href="#cb19-89" tabindex="-1"></a><span class="co">#&gt; X4                             -3.627771e-05              -4.452530e-03</span></span>
<span id="cb19-90"><a href="#cb19-90" tabindex="-1"></a><span class="co">#&gt; age_s                          -1.809510e-04               6.129207e-05</span></span>
<span id="cb19-91"><a href="#cb19-91" tabindex="-1"></a><span class="co">#&gt;                            ns(followup_time, df = 3)2</span></span>
<span id="cb19-92"><a href="#cb19-92" tabindex="-1"></a><span class="co">#&gt; (Intercept)                              -0.312669588</span></span>
<span id="cb19-93"><a href="#cb19-93" tabindex="-1"></a><span class="co">#&gt; assigned_treatment                        0.006820982</span></span>
<span id="cb19-94"><a href="#cb19-94" tabindex="-1"></a><span class="co">#&gt; trial_period                              0.011160866</span></span>
<span id="cb19-95"><a href="#cb19-95" tabindex="-1"></a><span class="co">#&gt; I(trial_period^2)                         0.000528901</span></span>
<span id="cb19-96"><a href="#cb19-96" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)1                0.098702484</span></span>
<span id="cb19-97"><a href="#cb19-97" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)2                0.421021086</span></span>
<span id="cb19-98"><a href="#cb19-98" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)3                0.395995057</span></span>
<span id="cb19-99"><a href="#cb19-99" tabindex="-1"></a><span class="co">#&gt; X1                                       -0.005834417</span></span>
<span id="cb19-100"><a href="#cb19-100" tabindex="-1"></a><span class="co">#&gt; X2                                        0.007927693</span></span>
<span id="cb19-101"><a href="#cb19-101" tabindex="-1"></a><span class="co">#&gt; X3                                        0.031622334</span></span>
<span id="cb19-102"><a href="#cb19-102" tabindex="-1"></a><span class="co">#&gt; X4                                        0.009626920</span></span>
<span id="cb19-103"><a href="#cb19-103" tabindex="-1"></a><span class="co">#&gt; age_s                                     0.019509801</span></span>
<span id="cb19-104"><a href="#cb19-104" tabindex="-1"></a><span class="co">#&gt;                            ns(followup_time, df = 3)3            X1</span></span>
<span id="cb19-105"><a href="#cb19-105" tabindex="-1"></a><span class="co">#&gt; (Intercept)                             -3.530244e-01  0.0206019426</span></span>
<span id="cb19-106"><a href="#cb19-106" tabindex="-1"></a><span class="co">#&gt; assigned_treatment                       1.305781e-02 -0.0041925094</span></span>
<span id="cb19-107"><a href="#cb19-107" tabindex="-1"></a><span class="co">#&gt; trial_period                             1.928080e-02 -0.0008613511</span></span>
<span id="cb19-108"><a href="#cb19-108" tabindex="-1"></a><span class="co">#&gt; I(trial_period^2)                        9.562196e-05  0.0000272499</span></span>
<span id="cb19-109"><a href="#cb19-109" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)1               7.742255e-02 -0.0086802651</span></span>
<span id="cb19-110"><a href="#cb19-110" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)2               3.959951e-01 -0.0058344174</span></span>
<span id="cb19-111"><a href="#cb19-111" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)3               4.843049e-01 -0.0042411473</span></span>
<span id="cb19-112"><a href="#cb19-112" tabindex="-1"></a><span class="co">#&gt; X1                                      -4.241147e-03  0.0163761163</span></span>
<span id="cb19-113"><a href="#cb19-113" tabindex="-1"></a><span class="co">#&gt; X2                                       3.893169e-03  0.0009731016</span></span>
<span id="cb19-114"><a href="#cb19-114" tabindex="-1"></a><span class="co">#&gt; X3                                       5.210958e-02 -0.0071605991</span></span>
<span id="cb19-115"><a href="#cb19-115" tabindex="-1"></a><span class="co">#&gt; X4                                       1.521944e-02 -0.0012955336</span></span>
<span id="cb19-116"><a href="#cb19-116" tabindex="-1"></a><span class="co">#&gt; age_s                                    2.792210e-02 -0.0068528834</span></span>
<span id="cb19-117"><a href="#cb19-117" tabindex="-1"></a><span class="co">#&gt;                                       X2            X3            X4</span></span>
<span id="cb19-118"><a href="#cb19-118" tabindex="-1"></a><span class="co">#&gt; (Intercept)                -1.150589e-03 -1.105008e-01 -1.828302e-02</span></span>
<span id="cb19-119"><a href="#cb19-119" tabindex="-1"></a><span class="co">#&gt; assigned_treatment         -2.583488e-03  3.844742e-03 -3.809964e-03</span></span>
<span id="cb19-120"><a href="#cb19-120" tabindex="-1"></a><span class="co">#&gt; trial_period               -1.072590e-03  2.231883e-03  2.360861e-04</span></span>
<span id="cb19-121"><a href="#cb19-121" tabindex="-1"></a><span class="co">#&gt; I(trial_period^2)           7.367637e-05 -6.531043e-05 -3.627771e-05</span></span>
<span id="cb19-122"><a href="#cb19-122" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)1  2.860359e-03  1.080325e-02 -4.452530e-03</span></span>
<span id="cb19-123"><a href="#cb19-123" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)2  7.927693e-03  3.162233e-02  9.626920e-03</span></span>
<span id="cb19-124"><a href="#cb19-124" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)3  3.893169e-03  5.210958e-02  1.521944e-02</span></span>
<span id="cb19-125"><a href="#cb19-125" tabindex="-1"></a><span class="co">#&gt; X1                          9.731016e-04 -7.160599e-03 -1.295534e-03</span></span>
<span id="cb19-126"><a href="#cb19-126" tabindex="-1"></a><span class="co">#&gt; X2                          4.125886e-03 -5.554336e-04 -9.125443e-04</span></span>
<span id="cb19-127"><a href="#cb19-127" tabindex="-1"></a><span class="co">#&gt; X3                         -5.554336e-04  1.022159e-01  8.198964e-03</span></span>
<span id="cb19-128"><a href="#cb19-128" tabindex="-1"></a><span class="co">#&gt; X4                         -9.125443e-04  8.198964e-03  2.969047e-02</span></span>
<span id="cb19-129"><a href="#cb19-129" tabindex="-1"></a><span class="co">#&gt; age_s                       7.155068e-04  1.483641e-02  8.969019e-03</span></span>
<span id="cb19-130"><a href="#cb19-130" tabindex="-1"></a><span class="co">#&gt;                                    age_s</span></span>
<span id="cb19-131"><a href="#cb19-131" tabindex="-1"></a><span class="co">#&gt; (Intercept)                -1.066948e-01</span></span>
<span id="cb19-132"><a href="#cb19-132" tabindex="-1"></a><span class="co">#&gt; assigned_treatment          7.871538e-04</span></span>
<span id="cb19-133"><a href="#cb19-133" tabindex="-1"></a><span class="co">#&gt; trial_period                1.045223e-03</span></span>
<span id="cb19-134"><a href="#cb19-134" tabindex="-1"></a><span class="co">#&gt; I(trial_period^2)          -1.809510e-04</span></span>
<span id="cb19-135"><a href="#cb19-135" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)1  6.129207e-05</span></span>
<span id="cb19-136"><a href="#cb19-136" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)2  1.950980e-02</span></span>
<span id="cb19-137"><a href="#cb19-137" tabindex="-1"></a><span class="co">#&gt; ns(followup_time, df = 3)3  2.792210e-02</span></span>
<span id="cb19-138"><a href="#cb19-138" tabindex="-1"></a><span class="co">#&gt; X1                         -6.852883e-03</span></span>
<span id="cb19-139"><a href="#cb19-139" tabindex="-1"></a><span class="co">#&gt; X2                          7.155068e-04</span></span>
<span id="cb19-140"><a href="#cb19-140" tabindex="-1"></a><span class="co">#&gt; X3                          1.483641e-02</span></span>
<span id="cb19-141"><a href="#cb19-141" tabindex="-1"></a><span class="co">#&gt; X4                          8.969019e-03</span></span>
<span id="cb19-142"><a href="#cb19-142" tabindex="-1"></a><span class="co">#&gt; age_s                       5.294519e-02</span></span>
<span id="cb19-143"><a href="#cb19-143" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-144"><a href="#cb19-144" tabindex="-1"></a><span class="co">#&gt; attr(,&quot;class&quot;)</span></span>
<span id="cb19-145"><a href="#cb19-145" tabindex="-1"></a><span class="co">#&gt; [1] &quot;TE_robust&quot;</span></span>
<span id="cb19-146"><a href="#cb19-146" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-147"><a href="#cb19-147" tabindex="-1"></a><span class="co">#&gt; $args</span></span>
<span id="cb19-148"><a href="#cb19-148" tabindex="-1"></a><span class="co">#&gt; $args$outcome_cov</span></span>
<span id="cb19-149"><a href="#cb19-149" tabindex="-1"></a><span class="co">#&gt; ~X1 + X2 + X3 + X4 + age_s</span></span>
<span id="cb19-150"><a href="#cb19-150" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-151"><a href="#cb19-151" tabindex="-1"></a><span class="co">#&gt; $args$estimand_type</span></span>
<span id="cb19-152"><a href="#cb19-152" tabindex="-1"></a><span class="co">#&gt; [1] &quot;ITT&quot;</span></span>
<span id="cb19-153"><a href="#cb19-153" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-154"><a href="#cb19-154" tabindex="-1"></a><span class="co">#&gt; $args$model_var</span></span>
<span id="cb19-155"><a href="#cb19-155" tabindex="-1"></a><span class="co">#&gt; ~assigned_treatment</span></span>
<span id="cb19-156"><a href="#cb19-156" tabindex="-1"></a><span class="co">#&gt; &lt;environment: 0x0000013984b0fbd8&gt;</span></span>
<span id="cb19-157"><a href="#cb19-157" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-158"><a href="#cb19-158" tabindex="-1"></a><span class="co">#&gt; $args$first_followup</span></span>
<span id="cb19-159"><a href="#cb19-159" tabindex="-1"></a><span class="co">#&gt; [1] NA</span></span>
<span id="cb19-160"><a href="#cb19-160" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-161"><a href="#cb19-161" tabindex="-1"></a><span class="co">#&gt; $args$last_followup</span></span>
<span id="cb19-162"><a href="#cb19-162" tabindex="-1"></a><span class="co">#&gt; [1] NA</span></span>
<span id="cb19-163"><a href="#cb19-163" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-164"><a href="#cb19-164" tabindex="-1"></a><span class="co">#&gt; $args$analysis_weights</span></span>
<span id="cb19-165"><a href="#cb19-165" tabindex="-1"></a><span class="co">#&gt; [1] &quot;asis&quot;</span></span>
<span id="cb19-166"><a href="#cb19-166" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-167"><a href="#cb19-167" tabindex="-1"></a><span class="co">#&gt; $args$weight_limits</span></span>
<span id="cb19-168"><a href="#cb19-168" tabindex="-1"></a><span class="co">#&gt; [1]   0 Inf</span></span>
<span id="cb19-169"><a href="#cb19-169" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-170"><a href="#cb19-170" tabindex="-1"></a><span class="co">#&gt; $args$include_followup_time</span></span>
<span id="cb19-171"><a href="#cb19-171" tabindex="-1"></a><span class="co">#&gt; ~ns(followup_time, df = 3)</span></span>
<span id="cb19-172"><a href="#cb19-172" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-173"><a href="#cb19-173" tabindex="-1"></a><span class="co">#&gt; $args$include_trial_period</span></span>
<span id="cb19-174"><a href="#cb19-174" tabindex="-1"></a><span class="co">#&gt; ~trial_period + I(trial_period^2)</span></span>
<span id="cb19-175"><a href="#cb19-175" tabindex="-1"></a><span class="co">#&gt; &lt;environment: 0x0000013984b4d400&gt;</span></span>
<span id="cb19-176"><a href="#cb19-176" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-177"><a href="#cb19-177" tabindex="-1"></a><span class="co">#&gt; $args$where_case</span></span>
<span id="cb19-178"><a href="#cb19-178" tabindex="-1"></a><span class="co">#&gt; [1] NA</span></span>
<span id="cb19-179"><a href="#cb19-179" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-180"><a href="#cb19-180" tabindex="-1"></a><span class="co">#&gt; $args$glm_function</span></span>
<span id="cb19-181"><a href="#cb19-181" tabindex="-1"></a><span class="co">#&gt; [1] &quot;glm&quot;</span></span>
<span id="cb19-182"><a href="#cb19-182" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-183"><a href="#cb19-183" tabindex="-1"></a><span class="co">#&gt; $args$use_sample_weights</span></span>
<span id="cb19-184"><a href="#cb19-184" tabindex="-1"></a><span class="co">#&gt; [1] FALSE</span></span>
<span id="cb19-185"><a href="#cb19-185" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-186"><a href="#cb19-186" tabindex="-1"></a><span class="co">#&gt; $args$model_formula</span></span>
<span id="cb19-187"><a href="#cb19-187" tabindex="-1"></a><span class="co">#&gt; outcome ~ assigned_treatment + trial_period + I(trial_period^2) + </span></span>
<span id="cb19-188"><a href="#cb19-188" tabindex="-1"></a><span class="co">#&gt;     ns(followup_time, df = 3) + X1 + X2 + X3 + X4 + age_s</span></span>
<span id="cb19-189"><a href="#cb19-189" tabindex="-1"></a><span class="co">#&gt; &lt;environment: 0x0000013984b4d400&gt;</span></span>
<span id="cb19-190"><a href="#cb19-190" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-191"><a href="#cb19-191" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-192"><a href="#cb19-192" tabindex="-1"></a><span class="co">#&gt; attr(,&quot;class&quot;)</span></span>
<span id="cb19-193"><a href="#cb19-193" tabindex="-1"></a><span class="co">#&gt; [1] &quot;TE_msm&quot;</span></span></code></pre></div>
</div>
</div>
<div id="case-ii-a-new-user-active-comparator-design-per-protocol-analysis" class="section level1">
<h1>Case II: A new-user, active comparator design; Per-protocol
analysis</h1>
<p>Explain PP here. For per-protocol analysis, we need to prepare a data
in the person-time long format. Each subject has multiple rows and each
row should include the following variables: id patient identifier month
time period treatment indicator for receiving treatment in this period,
1=treatment, 0=non-treatment time-varying variables relating to
treatment and the outcome time-invariant variables relating to treatment
and the outcome event indicator LTFU censoring indicator Below we will
illustrate how to create the data set for per-protocol analysis using
some variables from the observed data we simulated.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co"># Prepare data for per-protocol analysis by adjusting for treatment switching and censoring</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="co"># Fit models for both treatment switching (numerator and denominator) and censoring (numerator and denominator).</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>prep_PP_data <span class="ot">&lt;-</span> <span class="fu">data_preparation</span>(</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a> <span class="at">data =</span> simdata,</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a> <span class="at">id =</span> <span class="st">&quot;id&quot;</span>, <span class="at">period =</span> <span class="st">&quot;time&quot;</span>, <span class="at">treatment =</span> <span class="st">&quot;A&quot;</span>,</span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a> <span class="at">outcome =</span> <span class="st">&quot;Y&quot;</span>, <span class="at">eligible =</span> <span class="st">&quot;eligible&quot;</span>,</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a> <span class="at">estimand_type =</span> <span class="st">&quot;PP&quot;</span>,</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a> <span class="at">outcome_cov =</span> <span class="sc">~</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3 <span class="sc">+</span> X4 <span class="sc">+</span> age_s,</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a> <span class="at">model_var =</span> <span class="st">&quot;assigned_treatment&quot;</span>,</span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a> <span class="at">switch_d_cov =</span> <span class="sc">~</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3 <span class="sc">+</span> X4 <span class="sc">+</span> age_s</span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a> <span class="sc">+</span> time_on_regime <span class="sc">+</span> <span class="fu">I</span>(time_on_regime<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a> <span class="at">switch_n_cov =</span> <span class="sc">~</span> X3 <span class="sc">+</span> X4 <span class="sc">+</span> time_on_regime <span class="sc">+</span> <span class="fu">I</span>(time_on_regime<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a> <span class="at">use_censor_weights =</span> <span class="cn">TRUE</span>, <span class="at">cense =</span> <span class="st">&quot;C&quot;</span>,</span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a> <span class="at">cense_d_cov =</span> <span class="sc">~</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3 <span class="sc">+</span> X4 <span class="sc">+</span> age_s,</span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a> <span class="at">cense_n_cov =</span> <span class="sc">~</span> X3 <span class="sc">+</span> X4,</span>
<span id="cb20-16"><a href="#cb20-16" tabindex="-1"></a> <span class="at">pool_cense =</span> <span class="st">&quot;numerator&quot;</span>,,</span>
<span id="cb20-17"><a href="#cb20-17" tabindex="-1"></a> <span class="at">data_dir =</span> working_dir, <span class="at">save_weight_models =</span> <span class="cn">TRUE</span>,</span>
<span id="cb20-18"><a href="#cb20-18" tabindex="-1"></a> <span class="at">chunk_size =</span> <span class="dv">500</span>, <span class="at">separate_files =</span> <span class="cn">TRUE</span>,</span>
<span id="cb20-19"><a href="#cb20-19" tabindex="-1"></a> <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-20"><a href="#cb20-20" tabindex="-1"></a>adh.model.d0<span class="ot">=</span>prep_PP_data<span class="sc">$</span>switch_models<span class="sc">$</span>switch_d0</span>
<span id="cb20-21"><a href="#cb20-21" tabindex="-1"></a>adh.model.d1<span class="ot">=</span>prep_PP_data<span class="sc">$</span>switch_models<span class="sc">$</span>switch_d1</span>
<span id="cb20-22"><a href="#cb20-22" tabindex="-1"></a>adh.model.n0<span class="ot">=</span>prep_PP_data<span class="sc">$</span>switch_models<span class="sc">$</span>switch_n0</span>
<span id="cb20-23"><a href="#cb20-23" tabindex="-1"></a>adh.model.n1<span class="ot">=</span>prep_PP_data<span class="sc">$</span>switch_models<span class="sc">$</span>switch_n1</span>
<span id="cb20-24"><a href="#cb20-24" tabindex="-1"></a>cens.model.d0<span class="ot">=</span>prep_PP_data<span class="sc">$</span>censor_models<span class="sc">$</span>cens_d0</span>
<span id="cb20-25"><a href="#cb20-25" tabindex="-1"></a>cens.model.d1<span class="ot">=</span>prep_PP_data<span class="sc">$</span>censor_models<span class="sc">$</span>cens_d1</span>
<span id="cb20-26"><a href="#cb20-26" tabindex="-1"></a>cens.model.n<span class="ot">=</span>prep_PP_data<span class="sc">$</span>censor_models<span class="sc">$</span>cens_pool_n</span></code></pre></div>
<p>Check how these models are fitted</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co">#model.pp.cens.n=readRDS(&quot;/Users/kevinying/TTEvignette/cense_model_d0.rds&quot;)</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>model.pp.cens.n<span class="ot">=</span><span class="fu">readRDS</span>(<span class="fu">file.path</span>(working_dir, <span class="st">&quot;cense_model_pool_n.rds&quot;</span>))</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>dt.pp.cens.n<span class="ot">=</span>model.pp.cens.n<span class="sc">$</span>data</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>check.cens.n<span class="ot">=</span>simdata.one.trial<span class="sc">%&gt;%</span><span class="fu">left_join</span>(dt.pp.cens.n<span class="sc">%&gt;%</span><span class="fu">mutate</span>(<span class="at">flag=</span><span class="dv">1</span>,<span class="at">time=</span>period)<span class="sc">%&gt;%</span><span class="fu">select</span>(id,time,flag))</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(id, time)`</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>check.cens.n<span class="sc">%&gt;%</span><span class="fu">filter</span>(id<span class="sc">==</span><span class="dv">6</span>)</span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a><span class="co">#&gt; # A tibble: 8 × 21</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a><span class="co">#&gt;      id  time    X1      X2    X3     X4   age     A     Y     C age_s follow_up</span></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a><span class="co">#&gt; 1     6     3     1  1.54       1 -0.321  50.7     0     0     0  1.31         0</span></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a><span class="co">#&gt; 2     6     4     0  0.160      1 -0.321  51.7     1     0     0  1.39         1</span></span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a><span class="co">#&gt; 3     6     5     0  0.0264     1 -0.321  52.7     0     0     0  1.47         2</span></span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a><span class="co">#&gt; 4     6     6     0  0.0621     1 -0.321  53.7     1     0     0  1.56         3</span></span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a><span class="co">#&gt; 5     6     7     0 -0.0225     1 -0.321  54.7     0     0     0  1.64         4</span></span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a><span class="co">#&gt; 6     6     8     1 -1.45       1 -0.321  55.7     0     0     0  1.72         5</span></span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a><span class="co">#&gt; 7     6     9     1 -0.959      1 -0.321  56.7     0     0     0  1.81         6</span></span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a><span class="co">#&gt; 8     6    10     1  1.42       1 -0.321  57.7     0     1     0  1.89         7</span></span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a><span class="co">#&gt; # ℹ 9 more variables: assigned_treatment &lt;dbl&gt;, X1_0 &lt;dbl&gt;, X2_0 &lt;dbl&gt;,</span></span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a><span class="co">#&gt; #   X3_0 &lt;dbl&gt;, X4_0 &lt;dbl&gt;, age_0 &lt;dbl&gt;, C_neg &lt;dbl&gt;, prev_A &lt;dbl&gt;, flag &lt;dbl&gt;</span></span>
<span id="cb21-20"><a href="#cb21-20" tabindex="-1"></a>simdata<span class="sc">%&gt;%</span><span class="fu">filter</span>(id<span class="sc">==</span><span class="dv">6</span>)</span>
<span id="cb21-21"><a href="#cb21-21" tabindex="-1"></a><span class="co">#&gt; # A tibble: 11 × 14</span></span>
<span id="cb21-22"><a href="#cb21-22" tabindex="-1"></a><span class="co">#&gt;       id  time    X1      X2    X3     X4   age     A     Y     C age_s eligible</span></span>
<span id="cb21-23"><a href="#cb21-23" tabindex="-1"></a><span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;int&gt;</span></span>
<span id="cb21-24"><a href="#cb21-24" tabindex="-1"></a><span class="co">#&gt;  1     6     0     1  1.01       1 -0.321  47.7     0     0     0  1.06        0</span></span>
<span id="cb21-25"><a href="#cb21-25" tabindex="-1"></a><span class="co">#&gt;  2     6     1     1 -1.99       1 -0.321  48.7     0     0     0  1.14        0</span></span>
<span id="cb21-26"><a href="#cb21-26" tabindex="-1"></a><span class="co">#&gt;  3     6     2     1 -0.517      1 -0.321  49.7     0     0     0  1.22        0</span></span>
<span id="cb21-27"><a href="#cb21-27" tabindex="-1"></a><span class="co">#&gt;  4     6     3     1  1.54       1 -0.321  50.7     0     0     0  1.31        1</span></span>
<span id="cb21-28"><a href="#cb21-28" tabindex="-1"></a><span class="co">#&gt;  5     6     4     0  0.160      1 -0.321  51.7     1     0     0  1.39        1</span></span>
<span id="cb21-29"><a href="#cb21-29" tabindex="-1"></a><span class="co">#&gt;  6     6     5     0  0.0264     1 -0.321  52.7     0     0     0  1.47        0</span></span>
<span id="cb21-30"><a href="#cb21-30" tabindex="-1"></a><span class="co">#&gt;  7     6     6     0  0.0621     1 -0.321  53.7     1     0     0  1.56        0</span></span>
<span id="cb21-31"><a href="#cb21-31" tabindex="-1"></a><span class="co">#&gt;  8     6     7     0 -0.0225     1 -0.321  54.7     0     0     0  1.64        0</span></span>
<span id="cb21-32"><a href="#cb21-32" tabindex="-1"></a><span class="co">#&gt;  9     6     8     1 -1.45       1 -0.321  55.7     0     0     0  1.72        0</span></span>
<span id="cb21-33"><a href="#cb21-33" tabindex="-1"></a><span class="co">#&gt; 10     6     9     1 -0.959      1 -0.321  56.7     0     0     0  1.81        1</span></span>
<span id="cb21-34"><a href="#cb21-34" tabindex="-1"></a><span class="co">#&gt; 11     6    10     1  1.42       1 -0.321  57.7     0     1     0  1.89        0</span></span>
<span id="cb21-35"><a href="#cb21-35" tabindex="-1"></a><span class="co">#&gt; # ℹ 2 more variables: ever_eligible &lt;lgl&gt;, first_eligible_time &lt;dbl&gt;</span></span>
<span id="cb21-36"><a href="#cb21-36" tabindex="-1"></a></span>
<span id="cb21-37"><a href="#cb21-37" tabindex="-1"></a><span class="co">#model.pp.cens.d0=readRDS(&quot;/Users/kevinying/TTEvignette/cense_model_d0.rds&quot;)</span></span>
<span id="cb21-38"><a href="#cb21-38" tabindex="-1"></a>model.pp.cens.d0<span class="ot">=</span><span class="fu">readRDS</span>(<span class="fu">file.path</span>(working_dir, <span class="st">&quot;cense_model_d0.rds&quot;</span>))</span>
<span id="cb21-39"><a href="#cb21-39" tabindex="-1"></a>dt.pp.cens.d0<span class="ot">=</span>model.pp.cens.d0<span class="sc">$</span>data</span>
<span id="cb21-40"><a href="#cb21-40" tabindex="-1"></a>check.cens.d0<span class="ot">=</span>simdata.one.trial<span class="sc">%&gt;%</span><span class="fu">left_join</span>(dt.pp.cens.d0<span class="sc">%&gt;%</span><span class="fu">mutate</span>(<span class="at">flag=</span><span class="dv">1</span>,<span class="at">time=</span>period)<span class="sc">%&gt;%</span><span class="fu">select</span>(id,time,flag))</span>
<span id="cb21-41"><a href="#cb21-41" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(id, time)`</span></span>
<span id="cb21-42"><a href="#cb21-42" tabindex="-1"></a>check.cens.d0<span class="sc">%&gt;%</span><span class="fu">filter</span>(id<span class="sc">==</span><span class="dv">6</span>)</span>
<span id="cb21-43"><a href="#cb21-43" tabindex="-1"></a><span class="co">#&gt; # A tibble: 8 × 21</span></span>
<span id="cb21-44"><a href="#cb21-44" tabindex="-1"></a><span class="co">#&gt;      id  time    X1      X2    X3     X4   age     A     Y     C age_s follow_up</span></span>
<span id="cb21-45"><a href="#cb21-45" tabindex="-1"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb21-46"><a href="#cb21-46" tabindex="-1"></a><span class="co">#&gt; 1     6     3     1  1.54       1 -0.321  50.7     0     0     0  1.31         0</span></span>
<span id="cb21-47"><a href="#cb21-47" tabindex="-1"></a><span class="co">#&gt; 2     6     4     0  0.160      1 -0.321  51.7     1     0     0  1.39         1</span></span>
<span id="cb21-48"><a href="#cb21-48" tabindex="-1"></a><span class="co">#&gt; 3     6     5     0  0.0264     1 -0.321  52.7     0     0     0  1.47         2</span></span>
<span id="cb21-49"><a href="#cb21-49" tabindex="-1"></a><span class="co">#&gt; 4     6     6     0  0.0621     1 -0.321  53.7     1     0     0  1.56         3</span></span>
<span id="cb21-50"><a href="#cb21-50" tabindex="-1"></a><span class="co">#&gt; 5     6     7     0 -0.0225     1 -0.321  54.7     0     0     0  1.64         4</span></span>
<span id="cb21-51"><a href="#cb21-51" tabindex="-1"></a><span class="co">#&gt; 6     6     8     1 -1.45       1 -0.321  55.7     0     0     0  1.72         5</span></span>
<span id="cb21-52"><a href="#cb21-52" tabindex="-1"></a><span class="co">#&gt; 7     6     9     1 -0.959      1 -0.321  56.7     0     0     0  1.81         6</span></span>
<span id="cb21-53"><a href="#cb21-53" tabindex="-1"></a><span class="co">#&gt; 8     6    10     1  1.42       1 -0.321  57.7     0     1     0  1.89         7</span></span>
<span id="cb21-54"><a href="#cb21-54" tabindex="-1"></a><span class="co">#&gt; # ℹ 9 more variables: assigned_treatment &lt;dbl&gt;, X1_0 &lt;dbl&gt;, X2_0 &lt;dbl&gt;,</span></span>
<span id="cb21-55"><a href="#cb21-55" tabindex="-1"></a><span class="co">#&gt; #   X3_0 &lt;dbl&gt;, X4_0 &lt;dbl&gt;, age_0 &lt;dbl&gt;, C_neg &lt;dbl&gt;, prev_A &lt;dbl&gt;, flag &lt;dbl&gt;</span></span>
<span id="cb21-56"><a href="#cb21-56" tabindex="-1"></a>simdata<span class="sc">%&gt;%</span><span class="fu">filter</span>(id<span class="sc">==</span><span class="dv">6</span>)</span>
<span id="cb21-57"><a href="#cb21-57" tabindex="-1"></a><span class="co">#&gt; # A tibble: 11 × 14</span></span>
<span id="cb21-58"><a href="#cb21-58" tabindex="-1"></a><span class="co">#&gt;       id  time    X1      X2    X3     X4   age     A     Y     C age_s eligible</span></span>
<span id="cb21-59"><a href="#cb21-59" tabindex="-1"></a><span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;int&gt;</span></span>
<span id="cb21-60"><a href="#cb21-60" tabindex="-1"></a><span class="co">#&gt;  1     6     0     1  1.01       1 -0.321  47.7     0     0     0  1.06        0</span></span>
<span id="cb21-61"><a href="#cb21-61" tabindex="-1"></a><span class="co">#&gt;  2     6     1     1 -1.99       1 -0.321  48.7     0     0     0  1.14        0</span></span>
<span id="cb21-62"><a href="#cb21-62" tabindex="-1"></a><span class="co">#&gt;  3     6     2     1 -0.517      1 -0.321  49.7     0     0     0  1.22        0</span></span>
<span id="cb21-63"><a href="#cb21-63" tabindex="-1"></a><span class="co">#&gt;  4     6     3     1  1.54       1 -0.321  50.7     0     0     0  1.31        1</span></span>
<span id="cb21-64"><a href="#cb21-64" tabindex="-1"></a><span class="co">#&gt;  5     6     4     0  0.160      1 -0.321  51.7     1     0     0  1.39        1</span></span>
<span id="cb21-65"><a href="#cb21-65" tabindex="-1"></a><span class="co">#&gt;  6     6     5     0  0.0264     1 -0.321  52.7     0     0     0  1.47        0</span></span>
<span id="cb21-66"><a href="#cb21-66" tabindex="-1"></a><span class="co">#&gt;  7     6     6     0  0.0621     1 -0.321  53.7     1     0     0  1.56        0</span></span>
<span id="cb21-67"><a href="#cb21-67" tabindex="-1"></a><span class="co">#&gt;  8     6     7     0 -0.0225     1 -0.321  54.7     0     0     0  1.64        0</span></span>
<span id="cb21-68"><a href="#cb21-68" tabindex="-1"></a><span class="co">#&gt;  9     6     8     1 -1.45       1 -0.321  55.7     0     0     0  1.72        0</span></span>
<span id="cb21-69"><a href="#cb21-69" tabindex="-1"></a><span class="co">#&gt; 10     6     9     1 -0.959      1 -0.321  56.7     0     0     0  1.81        1</span></span>
<span id="cb21-70"><a href="#cb21-70" tabindex="-1"></a><span class="co">#&gt; 11     6    10     1  1.42       1 -0.321  57.7     0     1     0  1.89        0</span></span>
<span id="cb21-71"><a href="#cb21-71" tabindex="-1"></a><span class="co">#&gt; # ℹ 2 more variables: ever_eligible &lt;lgl&gt;, first_eligible_time &lt;dbl&gt;</span></span>
<span id="cb21-72"><a href="#cb21-72" tabindex="-1"></a></span>
<span id="cb21-73"><a href="#cb21-73" tabindex="-1"></a><span class="co">#model.pp.cens.d1=readRDS(&quot;/Users/kevinying/TTEvignette/cense_model_d1.rds&quot;)</span></span>
<span id="cb21-74"><a href="#cb21-74" tabindex="-1"></a>model.pp.cens.d1<span class="ot">=</span><span class="fu">readRDS</span>(<span class="fu">file.path</span>(working_dir, <span class="st">&quot;cense_model_d1.rds&quot;</span>))</span>
<span id="cb21-75"><a href="#cb21-75" tabindex="-1"></a>dt.pp.cens.d1<span class="ot">=</span>model.pp.cens.d1<span class="sc">$</span>data</span>
<span id="cb21-76"><a href="#cb21-76" tabindex="-1"></a>check.cens.d1<span class="ot">=</span>simdata.one.trial<span class="sc">%&gt;%</span><span class="fu">left_join</span>(dt.pp.cens.d1<span class="sc">%&gt;%</span><span class="fu">mutate</span>(<span class="at">flag=</span><span class="dv">1</span>,<span class="at">time=</span>period)<span class="sc">%&gt;%</span><span class="fu">select</span>(id,time,flag))</span>
<span id="cb21-77"><a href="#cb21-77" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(id, time)`</span></span>
<span id="cb21-78"><a href="#cb21-78" tabindex="-1"></a>check.cens.d1<span class="sc">%&gt;%</span><span class="fu">filter</span>(id<span class="sc">==</span><span class="dv">6</span>)</span>
<span id="cb21-79"><a href="#cb21-79" tabindex="-1"></a><span class="co">#&gt; # A tibble: 8 × 21</span></span>
<span id="cb21-80"><a href="#cb21-80" tabindex="-1"></a><span class="co">#&gt;      id  time    X1      X2    X3     X4   age     A     Y     C age_s follow_up</span></span>
<span id="cb21-81"><a href="#cb21-81" tabindex="-1"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb21-82"><a href="#cb21-82" tabindex="-1"></a><span class="co">#&gt; 1     6     3     1  1.54       1 -0.321  50.7     0     0     0  1.31         0</span></span>
<span id="cb21-83"><a href="#cb21-83" tabindex="-1"></a><span class="co">#&gt; 2     6     4     0  0.160      1 -0.321  51.7     1     0     0  1.39         1</span></span>
<span id="cb21-84"><a href="#cb21-84" tabindex="-1"></a><span class="co">#&gt; 3     6     5     0  0.0264     1 -0.321  52.7     0     0     0  1.47         2</span></span>
<span id="cb21-85"><a href="#cb21-85" tabindex="-1"></a><span class="co">#&gt; 4     6     6     0  0.0621     1 -0.321  53.7     1     0     0  1.56         3</span></span>
<span id="cb21-86"><a href="#cb21-86" tabindex="-1"></a><span class="co">#&gt; 5     6     7     0 -0.0225     1 -0.321  54.7     0     0     0  1.64         4</span></span>
<span id="cb21-87"><a href="#cb21-87" tabindex="-1"></a><span class="co">#&gt; 6     6     8     1 -1.45       1 -0.321  55.7     0     0     0  1.72         5</span></span>
<span id="cb21-88"><a href="#cb21-88" tabindex="-1"></a><span class="co">#&gt; 7     6     9     1 -0.959      1 -0.321  56.7     0     0     0  1.81         6</span></span>
<span id="cb21-89"><a href="#cb21-89" tabindex="-1"></a><span class="co">#&gt; 8     6    10     1  1.42       1 -0.321  57.7     0     1     0  1.89         7</span></span>
<span id="cb21-90"><a href="#cb21-90" tabindex="-1"></a><span class="co">#&gt; # ℹ 9 more variables: assigned_treatment &lt;dbl&gt;, X1_0 &lt;dbl&gt;, X2_0 &lt;dbl&gt;,</span></span>
<span id="cb21-91"><a href="#cb21-91" tabindex="-1"></a><span class="co">#&gt; #   X3_0 &lt;dbl&gt;, X4_0 &lt;dbl&gt;, age_0 &lt;dbl&gt;, C_neg &lt;dbl&gt;, prev_A &lt;dbl&gt;, flag &lt;dbl&gt;</span></span>
<span id="cb21-92"><a href="#cb21-92" tabindex="-1"></a>simdata<span class="sc">%&gt;%</span><span class="fu">filter</span>(id<span class="sc">==</span><span class="dv">6</span>)</span>
<span id="cb21-93"><a href="#cb21-93" tabindex="-1"></a><span class="co">#&gt; # A tibble: 11 × 14</span></span>
<span id="cb21-94"><a href="#cb21-94" tabindex="-1"></a><span class="co">#&gt;       id  time    X1      X2    X3     X4   age     A     Y     C age_s eligible</span></span>
<span id="cb21-95"><a href="#cb21-95" tabindex="-1"></a><span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;int&gt;</span></span>
<span id="cb21-96"><a href="#cb21-96" tabindex="-1"></a><span class="co">#&gt;  1     6     0     1  1.01       1 -0.321  47.7     0     0     0  1.06        0</span></span>
<span id="cb21-97"><a href="#cb21-97" tabindex="-1"></a><span class="co">#&gt;  2     6     1     1 -1.99       1 -0.321  48.7     0     0     0  1.14        0</span></span>
<span id="cb21-98"><a href="#cb21-98" tabindex="-1"></a><span class="co">#&gt;  3     6     2     1 -0.517      1 -0.321  49.7     0     0     0  1.22        0</span></span>
<span id="cb21-99"><a href="#cb21-99" tabindex="-1"></a><span class="co">#&gt;  4     6     3     1  1.54       1 -0.321  50.7     0     0     0  1.31        1</span></span>
<span id="cb21-100"><a href="#cb21-100" tabindex="-1"></a><span class="co">#&gt;  5     6     4     0  0.160      1 -0.321  51.7     1     0     0  1.39        1</span></span>
<span id="cb21-101"><a href="#cb21-101" tabindex="-1"></a><span class="co">#&gt;  6     6     5     0  0.0264     1 -0.321  52.7     0     0     0  1.47        0</span></span>
<span id="cb21-102"><a href="#cb21-102" tabindex="-1"></a><span class="co">#&gt;  7     6     6     0  0.0621     1 -0.321  53.7     1     0     0  1.56        0</span></span>
<span id="cb21-103"><a href="#cb21-103" tabindex="-1"></a><span class="co">#&gt;  8     6     7     0 -0.0225     1 -0.321  54.7     0     0     0  1.64        0</span></span>
<span id="cb21-104"><a href="#cb21-104" tabindex="-1"></a><span class="co">#&gt;  9     6     8     1 -1.45       1 -0.321  55.7     0     0     0  1.72        0</span></span>
<span id="cb21-105"><a href="#cb21-105" tabindex="-1"></a><span class="co">#&gt; 10     6     9     1 -0.959      1 -0.321  56.7     0     0     0  1.81        1</span></span>
<span id="cb21-106"><a href="#cb21-106" tabindex="-1"></a><span class="co">#&gt; 11     6    10     1  1.42       1 -0.321  57.7     0     1     0  1.89        0</span></span>
<span id="cb21-107"><a href="#cb21-107" tabindex="-1"></a><span class="co">#&gt; # ℹ 2 more variables: ever_eligible &lt;lgl&gt;, first_eligible_time &lt;dbl&gt;</span></span>
<span id="cb21-108"><a href="#cb21-108" tabindex="-1"></a></span>
<span id="cb21-109"><a href="#cb21-109" tabindex="-1"></a>prep_PP_data<span class="sc">$</span>switch_models<span class="sc">$</span>switch_n0</span>
<span id="cb21-110"><a href="#cb21-110" tabindex="-1"></a><span class="co">#&gt; P(treatment = 1 | previous treatment = 0) for numerator </span></span>
<span id="cb21-111"><a href="#cb21-111" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb21-112"><a href="#cb21-112" tabindex="-1"></a><span class="co">#&gt;                 term     estimate   std.error  statistic      p.value</span></span>
<span id="cb21-113"><a href="#cb21-113" tabindex="-1"></a><span class="co">#&gt;          (Intercept) -1.358605650 0.153889794 -8.8284324 1.061529e-18</span></span>
<span id="cb21-114"><a href="#cb21-114" tabindex="-1"></a><span class="co">#&gt;                   X3 -0.105972700 0.152339273 -0.6956361 4.866567e-01</span></span>
<span id="cb21-115"><a href="#cb21-115" tabindex="-1"></a><span class="co">#&gt;                   X4  1.015666266 0.112995580  8.9885486 2.505166e-19</span></span>
<span id="cb21-116"><a href="#cb21-116" tabindex="-1"></a><span class="co">#&gt;       time_on_regime  0.008696221 0.064631782  0.1345502 8.929675e-01</span></span>
<span id="cb21-117"><a href="#cb21-117" tabindex="-1"></a><span class="co">#&gt;  I(time_on_regime^2)  0.002135819 0.005615123  0.3803690 7.036715e-01</span></span>
<span id="cb21-118"><a href="#cb21-118" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb21-119"><a href="#cb21-119" tabindex="-1"></a><span class="co">#&gt;  null.deviance df.null   logLik      AIC      BIC deviance df.residual nobs</span></span>
<span id="cb21-120"><a href="#cb21-120" tabindex="-1"></a><span class="co">#&gt;       1241.907    1505 -569.371 1148.742 1175.328 1138.742        1501 1506</span></span>
<span id="cb21-121"><a href="#cb21-121" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb21-122"><a href="#cb21-122" tabindex="-1"></a><span class="co">#&gt; Object saved at &quot;C:/Users/u6067002/Documents/GitHub/TargetTrialEmulation/weight_model_switch_n0.rds&quot;</span></span>
<span id="cb21-123"><a href="#cb21-123" tabindex="-1"></a><span class="co">#model.pp.switch.n0=readRDS(&quot;/Users/kevinying/TTEvignette/weight_model_switch_d0.rds&quot;)</span></span>
<span id="cb21-124"><a href="#cb21-124" tabindex="-1"></a>model.pp.switch.n0<span class="ot">=</span><span class="fu">readRDS</span>(<span class="fu">file.path</span>(working_dir, <span class="st">&quot;weight_model_switch_n0.rds&quot;</span>))</span>
<span id="cb21-125"><a href="#cb21-125" tabindex="-1"></a>dt.pp.switch.n0<span class="ot">=</span>model.pp.switch.n0<span class="sc">$</span>data</span>
<span id="cb21-126"><a href="#cb21-126" tabindex="-1"></a>check.switch.n0<span class="ot">=</span>simdata.one.trial<span class="sc">%&gt;%</span><span class="fu">left_join</span>(dt.pp.switch.n0<span class="sc">%&gt;%</span><span class="fu">mutate</span>(<span class="at">flag=</span><span class="dv">1</span>,<span class="at">time=</span>period)<span class="sc">%&gt;%</span><span class="fu">select</span>(id,time,flag))</span>
<span id="cb21-127"><a href="#cb21-127" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(id, time)`</span></span>
<span id="cb21-128"><a href="#cb21-128" tabindex="-1"></a>check.switch.n0<span class="sc">%&gt;%</span><span class="fu">filter</span>(id<span class="sc">==</span><span class="dv">6</span>)</span>
<span id="cb21-129"><a href="#cb21-129" tabindex="-1"></a><span class="co">#&gt; # A tibble: 8 × 21</span></span>
<span id="cb21-130"><a href="#cb21-130" tabindex="-1"></a><span class="co">#&gt;      id  time    X1      X2    X3     X4   age     A     Y     C age_s follow_up</span></span>
<span id="cb21-131"><a href="#cb21-131" tabindex="-1"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb21-132"><a href="#cb21-132" tabindex="-1"></a><span class="co">#&gt; 1     6     3     1  1.54       1 -0.321  50.7     0     0     0  1.31         0</span></span>
<span id="cb21-133"><a href="#cb21-133" tabindex="-1"></a><span class="co">#&gt; 2     6     4     0  0.160      1 -0.321  51.7     1     0     0  1.39         1</span></span>
<span id="cb21-134"><a href="#cb21-134" tabindex="-1"></a><span class="co">#&gt; 3     6     5     0  0.0264     1 -0.321  52.7     0     0     0  1.47         2</span></span>
<span id="cb21-135"><a href="#cb21-135" tabindex="-1"></a><span class="co">#&gt; 4     6     6     0  0.0621     1 -0.321  53.7     1     0     0  1.56         3</span></span>
<span id="cb21-136"><a href="#cb21-136" tabindex="-1"></a><span class="co">#&gt; 5     6     7     0 -0.0225     1 -0.321  54.7     0     0     0  1.64         4</span></span>
<span id="cb21-137"><a href="#cb21-137" tabindex="-1"></a><span class="co">#&gt; 6     6     8     1 -1.45       1 -0.321  55.7     0     0     0  1.72         5</span></span>
<span id="cb21-138"><a href="#cb21-138" tabindex="-1"></a><span class="co">#&gt; 7     6     9     1 -0.959      1 -0.321  56.7     0     0     0  1.81         6</span></span>
<span id="cb21-139"><a href="#cb21-139" tabindex="-1"></a><span class="co">#&gt; 8     6    10     1  1.42       1 -0.321  57.7     0     1     0  1.89         7</span></span>
<span id="cb21-140"><a href="#cb21-140" tabindex="-1"></a><span class="co">#&gt; # ℹ 9 more variables: assigned_treatment &lt;dbl&gt;, X1_0 &lt;dbl&gt;, X2_0 &lt;dbl&gt;,</span></span>
<span id="cb21-141"><a href="#cb21-141" tabindex="-1"></a><span class="co">#&gt; #   X3_0 &lt;dbl&gt;, X4_0 &lt;dbl&gt;, age_0 &lt;dbl&gt;, C_neg &lt;dbl&gt;, prev_A &lt;dbl&gt;, flag &lt;dbl&gt;</span></span>
<span id="cb21-142"><a href="#cb21-142" tabindex="-1"></a>simdata<span class="sc">%&gt;%</span><span class="fu">filter</span>(id<span class="sc">==</span><span class="dv">6</span>)</span>
<span id="cb21-143"><a href="#cb21-143" tabindex="-1"></a><span class="co">#&gt; # A tibble: 11 × 14</span></span>
<span id="cb21-144"><a href="#cb21-144" tabindex="-1"></a><span class="co">#&gt;       id  time    X1      X2    X3     X4   age     A     Y     C age_s eligible</span></span>
<span id="cb21-145"><a href="#cb21-145" tabindex="-1"></a><span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;int&gt;</span></span>
<span id="cb21-146"><a href="#cb21-146" tabindex="-1"></a><span class="co">#&gt;  1     6     0     1  1.01       1 -0.321  47.7     0     0     0  1.06        0</span></span>
<span id="cb21-147"><a href="#cb21-147" tabindex="-1"></a><span class="co">#&gt;  2     6     1     1 -1.99       1 -0.321  48.7     0     0     0  1.14        0</span></span>
<span id="cb21-148"><a href="#cb21-148" tabindex="-1"></a><span class="co">#&gt;  3     6     2     1 -0.517      1 -0.321  49.7     0     0     0  1.22        0</span></span>
<span id="cb21-149"><a href="#cb21-149" tabindex="-1"></a><span class="co">#&gt;  4     6     3     1  1.54       1 -0.321  50.7     0     0     0  1.31        1</span></span>
<span id="cb21-150"><a href="#cb21-150" tabindex="-1"></a><span class="co">#&gt;  5     6     4     0  0.160      1 -0.321  51.7     1     0     0  1.39        1</span></span>
<span id="cb21-151"><a href="#cb21-151" tabindex="-1"></a><span class="co">#&gt;  6     6     5     0  0.0264     1 -0.321  52.7     0     0     0  1.47        0</span></span>
<span id="cb21-152"><a href="#cb21-152" tabindex="-1"></a><span class="co">#&gt;  7     6     6     0  0.0621     1 -0.321  53.7     1     0     0  1.56        0</span></span>
<span id="cb21-153"><a href="#cb21-153" tabindex="-1"></a><span class="co">#&gt;  8     6     7     0 -0.0225     1 -0.321  54.7     0     0     0  1.64        0</span></span>
<span id="cb21-154"><a href="#cb21-154" tabindex="-1"></a><span class="co">#&gt;  9     6     8     1 -1.45       1 -0.321  55.7     0     0     0  1.72        0</span></span>
<span id="cb21-155"><a href="#cb21-155" tabindex="-1"></a><span class="co">#&gt; 10     6     9     1 -0.959      1 -0.321  56.7     0     0     0  1.81        1</span></span>
<span id="cb21-156"><a href="#cb21-156" tabindex="-1"></a><span class="co">#&gt; 11     6    10     1  1.42       1 -0.321  57.7     0     1     0  1.89        0</span></span>
<span id="cb21-157"><a href="#cb21-157" tabindex="-1"></a><span class="co">#&gt; # ℹ 2 more variables: ever_eligible &lt;lgl&gt;, first_eligible_time &lt;dbl&gt;</span></span>
<span id="cb21-158"><a href="#cb21-158" tabindex="-1"></a></span>
<span id="cb21-159"><a href="#cb21-159" tabindex="-1"></a>prep_PP_data<span class="sc">$</span>switch_models<span class="sc">$</span>switch_n1</span>
<span id="cb21-160"><a href="#cb21-160" tabindex="-1"></a><span class="co">#&gt; P(treatment = 1 | previous treatment = 1) for numerator </span></span>
<span id="cb21-161"><a href="#cb21-161" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb21-162"><a href="#cb21-162" tabindex="-1"></a><span class="co">#&gt;                 term    estimate  std.error   statistic      p.value</span></span>
<span id="cb21-163"><a href="#cb21-163" tabindex="-1"></a><span class="co">#&gt;          (Intercept) -0.01733488 0.31052958 -0.05582362 9.554823e-01</span></span>
<span id="cb21-164"><a href="#cb21-164" tabindex="-1"></a><span class="co">#&gt;                   X3  0.03760243 0.22408909  0.16780123 8.667397e-01</span></span>
<span id="cb21-165"><a href="#cb21-165" tabindex="-1"></a><span class="co">#&gt;                   X4  1.15813045 0.19097732  6.06423039 1.325870e-09</span></span>
<span id="cb21-166"><a href="#cb21-166" tabindex="-1"></a><span class="co">#&gt;       time_on_regime  0.13512522 0.20649058  0.65438928 5.128610e-01</span></span>
<span id="cb21-167"><a href="#cb21-167" tabindex="-1"></a><span class="co">#&gt;  I(time_on_regime^2) -0.02319405 0.02409875 -0.96245884 3.358192e-01</span></span>
<span id="cb21-168"><a href="#cb21-168" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb21-169"><a href="#cb21-169" tabindex="-1"></a><span class="co">#&gt;  null.deviance df.null    logLik      AIC      BIC deviance df.residual nobs</span></span>
<span id="cb21-170"><a href="#cb21-170" tabindex="-1"></a><span class="co">#&gt;       513.2795     371 -231.8355 473.6709 493.2654 463.6709         367  372</span></span>
<span id="cb21-171"><a href="#cb21-171" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb21-172"><a href="#cb21-172" tabindex="-1"></a><span class="co">#&gt; Object saved at &quot;C:/Users/u6067002/Documents/GitHub/TargetTrialEmulation/weight_model_switch_n1.rds&quot;</span></span>
<span id="cb21-173"><a href="#cb21-173" tabindex="-1"></a><span class="co">#model.pp.switch.n1=readRDS(&quot;/Users/kevinying/TTEvignette/weight_model_switch_d1.rds&quot;)</span></span>
<span id="cb21-174"><a href="#cb21-174" tabindex="-1"></a>model.pp.switch.n1<span class="ot">=</span><span class="fu">readRDS</span>(<span class="fu">file.path</span>(working_dir, <span class="st">&quot;weight_model_switch_n1.rds&quot;</span>))</span>
<span id="cb21-175"><a href="#cb21-175" tabindex="-1"></a>dt.pp.switch.n1<span class="ot">=</span>model.pp.switch.n1<span class="sc">$</span>data</span>
<span id="cb21-176"><a href="#cb21-176" tabindex="-1"></a>check.switch.n1<span class="ot">=</span>simdata.one.trial<span class="sc">%&gt;%</span><span class="fu">left_join</span>(dt.pp.switch.n1<span class="sc">%&gt;%</span><span class="fu">mutate</span>(<span class="at">flag=</span><span class="dv">1</span>,<span class="at">time=</span>period)<span class="sc">%&gt;%</span><span class="fu">select</span>(id,time,flag))</span>
<span id="cb21-177"><a href="#cb21-177" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(id, time)`</span></span>
<span id="cb21-178"><a href="#cb21-178" tabindex="-1"></a>check.switch.n1<span class="sc">%&gt;%</span><span class="fu">filter</span>(id<span class="sc">==</span><span class="dv">6</span>)</span>
<span id="cb21-179"><a href="#cb21-179" tabindex="-1"></a><span class="co">#&gt; # A tibble: 8 × 21</span></span>
<span id="cb21-180"><a href="#cb21-180" tabindex="-1"></a><span class="co">#&gt;      id  time    X1      X2    X3     X4   age     A     Y     C age_s follow_up</span></span>
<span id="cb21-181"><a href="#cb21-181" tabindex="-1"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb21-182"><a href="#cb21-182" tabindex="-1"></a><span class="co">#&gt; 1     6     3     1  1.54       1 -0.321  50.7     0     0     0  1.31         0</span></span>
<span id="cb21-183"><a href="#cb21-183" tabindex="-1"></a><span class="co">#&gt; 2     6     4     0  0.160      1 -0.321  51.7     1     0     0  1.39         1</span></span>
<span id="cb21-184"><a href="#cb21-184" tabindex="-1"></a><span class="co">#&gt; 3     6     5     0  0.0264     1 -0.321  52.7     0     0     0  1.47         2</span></span>
<span id="cb21-185"><a href="#cb21-185" tabindex="-1"></a><span class="co">#&gt; 4     6     6     0  0.0621     1 -0.321  53.7     1     0     0  1.56         3</span></span>
<span id="cb21-186"><a href="#cb21-186" tabindex="-1"></a><span class="co">#&gt; 5     6     7     0 -0.0225     1 -0.321  54.7     0     0     0  1.64         4</span></span>
<span id="cb21-187"><a href="#cb21-187" tabindex="-1"></a><span class="co">#&gt; 6     6     8     1 -1.45       1 -0.321  55.7     0     0     0  1.72         5</span></span>
<span id="cb21-188"><a href="#cb21-188" tabindex="-1"></a><span class="co">#&gt; 7     6     9     1 -0.959      1 -0.321  56.7     0     0     0  1.81         6</span></span>
<span id="cb21-189"><a href="#cb21-189" tabindex="-1"></a><span class="co">#&gt; 8     6    10     1  1.42       1 -0.321  57.7     0     1     0  1.89         7</span></span>
<span id="cb21-190"><a href="#cb21-190" tabindex="-1"></a><span class="co">#&gt; # ℹ 9 more variables: assigned_treatment &lt;dbl&gt;, X1_0 &lt;dbl&gt;, X2_0 &lt;dbl&gt;,</span></span>
<span id="cb21-191"><a href="#cb21-191" tabindex="-1"></a><span class="co">#&gt; #   X3_0 &lt;dbl&gt;, X4_0 &lt;dbl&gt;, age_0 &lt;dbl&gt;, C_neg &lt;dbl&gt;, prev_A &lt;dbl&gt;, flag &lt;dbl&gt;</span></span>
<span id="cb21-192"><a href="#cb21-192" tabindex="-1"></a>simdata<span class="sc">%&gt;%</span><span class="fu">filter</span>(id<span class="sc">==</span><span class="dv">6</span>)</span>
<span id="cb21-193"><a href="#cb21-193" tabindex="-1"></a><span class="co">#&gt; # A tibble: 11 × 14</span></span>
<span id="cb21-194"><a href="#cb21-194" tabindex="-1"></a><span class="co">#&gt;       id  time    X1      X2    X3     X4   age     A     Y     C age_s eligible</span></span>
<span id="cb21-195"><a href="#cb21-195" tabindex="-1"></a><span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;int&gt;</span></span>
<span id="cb21-196"><a href="#cb21-196" tabindex="-1"></a><span class="co">#&gt;  1     6     0     1  1.01       1 -0.321  47.7     0     0     0  1.06        0</span></span>
<span id="cb21-197"><a href="#cb21-197" tabindex="-1"></a><span class="co">#&gt;  2     6     1     1 -1.99       1 -0.321  48.7     0     0     0  1.14        0</span></span>
<span id="cb21-198"><a href="#cb21-198" tabindex="-1"></a><span class="co">#&gt;  3     6     2     1 -0.517      1 -0.321  49.7     0     0     0  1.22        0</span></span>
<span id="cb21-199"><a href="#cb21-199" tabindex="-1"></a><span class="co">#&gt;  4     6     3     1  1.54       1 -0.321  50.7     0     0     0  1.31        1</span></span>
<span id="cb21-200"><a href="#cb21-200" tabindex="-1"></a><span class="co">#&gt;  5     6     4     0  0.160      1 -0.321  51.7     1     0     0  1.39        1</span></span>
<span id="cb21-201"><a href="#cb21-201" tabindex="-1"></a><span class="co">#&gt;  6     6     5     0  0.0264     1 -0.321  52.7     0     0     0  1.47        0</span></span>
<span id="cb21-202"><a href="#cb21-202" tabindex="-1"></a><span class="co">#&gt;  7     6     6     0  0.0621     1 -0.321  53.7     1     0     0  1.56        0</span></span>
<span id="cb21-203"><a href="#cb21-203" tabindex="-1"></a><span class="co">#&gt;  8     6     7     0 -0.0225     1 -0.321  54.7     0     0     0  1.64        0</span></span>
<span id="cb21-204"><a href="#cb21-204" tabindex="-1"></a><span class="co">#&gt;  9     6     8     1 -1.45       1 -0.321  55.7     0     0     0  1.72        0</span></span>
<span id="cb21-205"><a href="#cb21-205" tabindex="-1"></a><span class="co">#&gt; 10     6     9     1 -0.959      1 -0.321  56.7     0     0     0  1.81        1</span></span>
<span id="cb21-206"><a href="#cb21-206" tabindex="-1"></a><span class="co">#&gt; 11     6    10     1  1.42       1 -0.321  57.7     0     1     0  1.89        0</span></span>
<span id="cb21-207"><a href="#cb21-207" tabindex="-1"></a><span class="co">#&gt; # ℹ 2 more variables: ever_eligible &lt;lgl&gt;, first_eligible_time &lt;dbl&gt;</span></span>
<span id="cb21-208"><a href="#cb21-208" tabindex="-1"></a></span>
<span id="cb21-209"><a href="#cb21-209" tabindex="-1"></a>prep_PP_data<span class="sc">$</span>switch_models<span class="sc">$</span>switch_d0</span>
<span id="cb21-210"><a href="#cb21-210" tabindex="-1"></a><span class="co">#&gt; P(treatment = 1 | previous treatment = 0) for denominator </span></span>
<span id="cb21-211"><a href="#cb21-211" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb21-212"><a href="#cb21-212" tabindex="-1"></a><span class="co">#&gt;                 term    estimate   std.error   statistic      p.value</span></span>
<span id="cb21-213"><a href="#cb21-213" tabindex="-1"></a><span class="co">#&gt;          (Intercept) -1.07153276 0.340268158 -3.14908326 1.637835e-03</span></span>
<span id="cb21-214"><a href="#cb21-214" tabindex="-1"></a><span class="co">#&gt;                   X1  0.62652476 0.159203815  3.93536273 8.307114e-05</span></span>
<span id="cb21-215"><a href="#cb21-215" tabindex="-1"></a><span class="co">#&gt;                   X2  0.45579390 0.077255879  5.89979566 3.639520e-09</span></span>
<span id="cb21-216"><a href="#cb21-216" tabindex="-1"></a><span class="co">#&gt;                   X3 -0.15896293 0.158865080 -1.00061594 3.170125e-01</span></span>
<span id="cb21-217"><a href="#cb21-217" tabindex="-1"></a><span class="co">#&gt;                   X4  1.13211175 0.121796108  9.29513898 1.470140e-20</span></span>
<span id="cb21-218"><a href="#cb21-218" tabindex="-1"></a><span class="co">#&gt;                age_s -0.39612661 0.169355699 -2.33902141 1.933433e-02</span></span>
<span id="cb21-219"><a href="#cb21-219" tabindex="-1"></a><span class="co">#&gt;       time_on_regime  0.06627805 0.071432894  0.92783653 3.534924e-01</span></span>
<span id="cb21-220"><a href="#cb21-220" tabindex="-1"></a><span class="co">#&gt;  I(time_on_regime^2)  0.00015767 0.005769452  0.02732842 9.781978e-01</span></span>
<span id="cb21-221"><a href="#cb21-221" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb21-222"><a href="#cb21-222" tabindex="-1"></a><span class="co">#&gt;  null.deviance df.null    logLik      AIC      BIC deviance df.residual nobs</span></span>
<span id="cb21-223"><a href="#cb21-223" tabindex="-1"></a><span class="co">#&gt;       1241.907    1505 -540.6626 1097.325 1139.863 1081.325        1498 1506</span></span>
<span id="cb21-224"><a href="#cb21-224" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb21-225"><a href="#cb21-225" tabindex="-1"></a><span class="co">#&gt; Object saved at &quot;C:/Users/u6067002/Documents/GitHub/TargetTrialEmulation/weight_model_switch_d0.rds&quot;</span></span>
<span id="cb21-226"><a href="#cb21-226" tabindex="-1"></a><span class="co">#model.pp.switch.d0=readRDS(&quot;/Users/kevinying/TTEvignette/weight_model_switch_d0.rds&quot;)</span></span>
<span id="cb21-227"><a href="#cb21-227" tabindex="-1"></a>model.pp.switch.d0<span class="ot">=</span><span class="fu">readRDS</span>(<span class="fu">file.path</span>(working_dir, <span class="st">&quot;weight_model_switch_d0.rds&quot;</span>)) </span>
<span id="cb21-228"><a href="#cb21-228" tabindex="-1"></a>dt.pp.switch.d0<span class="ot">=</span>model.pp.switch.d0<span class="sc">$</span>data</span>
<span id="cb21-229"><a href="#cb21-229" tabindex="-1"></a>check.switch.d0<span class="ot">=</span>simdata.one.trial<span class="sc">%&gt;%</span><span class="fu">left_join</span>(dt.pp.switch.d0<span class="sc">%&gt;%</span><span class="fu">mutate</span>(<span class="at">flag=</span><span class="dv">1</span>,<span class="at">time=</span>period)<span class="sc">%&gt;%</span><span class="fu">select</span>(id,time,flag))</span>
<span id="cb21-230"><a href="#cb21-230" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(id, time)`</span></span>
<span id="cb21-231"><a href="#cb21-231" tabindex="-1"></a>check.switch.d0<span class="sc">%&gt;%</span><span class="fu">filter</span>(id<span class="sc">==</span><span class="dv">6</span>)</span>
<span id="cb21-232"><a href="#cb21-232" tabindex="-1"></a><span class="co">#&gt; # A tibble: 8 × 21</span></span>
<span id="cb21-233"><a href="#cb21-233" tabindex="-1"></a><span class="co">#&gt;      id  time    X1      X2    X3     X4   age     A     Y     C age_s follow_up</span></span>
<span id="cb21-234"><a href="#cb21-234" tabindex="-1"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb21-235"><a href="#cb21-235" tabindex="-1"></a><span class="co">#&gt; 1     6     3     1  1.54       1 -0.321  50.7     0     0     0  1.31         0</span></span>
<span id="cb21-236"><a href="#cb21-236" tabindex="-1"></a><span class="co">#&gt; 2     6     4     0  0.160      1 -0.321  51.7     1     0     0  1.39         1</span></span>
<span id="cb21-237"><a href="#cb21-237" tabindex="-1"></a><span class="co">#&gt; 3     6     5     0  0.0264     1 -0.321  52.7     0     0     0  1.47         2</span></span>
<span id="cb21-238"><a href="#cb21-238" tabindex="-1"></a><span class="co">#&gt; 4     6     6     0  0.0621     1 -0.321  53.7     1     0     0  1.56         3</span></span>
<span id="cb21-239"><a href="#cb21-239" tabindex="-1"></a><span class="co">#&gt; 5     6     7     0 -0.0225     1 -0.321  54.7     0     0     0  1.64         4</span></span>
<span id="cb21-240"><a href="#cb21-240" tabindex="-1"></a><span class="co">#&gt; 6     6     8     1 -1.45       1 -0.321  55.7     0     0     0  1.72         5</span></span>
<span id="cb21-241"><a href="#cb21-241" tabindex="-1"></a><span class="co">#&gt; 7     6     9     1 -0.959      1 -0.321  56.7     0     0     0  1.81         6</span></span>
<span id="cb21-242"><a href="#cb21-242" tabindex="-1"></a><span class="co">#&gt; 8     6    10     1  1.42       1 -0.321  57.7     0     1     0  1.89         7</span></span>
<span id="cb21-243"><a href="#cb21-243" tabindex="-1"></a><span class="co">#&gt; # ℹ 9 more variables: assigned_treatment &lt;dbl&gt;, X1_0 &lt;dbl&gt;, X2_0 &lt;dbl&gt;,</span></span>
<span id="cb21-244"><a href="#cb21-244" tabindex="-1"></a><span class="co">#&gt; #   X3_0 &lt;dbl&gt;, X4_0 &lt;dbl&gt;, age_0 &lt;dbl&gt;, C_neg &lt;dbl&gt;, prev_A &lt;dbl&gt;, flag &lt;dbl&gt;</span></span>
<span id="cb21-245"><a href="#cb21-245" tabindex="-1"></a>simdata<span class="sc">%&gt;%</span><span class="fu">filter</span>(id<span class="sc">==</span><span class="dv">6</span>)</span>
<span id="cb21-246"><a href="#cb21-246" tabindex="-1"></a><span class="co">#&gt; # A tibble: 11 × 14</span></span>
<span id="cb21-247"><a href="#cb21-247" tabindex="-1"></a><span class="co">#&gt;       id  time    X1      X2    X3     X4   age     A     Y     C age_s eligible</span></span>
<span id="cb21-248"><a href="#cb21-248" tabindex="-1"></a><span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;int&gt;</span></span>
<span id="cb21-249"><a href="#cb21-249" tabindex="-1"></a><span class="co">#&gt;  1     6     0     1  1.01       1 -0.321  47.7     0     0     0  1.06        0</span></span>
<span id="cb21-250"><a href="#cb21-250" tabindex="-1"></a><span class="co">#&gt;  2     6     1     1 -1.99       1 -0.321  48.7     0     0     0  1.14        0</span></span>
<span id="cb21-251"><a href="#cb21-251" tabindex="-1"></a><span class="co">#&gt;  3     6     2     1 -0.517      1 -0.321  49.7     0     0     0  1.22        0</span></span>
<span id="cb21-252"><a href="#cb21-252" tabindex="-1"></a><span class="co">#&gt;  4     6     3     1  1.54       1 -0.321  50.7     0     0     0  1.31        1</span></span>
<span id="cb21-253"><a href="#cb21-253" tabindex="-1"></a><span class="co">#&gt;  5     6     4     0  0.160      1 -0.321  51.7     1     0     0  1.39        1</span></span>
<span id="cb21-254"><a href="#cb21-254" tabindex="-1"></a><span class="co">#&gt;  6     6     5     0  0.0264     1 -0.321  52.7     0     0     0  1.47        0</span></span>
<span id="cb21-255"><a href="#cb21-255" tabindex="-1"></a><span class="co">#&gt;  7     6     6     0  0.0621     1 -0.321  53.7     1     0     0  1.56        0</span></span>
<span id="cb21-256"><a href="#cb21-256" tabindex="-1"></a><span class="co">#&gt;  8     6     7     0 -0.0225     1 -0.321  54.7     0     0     0  1.64        0</span></span>
<span id="cb21-257"><a href="#cb21-257" tabindex="-1"></a><span class="co">#&gt;  9     6     8     1 -1.45       1 -0.321  55.7     0     0     0  1.72        0</span></span>
<span id="cb21-258"><a href="#cb21-258" tabindex="-1"></a><span class="co">#&gt; 10     6     9     1 -0.959      1 -0.321  56.7     0     0     0  1.81        1</span></span>
<span id="cb21-259"><a href="#cb21-259" tabindex="-1"></a><span class="co">#&gt; 11     6    10     1  1.42       1 -0.321  57.7     0     1     0  1.89        0</span></span>
<span id="cb21-260"><a href="#cb21-260" tabindex="-1"></a><span class="co">#&gt; # ℹ 2 more variables: ever_eligible &lt;lgl&gt;, first_eligible_time &lt;dbl&gt;</span></span>
<span id="cb21-261"><a href="#cb21-261" tabindex="-1"></a></span>
<span id="cb21-262"><a href="#cb21-262" tabindex="-1"></a>prep_PP_data<span class="sc">$</span>switch_models<span class="sc">$</span>switch_d1</span>
<span id="cb21-263"><a href="#cb21-263" tabindex="-1"></a><span class="co">#&gt; P(treatment = 1 | previous treatment = 1) for denominator </span></span>
<span id="cb21-264"><a href="#cb21-264" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb21-265"><a href="#cb21-265" tabindex="-1"></a><span class="co">#&gt;                 term    estimate  std.error   statistic      p.value</span></span>
<span id="cb21-266"><a href="#cb21-266" tabindex="-1"></a><span class="co">#&gt;          (Intercept)  0.23941959 0.58528739  0.40906329 6.824932e-01</span></span>
<span id="cb21-267"><a href="#cb21-267" tabindex="-1"></a><span class="co">#&gt;                   X1  0.71945648 0.26038898  2.76300667 5.727160e-03</span></span>
<span id="cb21-268"><a href="#cb21-268" tabindex="-1"></a><span class="co">#&gt;                   X2  0.48608203 0.11663038  4.16771367 3.076701e-05</span></span>
<span id="cb21-269"><a href="#cb21-269" tabindex="-1"></a><span class="co">#&gt;                   X3  0.01542306 0.23706497  0.06505837 9.481275e-01</span></span>
<span id="cb21-270"><a href="#cb21-270" tabindex="-1"></a><span class="co">#&gt;                   X4  1.27117533 0.20511790  6.19729097 5.744325e-10</span></span>
<span id="cb21-271"><a href="#cb21-271" tabindex="-1"></a><span class="co">#&gt;                age_s -0.05643920 0.23310869 -0.24211538 8.086908e-01</span></span>
<span id="cb21-272"><a href="#cb21-272" tabindex="-1"></a><span class="co">#&gt;       time_on_regime  0.02990231 0.21494059  0.13911895 8.893562e-01</span></span>
<span id="cb21-273"><a href="#cb21-273" tabindex="-1"></a><span class="co">#&gt;  I(time_on_regime^2) -0.01067950 0.02485085 -0.42974408 6.673818e-01</span></span>
<span id="cb21-274"><a href="#cb21-274" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb21-275"><a href="#cb21-275" tabindex="-1"></a><span class="co">#&gt;  null.deviance df.null    logLik      AIC      BIC deviance df.residual nobs</span></span>
<span id="cb21-276"><a href="#cb21-276" tabindex="-1"></a><span class="co">#&gt;       513.2795     371 -218.3396 452.6792 484.0304 436.6792         364  372</span></span>
<span id="cb21-277"><a href="#cb21-277" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb21-278"><a href="#cb21-278" tabindex="-1"></a><span class="co">#&gt; Object saved at &quot;C:/Users/u6067002/Documents/GitHub/TargetTrialEmulation/weight_model_switch_d1.rds&quot;</span></span>
<span id="cb21-279"><a href="#cb21-279" tabindex="-1"></a><span class="co">#model.pp.switch.d1=readRDS(&quot;/Users/kevinying/TTEvignette/weight_model_switch_d1.rds&quot;)</span></span>
<span id="cb21-280"><a href="#cb21-280" tabindex="-1"></a>model.pp.switch.d1<span class="ot">=</span><span class="fu">readRDS</span>(<span class="fu">file.path</span>(working_dir, <span class="st">&quot;weight_model_switch_d1.rds&quot;</span>))</span>
<span id="cb21-281"><a href="#cb21-281" tabindex="-1"></a>dt.pp.switch.d1<span class="ot">=</span>model.pp.switch.d1<span class="sc">$</span>data</span>
<span id="cb21-282"><a href="#cb21-282" tabindex="-1"></a>check.switch.d1<span class="ot">=</span>simdata.one.trial<span class="sc">%&gt;%</span><span class="fu">left_join</span>(dt.pp.switch.d1<span class="sc">%&gt;%</span><span class="fu">mutate</span>(<span class="at">flag=</span><span class="dv">1</span>,<span class="at">time=</span>period)<span class="sc">%&gt;%</span><span class="fu">select</span>(id,time,flag))</span>
<span id="cb21-283"><a href="#cb21-283" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(id, time)`</span></span>
<span id="cb21-284"><a href="#cb21-284" tabindex="-1"></a>check.switch.d1<span class="sc">%&gt;%</span><span class="fu">filter</span>(id<span class="sc">==</span><span class="dv">6</span>)</span>
<span id="cb21-285"><a href="#cb21-285" tabindex="-1"></a><span class="co">#&gt; # A tibble: 8 × 21</span></span>
<span id="cb21-286"><a href="#cb21-286" tabindex="-1"></a><span class="co">#&gt;      id  time    X1      X2    X3     X4   age     A     Y     C age_s follow_up</span></span>
<span id="cb21-287"><a href="#cb21-287" tabindex="-1"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb21-288"><a href="#cb21-288" tabindex="-1"></a><span class="co">#&gt; 1     6     3     1  1.54       1 -0.321  50.7     0     0     0  1.31         0</span></span>
<span id="cb21-289"><a href="#cb21-289" tabindex="-1"></a><span class="co">#&gt; 2     6     4     0  0.160      1 -0.321  51.7     1     0     0  1.39         1</span></span>
<span id="cb21-290"><a href="#cb21-290" tabindex="-1"></a><span class="co">#&gt; 3     6     5     0  0.0264     1 -0.321  52.7     0     0     0  1.47         2</span></span>
<span id="cb21-291"><a href="#cb21-291" tabindex="-1"></a><span class="co">#&gt; 4     6     6     0  0.0621     1 -0.321  53.7     1     0     0  1.56         3</span></span>
<span id="cb21-292"><a href="#cb21-292" tabindex="-1"></a><span class="co">#&gt; 5     6     7     0 -0.0225     1 -0.321  54.7     0     0     0  1.64         4</span></span>
<span id="cb21-293"><a href="#cb21-293" tabindex="-1"></a><span class="co">#&gt; 6     6     8     1 -1.45       1 -0.321  55.7     0     0     0  1.72         5</span></span>
<span id="cb21-294"><a href="#cb21-294" tabindex="-1"></a><span class="co">#&gt; 7     6     9     1 -0.959      1 -0.321  56.7     0     0     0  1.81         6</span></span>
<span id="cb21-295"><a href="#cb21-295" tabindex="-1"></a><span class="co">#&gt; 8     6    10     1  1.42       1 -0.321  57.7     0     1     0  1.89         7</span></span>
<span id="cb21-296"><a href="#cb21-296" tabindex="-1"></a><span class="co">#&gt; # ℹ 9 more variables: assigned_treatment &lt;dbl&gt;, X1_0 &lt;dbl&gt;, X2_0 &lt;dbl&gt;,</span></span>
<span id="cb21-297"><a href="#cb21-297" tabindex="-1"></a><span class="co">#&gt; #   X3_0 &lt;dbl&gt;, X4_0 &lt;dbl&gt;, age_0 &lt;dbl&gt;, C_neg &lt;dbl&gt;, prev_A &lt;dbl&gt;, flag &lt;dbl&gt;</span></span>
<span id="cb21-298"><a href="#cb21-298" tabindex="-1"></a>simdata<span class="sc">%&gt;%</span><span class="fu">filter</span>(id<span class="sc">==</span><span class="dv">6</span>)</span>
<span id="cb21-299"><a href="#cb21-299" tabindex="-1"></a><span class="co">#&gt; # A tibble: 11 × 14</span></span>
<span id="cb21-300"><a href="#cb21-300" tabindex="-1"></a><span class="co">#&gt;       id  time    X1      X2    X3     X4   age     A     Y     C age_s eligible</span></span>
<span id="cb21-301"><a href="#cb21-301" tabindex="-1"></a><span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;int&gt;</span></span>
<span id="cb21-302"><a href="#cb21-302" tabindex="-1"></a><span class="co">#&gt;  1     6     0     1  1.01       1 -0.321  47.7     0     0     0  1.06        0</span></span>
<span id="cb21-303"><a href="#cb21-303" tabindex="-1"></a><span class="co">#&gt;  2     6     1     1 -1.99       1 -0.321  48.7     0     0     0  1.14        0</span></span>
<span id="cb21-304"><a href="#cb21-304" tabindex="-1"></a><span class="co">#&gt;  3     6     2     1 -0.517      1 -0.321  49.7     0     0     0  1.22        0</span></span>
<span id="cb21-305"><a href="#cb21-305" tabindex="-1"></a><span class="co">#&gt;  4     6     3     1  1.54       1 -0.321  50.7     0     0     0  1.31        1</span></span>
<span id="cb21-306"><a href="#cb21-306" tabindex="-1"></a><span class="co">#&gt;  5     6     4     0  0.160      1 -0.321  51.7     1     0     0  1.39        1</span></span>
<span id="cb21-307"><a href="#cb21-307" tabindex="-1"></a><span class="co">#&gt;  6     6     5     0  0.0264     1 -0.321  52.7     0     0     0  1.47        0</span></span>
<span id="cb21-308"><a href="#cb21-308" tabindex="-1"></a><span class="co">#&gt;  7     6     6     0  0.0621     1 -0.321  53.7     1     0     0  1.56        0</span></span>
<span id="cb21-309"><a href="#cb21-309" tabindex="-1"></a><span class="co">#&gt;  8     6     7     0 -0.0225     1 -0.321  54.7     0     0     0  1.64        0</span></span>
<span id="cb21-310"><a href="#cb21-310" tabindex="-1"></a><span class="co">#&gt;  9     6     8     1 -1.45       1 -0.321  55.7     0     0     0  1.72        0</span></span>
<span id="cb21-311"><a href="#cb21-311" tabindex="-1"></a><span class="co">#&gt; 10     6     9     1 -0.959      1 -0.321  56.7     0     0     0  1.81        1</span></span>
<span id="cb21-312"><a href="#cb21-312" tabindex="-1"></a><span class="co">#&gt; 11     6    10     1  1.42       1 -0.321  57.7     0     1     0  1.89        0</span></span>
<span id="cb21-313"><a href="#cb21-313" tabindex="-1"></a><span class="co">#&gt; # ℹ 2 more variables: ever_eligible &lt;lgl&gt;, first_eligible_time &lt;dbl&gt;</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>dt.pp<span class="ot">=</span><span class="cn">NULL</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(prep_PP_data<span class="sc">$</span>data)) {</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(prep_PP_data<span class="sc">$</span>data[i]))</span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>  dt.pp <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dt.pp, tmp)</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>}</span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a>dt.pp<span class="ot">=</span>dt.pp<span class="sc">%&gt;%</span><span class="fu">mutate</span>(<span class="at">time=</span>trial_period<span class="sc">+</span>followup_time)<span class="sc">%&gt;%</span><span class="fu">arrange</span>(id,time)</span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a>ck<span class="ot">=</span>dt.pp[<span class="sc">!</span><span class="fu">duplicated</span>(dt.pp<span class="sc">%&gt;%</span><span class="fu">select</span>(id,time)),]</span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a>data_censored_simp_PP <span class="ot">&lt;-</span> simdata.one.trial <span class="sc">%&gt;%</span></span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> time <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">month =</span> time, <span class="at">event =</span> Y, <span class="at">LTFU =</span> C, <span class="at">treatment=</span>A, <span class="at">prev_treatment=</span>prev_A) <span class="sc">%&gt;%</span></span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>( id, month,assigned_treatment, treatment,prev_treatment, X1,X2,X3,X4,age_s,event,LTFU) </span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a><span class="co"># Extract each individual’s initial treatment</span></span>
<span id="cb22-17"><a href="#cb22-17" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> data_censored_simp_PP <span class="sc">%&gt;%</span></span>
<span id="cb22-18"><a href="#cb22-18" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb22-19"><a href="#cb22-19" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>()<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-20"><a href="#cb22-20" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">tx0 =</span> treatment) <span class="sc">%&gt;%</span></span>
<span id="cb22-21"><a href="#cb22-21" tabindex="-1"></a>  <span class="fu">select</span>(id, tx0)</span>
<span id="cb22-22"><a href="#cb22-22" tabindex="-1"></a>  </span>
<span id="cb22-23"><a href="#cb22-23" tabindex="-1"></a>data_censored_simp_PP2 <span class="ot">&lt;-</span> data_censored_simp_PP <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(tmp, <span class="at">by =</span> <span class="st">&quot;id&quot;</span>)</span>
<span id="cb22-24"><a href="#cb22-24" tabindex="-1"></a>data_censored_simp_PP3 <span class="ot">&lt;-</span> data_censored_simp_PP2 <span class="sc">%&gt;%</span><span class="fu">group_by</span>(id)<span class="sc">%&gt;%</span></span>
<span id="cb22-25"><a href="#cb22-25" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">adherence =</span> <span class="fu">ifelse</span>(treatment <span class="sc">==</span> tx0, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb22-26"><a href="#cb22-26" tabindex="-1"></a>         <span class="at">time_on_regime =</span> <span class="fu">cumsum</span>(adherence)<span class="sc">-</span><span class="dv">1</span>) <span class="co"># Minus 1 because baseline does not count</span></span>
<span id="cb22-27"><a href="#cb22-27" tabindex="-1"></a>data_censored_simp_PP4 <span class="ot">&lt;-</span> data_censored_simp_PP3 <span class="sc">%&gt;%</span></span>
<span id="cb22-28"><a href="#cb22-28" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">art_censored =</span> <span class="dv">1</span><span class="sc">-</span>adherence)  <span class="co"># Patients deviate from treatment assignment</span></span>
<span id="cb22-29"><a href="#cb22-29" tabindex="-1"></a>time.switch<span class="ot">=</span>  data_censored_simp_PP4 <span class="sc">%&gt;%</span><span class="fu">filter</span>(art_censored<span class="sc">==</span><span class="dv">1</span>)<span class="sc">%&gt;%</span><span class="fu">group_by</span>(id)<span class="sc">%&gt;%</span></span>
<span id="cb22-30"><a href="#cb22-30" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">t.switch=</span><span class="fu">min</span>(month))<span class="sc">%&gt;%</span><span class="fu">ungroup</span>() <span class="co"># First time they deviate</span></span>
<span id="cb22-31"><a href="#cb22-31" tabindex="-1"></a></span>
<span id="cb22-32"><a href="#cb22-32" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(trial_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb22-33"><a href="#cb22-33" tabindex="-1"></a>  <span class="fu">file.remove</span>(trial_files)</span>
<span id="cb22-34"><a href="#cb22-34" tabindex="-1"></a>}</span>
<span id="cb22-35"><a href="#cb22-35" tabindex="-1"></a></span>
<span id="cb22-36"><a href="#cb22-36" tabindex="-1"></a>data_censored_simp_PP5  <span class="ot">&lt;-</span> data_censored_simp_PP4 <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(time.switch, <span class="at">by =</span> <span class="st">&quot;id&quot;</span>) </span>
<span id="cb22-37"><a href="#cb22-37" tabindex="-1"></a> data_censored_simp_PP6<span class="ot">=</span>data_censored_simp_PP5<span class="sc">%&gt;%</span> <span class="fu">filter</span>(month<span class="sc">&lt;=</span>t.switch <span class="sc">|</span> <span class="fu">is.na</span>(t.switch)) <span class="co"># Keep the rows before deviating or no switch</span></span>
<span id="cb22-38"><a href="#cb22-38" tabindex="-1"></a></span>
<span id="cb22-39"><a href="#cb22-39" tabindex="-1"></a><span class="co"># Predict treatment adherence for those not treated in the previous period and assigned to control</span></span>
<span id="cb22-40"><a href="#cb22-40" tabindex="-1"></a>fit.adh.d0<span class="ot">=</span><span class="fu">glm</span>(treatment<span class="sc">~</span>X1<span class="sc">+</span>X2<span class="sc">+</span>X3<span class="sc">+</span>X4<span class="sc">+</span>age_s, <span class="at">data=</span>data_censored_simp_PP5<span class="sc">%&gt;%</span><span class="fu">filter</span>(prev_treatment<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> assigned_treatment<span class="sc">==</span><span class="dv">0</span>), <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>)</span>
<span id="cb22-41"><a href="#cb22-41" tabindex="-1"></a>fit.adh.d0</span>
<span id="cb22-42"><a href="#cb22-42" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb22-43"><a href="#cb22-43" tabindex="-1"></a><span class="co">#&gt; Call:  glm(formula = treatment ~ X1 + X2 + X3 + X4 + age_s, family = &quot;binomial&quot;, </span></span>
<span id="cb22-44"><a href="#cb22-44" tabindex="-1"></a><span class="co">#&gt;     data = data_censored_simp_PP5 %&gt;% filter(prev_treatment == </span></span>
<span id="cb22-45"><a href="#cb22-45" tabindex="-1"></a><span class="co">#&gt;         0 &amp; assigned_treatment == 0))</span></span>
<span id="cb22-46"><a href="#cb22-46" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb22-47"><a href="#cb22-47" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb22-48"><a href="#cb22-48" tabindex="-1"></a><span class="co">#&gt; (Intercept)           X1           X2           X3           X4        age_s  </span></span>
<span id="cb22-49"><a href="#cb22-49" tabindex="-1"></a><span class="co">#&gt;     -2.7854       0.5794       0.3266      -0.0584       0.9430       0.5586  </span></span>
<span id="cb22-50"><a href="#cb22-50" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb22-51"><a href="#cb22-51" tabindex="-1"></a><span class="co">#&gt; Degrees of Freedom: 877 Total (i.e. Null);  872 Residual</span></span>
<span id="cb22-52"><a href="#cb22-52" tabindex="-1"></a><span class="co">#&gt; Null Deviance:       646.9 </span></span>
<span id="cb22-53"><a href="#cb22-53" tabindex="-1"></a><span class="co">#&gt; Residual Deviance: 582.3     AIC: 594.3</span></span></code></pre></div>
<p>Now we create treatment adherence variable which is defined as
adhering to initial treatment every month and no contraindication is
allowed, i.e. once a subject deviates from the protocol, they are
considered non-adherent for the rest of the follow-up. We first create a
variable that indicates the initial treatment assignment at baseline.
Then we create an adherence variable that indicates if the subject is
adhering to the initial treatment assignment every month.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> data_censored_simp_PP <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>()<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">tx0 =</span> treatment) <span class="sc">%&gt;%</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>  <span class="fu">select</span>(id, tx0)</span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>  </span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>data_censored_simp_PP2 <span class="ot">&lt;-</span> data_censored_simp_PP <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(tmp, <span class="at">by =</span> <span class="st">&quot;id&quot;</span>)</span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>data_censored_simp_PP3 <span class="ot">&lt;-</span> data_censored_simp_PP2 <span class="sc">%&gt;%</span></span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">adherence =</span> <span class="fu">ifelse</span>(treatment <span class="sc">==</span> tx0, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a><span class="fu">View</span>(data_censored_simp_PP3)</span></code></pre></div>
<p>Next we create artificially censored variable assuming monotone
censoring that is defined as follows: once a subject deviates from the
protocol, they are considered artificially censored. Finally, we remove
the rows of data after deviating from the protocol. But we keep the row
of being artificially censored for estimating the adherence
probabilities. # remove the rows of data after deviating from the
protocol</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>data_censored_simp_PP4 <span class="ot">&lt;-</span> data_censored_simp_PP3 <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">art_censored =</span> <span class="dv">1</span><span class="sc">-</span>adherence)</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>  </span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>data_censored_simp_PP5  <span class="ot">&lt;-</span> data_censored_simp_PP4 <span class="sc">%&gt;%</span> </span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> </span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cum_art_censored =</span> <span class="fu">cumsum</span>(art_censored)) <span class="sc">%&gt;%</span> </span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>  <span class="fu">filter</span>(cum_art_censored <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">%&gt;%</span> <span class="co"># We keep the row of being artificially censored for estimating the adherence probabilities </span></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>cum_art_censored)</span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a><span class="fu">View</span>(data_censored_simp_PP5)</span></code></pre></div>
<p>This data is ready for per-protocol analysis.</p>
<p>Below we demostrate how to use the data_preparation() function in the
TrialEmulation R package to create the analysis-ready data set for ITT
analysis. data_preparation() function is a wrapper function that
prepares the data for target trial emulation. It takes the data in
person-time long format format and returns the data in person-trial-time
long format that is ready for “sequential trials” analysis described by
Hernan (ref). The function also estimates the treatment and censoring
weights for the analysis.</p>
</div>
<div id="case-iii-a-new-user-placebo-control-design-intention-to-treat-analysis-trialemulation" class="section level1">
<h1>Case III: A new-user, placebo control design; Intention-to-treat
analysis (TrialEmulation)</h1>
<p>We first try a simple case where censoring is assumed as random. We
specify the estimand type as “ITT” and we specify the outcome covariates
that are used to adjust for cofounding. The outcome covariates are the
baseline covariates that are selected based on domain knowledge and may
confound the treatment-outcome relationship. Since we assume censoring
is random, we do not specify the censoring model.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="fu">library</span>(TrialEmulation)</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="fu">data</span>(data_censored)</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="fu">View</span>(data_censored)</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>data_censored_ITT <span class="ot">&lt;-</span> <span class="fu">data_preparation</span>(data_censored, <span class="at">estimand_type =</span> <span class="st">&quot;ITT&quot;</span>, <span class="at">outcome_cov =</span> <span class="sc">~</span>x1<span class="sc">+</span>x2<span class="sc">+</span>x3<span class="sc">+</span>x4<span class="sc">+</span>age_s)</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a><span class="co">#&gt; Starting data manipulation</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="co">#&gt; Starting data extension</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a><span class="co">#&gt; Summary of extended data:</span></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="co">#&gt; Number of observations: 1558</span></span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a><span class="co">#&gt; ------------------------------------------------------------</span></span></code></pre></div>
<p>Now let’s check the expanded data.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>data_censored_ITT<span class="sc">$</span>min_period</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>data_censored_ITT<span class="sc">$</span>max_period <span class="co"># A sequence of 20 trials</span></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a><span class="co">#&gt; [1] 19</span></span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a><span class="co"># total number of subjects in the expanded data </span></span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>data_censored_ITT<span class="sc">$</span>N</span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a><span class="co">#&gt; [1] 1558</span></span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a><span class="co"># expanded data </span></span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a>data_censored_ITT_dat <span class="ot">&lt;-</span> data_censored_ITT<span class="sc">$</span>data</span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a><span class="fu">View</span>(data_censored_ITT_dat)</span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a></span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a>data_censored_ITT_dat_id2 <span class="ot">&lt;-</span> data_censored_ITT_dat <span class="sc">%&gt;%</span> </span>
<span id="cb26-15"><a href="#cb26-15" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-16"><a href="#cb26-16" tabindex="-1"></a>  <span class="fu">arrange</span>(id, trial_period, followup_time)</span>
<span id="cb26-17"><a href="#cb26-17" tabindex="-1"></a><span class="fu">View</span>(data_censored_ITT_dat_id2)</span>
<span id="cb26-18"><a href="#cb26-18" tabindex="-1"></a></span>
<span id="cb26-19"><a href="#cb26-19" tabindex="-1"></a>data_censored_ITT_dat_id4 <span class="ot">&lt;-</span> data_censored_ITT_dat <span class="sc">%&gt;%</span> </span>
<span id="cb26-20"><a href="#cb26-20" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">==</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-21"><a href="#cb26-21" tabindex="-1"></a>  <span class="fu">arrange</span>(id, trial_period, followup_time)</span>
<span id="cb26-22"><a href="#cb26-22" tabindex="-1"></a><span class="fu">View</span>(data_censored_ITT_dat_id4)</span></code></pre></div>
<p>Now we assume that censoring is not random and is dependent on a list
of covariates. We can direct data_preparation() to fit the censoring
model and use the estimated censoring weights in the analysis.
Specifically, we specify variables for the denominator model cense_d_cov
and the numeric model cense_n_cov. The variables in the denominator
model include baseline variables and time-varying variables. The
variables in the numerator model include the baseline variables. This
way, the stabilized IPW is estimated. If unstablized IPWis desired, then
simply specify cense_n_cov = ~ 1.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>data_censored_ITT2 <span class="ot">&lt;-</span> <span class="fu">data_preparation</span>(data_censored, <span class="at">estimand_type =</span> <span class="st">&quot;ITT&quot;</span>, <span class="at">outcome_cov =</span> <span class="sc">~</span>x1<span class="sc">+</span>x2<span class="sc">+</span>x3<span class="sc">+</span>x4<span class="sc">+</span>age_s,</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>                                       <span class="at">use_censor_weights =</span> <span class="cn">TRUE</span>, <span class="at">cense =</span> <span class="st">&quot;censored&quot;</span>, <span class="co"># censoring indicator variable in the dataset</span></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a>                                       <span class="at">cense_d_cov =</span> <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3 <span class="sc">+</span> x4 <span class="sc">+</span> age_s, <span class="co"># Denominator model includes both baseline and time-varying covariates.</span></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a>                                       <span class="at">cense_n_cov =</span> <span class="sc">~</span> x3 <span class="sc">+</span> x4, <span class="co"># Numerator model includes only baseline covariates.</span></span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a>                                       <span class="at">pool_cense =</span> <span class="st">&quot;numerator&quot;</span>, <span class="co"># does not allow the numerator model to be fitted separately for the treatment groups</span></span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a>                                       <span class="at">glm_function =</span> <span class="st">&quot;parglm&quot;</span>, <span class="at">nthreads =</span> <span class="dv">4</span>, <span class="at">method =</span> <span class="st">&quot;FAST&quot;</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a>data_censored_ITT2<span class="sc">$</span>censor_models</span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a><span class="co">#&gt; $cens_d0</span></span>
<span id="cb27-10"><a href="#cb27-10" tabindex="-1"></a><span class="co">#&gt; Model for P(cense = 0 | X, previous treatment = 0) for denominator </span></span>
<span id="cb27-11"><a href="#cb27-11" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb27-12"><a href="#cb27-12" tabindex="-1"></a><span class="co">#&gt;         term   estimate std.error  statistic      p.value</span></span>
<span id="cb27-13"><a href="#cb27-13" tabindex="-1"></a><span class="co">#&gt;  (Intercept)  1.1711078 0.3237499  3.6173225 2.976663e-04</span></span>
<span id="cb27-14"><a href="#cb27-14" tabindex="-1"></a><span class="co">#&gt;           x1  0.8894661 0.3959247  2.2465535 2.466858e-02</span></span>
<span id="cb27-15"><a href="#cb27-15" tabindex="-1"></a><span class="co">#&gt;           x2 -0.8916975 0.2155173 -4.1374761 3.511471e-05</span></span>
<span id="cb27-16"><a href="#cb27-16" tabindex="-1"></a><span class="co">#&gt;           x3 -0.3601528 0.3842799 -0.9372148 3.486481e-01</span></span>
<span id="cb27-17"><a href="#cb27-17" tabindex="-1"></a><span class="co">#&gt;           x4 -0.3068672 0.1921708 -1.5968463 1.103000e-01</span></span>
<span id="cb27-18"><a href="#cb27-18" tabindex="-1"></a><span class="co">#&gt;        age_s  1.3706745 0.2279017  6.0143243 1.806385e-09</span></span>
<span id="cb27-19"><a href="#cb27-19" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb27-20"><a href="#cb27-20" tabindex="-1"></a><span class="co">#&gt;  null.deviance df.null    logLik      AIC      BIC deviance df.residual nobs</span></span>
<span id="cb27-21"><a href="#cb27-21" tabindex="-1"></a><span class="co">#&gt;       283.0723     425 -96.46007 204.9201 229.2468 192.9201         420  426</span></span>
<span id="cb27-22"><a href="#cb27-22" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb27-23"><a href="#cb27-23" tabindex="-1"></a><span class="co">#&gt; $cens_d1</span></span>
<span id="cb27-24"><a href="#cb27-24" tabindex="-1"></a><span class="co">#&gt; Model for P(cense = 0 | X, previous treatment = 1) for denominator </span></span>
<span id="cb27-25"><a href="#cb27-25" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb27-26"><a href="#cb27-26" tabindex="-1"></a><span class="co">#&gt;         term   estimate std.error  statistic      p.value</span></span>
<span id="cb27-27"><a href="#cb27-27" tabindex="-1"></a><span class="co">#&gt;  (Intercept)  1.8585422 0.4482425  4.1462873 3.379098e-05</span></span>
<span id="cb27-28"><a href="#cb27-28" tabindex="-1"></a><span class="co">#&gt;           x1  0.9488075 0.8076645  1.1747544 2.400930e-01</span></span>
<span id="cb27-29"><a href="#cb27-29" tabindex="-1"></a><span class="co">#&gt;           x2 -0.1014577 0.3008652 -0.3372199 7.359512e-01</span></span>
<span id="cb27-30"><a href="#cb27-30" tabindex="-1"></a><span class="co">#&gt;           x3  1.4788555 0.6408347  2.3077020 2.101572e-02</span></span>
<span id="cb27-31"><a href="#cb27-31" tabindex="-1"></a><span class="co">#&gt;           x4 -0.6532912 0.3336118 -1.9582374 5.020217e-02</span></span>
<span id="cb27-32"><a href="#cb27-32" tabindex="-1"></a><span class="co">#&gt;        age_s  0.8717044 0.3704446  2.3531304 1.861610e-02</span></span>
<span id="cb27-33"><a href="#cb27-33" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb27-34"><a href="#cb27-34" tabindex="-1"></a><span class="co">#&gt;  null.deviance df.null    logLik      AIC      BIC deviance df.residual nobs</span></span>
<span id="cb27-35"><a href="#cb27-35" tabindex="-1"></a><span class="co">#&gt;       113.0528     298 -48.03073 108.0615 130.2641 96.06146         293  299</span></span>
<span id="cb27-36"><a href="#cb27-36" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb27-37"><a href="#cb27-37" tabindex="-1"></a><span class="co">#&gt; $cens_pool_n</span></span>
<span id="cb27-38"><a href="#cb27-38" tabindex="-1"></a><span class="co">#&gt; Model for P(cense = 0 | X) for numerator </span></span>
<span id="cb27-39"><a href="#cb27-39" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb27-40"><a href="#cb27-40" tabindex="-1"></a><span class="co">#&gt;         term    estimate std.error  statistic      p.value</span></span>
<span id="cb27-41"><a href="#cb27-41" tabindex="-1"></a><span class="co">#&gt;  (Intercept)  2.37772009 0.1984882 11.9791508 4.569804e-33</span></span>
<span id="cb27-42"><a href="#cb27-42" tabindex="-1"></a><span class="co">#&gt;           x3  0.06530091 0.2819587  0.2315974 8.168507e-01</span></span>
<span id="cb27-43"><a href="#cb27-43" tabindex="-1"></a><span class="co">#&gt;           x4 -0.53488417 0.1479895 -3.6143375 3.011167e-04</span></span>
<span id="cb27-44"><a href="#cb27-44" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb27-45"><a href="#cb27-45" tabindex="-1"></a><span class="co">#&gt;  null.deviance df.null   logLik     AIC      BIC deviance df.residual nobs</span></span>
<span id="cb27-46"><a href="#cb27-46" tabindex="-1"></a><span class="co">#&gt;       404.2156     724 -195.136 396.272 410.0305  390.272         722  725</span></span></code></pre></div>
</div>
<div id="case-iv-a-new-user-placebo-control-design-per-protocol-analysis" class="section level1">
<h1>Case IV: A new-user, placebo control design; Per-protocol
analysis</h1>
<p>Data_preparation() can also create an analysis-ready data set for
per-protocol analysis. We specify the estimand type as “PP”. Besides
what we specified for the ITT analysis as above, we here also need to
specify the models to calculate treatment weight. The switch_d_cov
variables include baseline variables and time-varying variables. The
switch_n_cov variables include the baseline variables. Both models can
also include time_on_regime and its s quadratic term to account for the
time-varying treatment adherence. The pool_cense argument is set to
“none” to allow the numerator and denominator models to be fitted
separately for the treatment groups.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="fu">library</span>(TrialEmulation)</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a><span class="fu">data</span>(data_censored)</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a><span class="fu">View</span>(data_censored)</span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a><span class="co"># Expand data using data_preparation </span></span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>data_censored_PP <span class="ot">&lt;-</span> <span class="fu">data_preparation</span>(data_censored, <span class="at">estimand_type =</span> <span class="st">&quot;PP&quot;</span>, <span class="at">outcome_cov =</span> <span class="sc">~</span>x1<span class="sc">+</span>x2<span class="sc">+</span>x3<span class="sc">+</span>x4<span class="sc">+</span>age_s,</span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>                                     <span class="co"># Denominator model for treatment switching: baseline + time-varying covariates + time_on_regime</span></span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a>                                     <span class="at">switch_d_cov =</span> <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3 <span class="sc">+</span> x4 <span class="sc">+</span> age_s <span class="sc">+</span> time_on_regime <span class="sc">+</span> <span class="fu">I</span>(time_on_regime<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a>                                     <span class="at">switch_n_cov =</span> <span class="sc">~</span> x3 <span class="sc">+</span> x4 <span class="sc">+</span> time_on_regime <span class="sc">+</span> <span class="fu">I</span>(time_on_regime<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a>                                     <span class="co"># Numerator model for treatment switching: baseline covariates + time-on-regime terms</span></span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a>                                     <span class="at">use_censor_weights =</span> <span class="cn">TRUE</span>, <span class="at">cense =</span> <span class="st">&quot;censored&quot;</span>, </span>
<span id="cb28-12"><a href="#cb28-12" tabindex="-1"></a>                                     <span class="at">cense_d_cov =</span> <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3 <span class="sc">+</span> x4 <span class="sc">+</span> age_s, <span class="at">cense_n_cov =</span> <span class="sc">~</span> x3 <span class="sc">+</span> x4,</span>
<span id="cb28-13"><a href="#cb28-13" tabindex="-1"></a>                                     <span class="at">pool_cense =</span> <span class="st">&quot;none&quot;</span>, <span class="co"># Separate censoring models for each treatment group</span></span>
<span id="cb28-14"><a href="#cb28-14" tabindex="-1"></a>                                     <span class="at">glm_function =</span> <span class="st">&quot;parglm&quot;</span>, <span class="at">nthreads =</span> <span class="dv">4</span>, <span class="at">method =</span> <span class="st">&quot;FAST&quot;</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-15"><a href="#cb28-15" tabindex="-1"></a>data_censored_PP<span class="sc">$</span>min_period</span>
<span id="cb28-16"><a href="#cb28-16" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb28-17"><a href="#cb28-17" tabindex="-1"></a>data_censored_PP<span class="sc">$</span>max_period <span class="co"># A sequence of 19 trials</span></span>
<span id="cb28-18"><a href="#cb28-18" tabindex="-1"></a><span class="co">#&gt; [1] 18</span></span>
<span id="cb28-19"><a href="#cb28-19" tabindex="-1"></a></span>
<span id="cb28-20"><a href="#cb28-20" tabindex="-1"></a><span class="co"># total number of subjects in the expanded data </span></span>
<span id="cb28-21"><a href="#cb28-21" tabindex="-1"></a>data_censored_PP<span class="sc">$</span>N  </span>
<span id="cb28-22"><a href="#cb28-22" tabindex="-1"></a><span class="co">#&gt; [1] 500</span></span>
<span id="cb28-23"><a href="#cb28-23" tabindex="-1"></a></span>
<span id="cb28-24"><a href="#cb28-24" tabindex="-1"></a><span class="co"># expanded data </span></span>
<span id="cb28-25"><a href="#cb28-25" tabindex="-1"></a>data_censored_PP_dat <span class="ot">&lt;-</span> data_censored_PP<span class="sc">$</span>data</span>
<span id="cb28-26"><a href="#cb28-26" tabindex="-1"></a></span>
<span id="cb28-27"><a href="#cb28-27" tabindex="-1"></a>data_censored_PP_dat_id2 <span class="ot">&lt;-</span> data_censored_PP_dat <span class="sc">%&gt;%</span> </span>
<span id="cb28-28"><a href="#cb28-28" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">==</span> <span class="dv">2</span>)</span>
<span id="cb28-29"><a href="#cb28-29" tabindex="-1"></a><span class="fu">View</span>(data_censored_PP_dat_id2)</span>
<span id="cb28-30"><a href="#cb28-30" tabindex="-1"></a></span>
<span id="cb28-31"><a href="#cb28-31" tabindex="-1"></a>data_censored_PP_dat_id4 <span class="ot">&lt;-</span> data_censored_PP_dat <span class="sc">%&gt;%</span> </span>
<span id="cb28-32"><a href="#cb28-32" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">==</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-33"><a href="#cb28-33" tabindex="-1"></a>  <span class="fu">arrange</span>(id, trial_period, followup_time)</span>
<span id="cb28-34"><a href="#cb28-34" tabindex="-1"></a><span class="fu">View</span>(data_censored_PP_dat_id4)</span></code></pre></div>
<p>Now let’s explore the censoring and treatment models and demonstrate
how they are used to create the weights. We save the weighting models in
working_dir and import them to make predictions later.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="co"># working_dir &lt;- &quot;/Users/kevinying/TTEvignette&quot;</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>trial_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> working_dir, <span class="at">pattern =</span> <span class="st">&quot;^trial_.*</span><span class="sc">\\</span><span class="st">.csv$&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(trial_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>  <span class="fu">file.remove</span>(trial_files)</span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a>}</span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a><span class="co">#&gt;  [1] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE</span></span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a><span class="co">#&gt; [16] TRUE TRUE TRUE</span></span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a>data_censored_PP <span class="ot">&lt;-</span> <span class="fu">data_preparation</span>(data_censored, <span class="at">estimand_type =</span> <span class="st">&quot;PP&quot;</span>, <span class="at">outcome_cov =</span> <span class="sc">~</span>x1<span class="sc">+</span>x2<span class="sc">+</span>x3<span class="sc">+</span>x4<span class="sc">+</span>age_s,</span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a>                                     <span class="at">switch_d_cov =</span> <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3 <span class="sc">+</span> x4 <span class="sc">+</span> age_s <span class="sc">+</span> time_on_regime <span class="sc">+</span> <span class="fu">I</span>(time_on_regime<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a>                                     <span class="at">switch_n_cov =</span> <span class="sc">~</span> x3 <span class="sc">+</span> x4 <span class="sc">+</span> time_on_regime <span class="sc">+</span> <span class="fu">I</span>(time_on_regime<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a>                                     <span class="at">use_censor_weights =</span> <span class="cn">TRUE</span>, <span class="at">cense =</span> <span class="st">&quot;censored&quot;</span>, </span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a>                                     <span class="at">cense_d_cov =</span> <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3 <span class="sc">+</span> x4 <span class="sc">+</span> age_s, <span class="at">cense_n_cov =</span> <span class="sc">~</span> x3 <span class="sc">+</span> x4,</span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a>                                     <span class="at">pool_cense =</span> <span class="st">&quot;none&quot;</span>, </span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a>                                     <span class="at">data_dir =</span> working_dir, <span class="at">save_weight_models =</span> <span class="cn">TRUE</span>,</span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a>                                     <span class="at">glm_function =</span> <span class="st">&quot;parglm&quot;</span>, <span class="at">nthreads =</span> <span class="dv">4</span>, <span class="at">method =</span> <span class="st">&quot;FAST&quot;</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-18"><a href="#cb29-18" tabindex="-1"></a><span class="co"># View(data_censored_PP$data)</span></span>
<span id="cb29-19"><a href="#cb29-19" tabindex="-1"></a><span class="co"># Note only baseline values of the time-varying variables are kept in the data set for downstream marginal structural models </span></span>
<span id="cb29-20"><a href="#cb29-20" tabindex="-1"></a><span class="co"># The row of being artificially censored are not included </span></span>
<span id="cb29-21"><a href="#cb29-21" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" tabindex="-1"></a><span class="co"># load the saved models </span></span>
<span id="cb29-23"><a href="#cb29-23" tabindex="-1"></a>weight_model_switch_d0 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;weight_model_switch_d0.rds&quot;</span>)</span>
<span id="cb29-24"><a href="#cb29-24" tabindex="-1"></a>weight_model_switch_d1 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;weight_model_switch_d1.rds&quot;</span>)</span>
<span id="cb29-25"><a href="#cb29-25" tabindex="-1"></a>weight_model_switch_n0 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;weight_model_switch_n0.rds&quot;</span>)</span>
<span id="cb29-26"><a href="#cb29-26" tabindex="-1"></a>weight_model_switch_n1 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;weight_model_switch_n1.rds&quot;</span>)</span>
<span id="cb29-27"><a href="#cb29-27" tabindex="-1"></a></span>
<span id="cb29-28"><a href="#cb29-28" tabindex="-1"></a>cense_model_d0 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;cense_model_d0.rds&quot;</span>)</span>
<span id="cb29-29"><a href="#cb29-29" tabindex="-1"></a>cense_model_d1 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;cense_model_d1.rds&quot;</span>)</span>
<span id="cb29-30"><a href="#cb29-30" tabindex="-1"></a>cense_model_n0 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;cense_model_n0.rds&quot;</span>)</span>
<span id="cb29-31"><a href="#cb29-31" tabindex="-1"></a>cense_model_n1 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;cense_model_n1.rds&quot;</span>)</span></code></pre></div>
<p>Next we prepare the data set for making predictions. For simplicity,
we only look at trial period zero for now. Because the weighting models
include time_on_regime and its quadratic term, we need to create the
time_on_regime variable. The time_on_regime variable is defined as the
cumulative adherence to the assigned treatment minus one at baseline. We
also create the followup_time2 variable that is used to match the data
with the censoring model. The followup_time2 variable is defined as the
followup_time plus trial_period.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>tmp_dat <span class="ot">&lt;-</span> data_censored_PP<span class="sc">$</span>data <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>  <span class="fu">group_by</span>(id, trial_period) <span class="sc">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">adherence =</span> <span class="fu">ifelse</span>(treatment <span class="sc">==</span> assigned_treatment, <span class="dv">1</span>, <span class="dv">0</span>), <span class="co"># in the cleaned PP data set, this adherence = 1 everywhere</span></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>         <span class="at">time_on_regime =</span> <span class="fu">cumsum</span>(adherence)<span class="sc">-</span><span class="dv">1</span>,  <span class="co"># -1 to not account the one at baseline </span></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a>         <span class="at">followup_time2 =</span> followup_time<span class="sc">+</span>trial_period) <span class="sc">%&gt;%</span></span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(x1, x2, age_s)) <span class="sc">%&gt;%</span> </span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a>  <span class="fu">filter</span>(trial_period <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a>data_censored_tmp <span class="ot">&lt;-</span> data_censored <span class="sc">%&gt;%</span></span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">followup_time2 =</span> period) <span class="sc">%&gt;%</span></span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a>  <span class="fu">select</span>(id, followup_time2, x1, x2, age_s)</span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" tabindex="-1"></a>tmp_dat2 <span class="ot">&lt;-</span> tmp_dat <span class="sc">%&gt;%</span> </span>
<span id="cb30-14"><a href="#cb30-14" tabindex="-1"></a>  <span class="fu">left_join</span>(data_censored_tmp, <span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;followup_time2&quot;</span>))<span class="sc">%&gt;%</span></span>
<span id="cb30-15"><a href="#cb30-15" tabindex="-1"></a>  <span class="fu">arrange</span>(id, trial_period, followup_time)</span></code></pre></div>
<p>Finally we make the predictions and create the weights. Since we fit
separate models for control and treatment arms,we need to make the
prediction seperately.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a></span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a><span class="co"># for control arm</span></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a>ctl_dat <span class="ot">&lt;-</span> tmp_dat2 <span class="sc">%&gt;%</span></span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a>  <span class="fu">filter</span>(assigned_treatment <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a><span class="co"># probabilities of receiving treatment = 1 at each month </span></span>
<span id="cb31-7"><a href="#cb31-7" tabindex="-1"></a>weight_switch_d0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(weight_model_switch_d0, <span class="at">newdata =</span> ctl_dat, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb31-8"><a href="#cb31-8" tabindex="-1"></a>weight_switch_n0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(weight_model_switch_n0, <span class="at">newdata =</span> ctl_dat, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb31-9"><a href="#cb31-9" tabindex="-1"></a>switch_ctl <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>weight_switch_n0)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>weight_switch_d0) <span class="co"># 1-prob(tx = 1) = prob(tx = 0)</span></span>
<span id="cb31-10"><a href="#cb31-10" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" tabindex="-1"></a>cense_d0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(cense_model_d0, <span class="at">newdata =</span> ctl_dat, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb31-12"><a href="#cb31-12" tabindex="-1"></a>cense_n0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(cense_model_n0, <span class="at">newdata =</span> ctl_dat, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb31-13"><a href="#cb31-13" tabindex="-1"></a>cense_ctl <span class="ot">&lt;-</span> cense_n0<span class="sc">/</span>cense_d0</span>
<span id="cb31-14"><a href="#cb31-14" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" tabindex="-1"></a>ctl_dat2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(ctl_dat, switch_ctl, cense_ctl) <span class="sc">%&gt;%</span></span>
<span id="cb31-16"><a href="#cb31-16" tabindex="-1"></a>  <span class="fu">group_by</span>(id, trial_period) <span class="sc">%&gt;%</span></span>
<span id="cb31-17"><a href="#cb31-17" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prod_w =</span> switch_ctl<span class="sc">*</span>cense_ctl,</span>
<span id="cb31-18"><a href="#cb31-18" tabindex="-1"></a>         <span class="at">prod_w_new =</span> <span class="fu">case_when</span>(followup_time <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">1</span>, <span class="co"># assuming no one is censored or non-adherent at baseline</span></span>
<span id="cb31-19"><a href="#cb31-19" tabindex="-1"></a>                                <span class="cn">TRUE</span> <span class="sc">~</span> prod_w),</span>
<span id="cb31-20"><a href="#cb31-20" tabindex="-1"></a>         <span class="at">cum_prod_w =</span> <span class="fu">cumprod</span>(prod_w_new))</span>
<span id="cb31-21"><a href="#cb31-21" tabindex="-1"></a></span>
<span id="cb31-22"><a href="#cb31-22" tabindex="-1"></a><span class="fu">View</span>(ctl_dat2[, <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;trial_period&quot;</span>, <span class="st">&quot;followup_time&quot;</span>, <span class="st">&quot;weight&quot;</span>, <span class="st">&quot;cum_prod_w&quot;</span>)])</span>
<span id="cb31-23"><a href="#cb31-23" tabindex="-1"></a></span>
<span id="cb31-24"><a href="#cb31-24" tabindex="-1"></a></span>
<span id="cb31-25"><a href="#cb31-25" tabindex="-1"></a><span class="co"># for treatment arm </span></span>
<span id="cb31-26"><a href="#cb31-26" tabindex="-1"></a>trt_dat <span class="ot">&lt;-</span> tmp_dat2 <span class="sc">%&gt;%</span></span>
<span id="cb31-27"><a href="#cb31-27" tabindex="-1"></a>  <span class="fu">filter</span>(assigned_treatment <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb31-28"><a href="#cb31-28" tabindex="-1"></a></span>
<span id="cb31-29"><a href="#cb31-29" tabindex="-1"></a>weight_switch_d1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(weight_model_switch_d1, <span class="at">newdata =</span> trt_dat, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb31-30"><a href="#cb31-30" tabindex="-1"></a>weight_switch_n1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(weight_model_switch_n1, <span class="at">newdata =</span> trt_dat, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb31-31"><a href="#cb31-31" tabindex="-1"></a>switch_trt <span class="ot">&lt;-</span> weight_switch_n1<span class="sc">/</span>weight_switch_d1</span>
<span id="cb31-32"><a href="#cb31-32" tabindex="-1"></a></span>
<span id="cb31-33"><a href="#cb31-33" tabindex="-1"></a>cense_d1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(cense_model_d1, <span class="at">newdata =</span> trt_dat, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb31-34"><a href="#cb31-34" tabindex="-1"></a>cense_n1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(cense_model_n1, <span class="at">newdata =</span> trt_dat, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb31-35"><a href="#cb31-35" tabindex="-1"></a>cense_trt <span class="ot">&lt;-</span> cense_n1<span class="sc">/</span>cense_d1</span>
<span id="cb31-36"><a href="#cb31-36" tabindex="-1"></a></span>
<span id="cb31-37"><a href="#cb31-37" tabindex="-1"></a>trt_dat2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(trt_dat, switch_trt, cense_trt) <span class="sc">%&gt;%</span></span>
<span id="cb31-38"><a href="#cb31-38" tabindex="-1"></a>  <span class="fu">group_by</span>(id, trial_period) <span class="sc">%&gt;%</span></span>
<span id="cb31-39"><a href="#cb31-39" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prod_w =</span> switch_trt<span class="sc">*</span>cense_trt,</span>
<span id="cb31-40"><a href="#cb31-40" tabindex="-1"></a>         <span class="at">prod_w_new =</span> <span class="fu">case_when</span>(followup_time <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb31-41"><a href="#cb31-41" tabindex="-1"></a>                                <span class="cn">TRUE</span> <span class="sc">~</span> prod_w),</span>
<span id="cb31-42"><a href="#cb31-42" tabindex="-1"></a>         <span class="at">cum_prod_w =</span> <span class="fu">cumprod</span>(prod_w_new))</span>
<span id="cb31-43"><a href="#cb31-43" tabindex="-1"></a></span>
<span id="cb31-44"><a href="#cb31-44" tabindex="-1"></a><span class="fu">View</span>(trt_dat2[, <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;trial_period&quot;</span>, <span class="st">&quot;followup_time&quot;</span>, <span class="st">&quot;weight&quot;</span>, <span class="st">&quot;cum_prod_w&quot;</span>)])</span></code></pre></div>
</div>
<div id="inconsistent-component" class="section level1">
<h1>inconsistent component</h1>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a>ctl_dat3 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(ctl_dat, switch_ctl, cense_ctl) <span class="sc">%&gt;%</span></span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>  <span class="fu">group_by</span>(id, trial_period) <span class="sc">%&gt;%</span></span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cense_ctl_new =</span> <span class="fu">case_when</span>(followup_time <span class="sc">==</span> <span class="fu">max</span>(followup_time) <span class="sc">~</span> <span class="dv">1</span>, <span class="co"># At the last time point, the patient is not censored, censoring weight is set to 1.</span></span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a>                                <span class="cn">TRUE</span> <span class="sc">~</span> cense_ctl),</span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a>         <span class="at">switch_ctl_new =</span> <span class="fu">case_when</span>(followup_time <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">1</span>, <span class="co"># At the first time point, the patient has not switched, switching weight is set to 1.</span></span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a>                                <span class="cn">TRUE</span> <span class="sc">~</span> switch_ctl),</span>
<span id="cb32-7"><a href="#cb32-7" tabindex="-1"></a>         <span class="at">prod_w =</span> switch_ctl_new<span class="sc">*</span>cense_ctl_new,</span>
<span id="cb32-8"><a href="#cb32-8" tabindex="-1"></a>         <span class="at">cum_prod_w =</span> <span class="fu">cumprod</span>(prod_w))</span>
<span id="cb32-9"><a href="#cb32-9" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" tabindex="-1"></a><span class="fu">View</span>(ctl_dat3[, <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;trial_period&quot;</span>, <span class="st">&quot;followup_time&quot;</span>,<span class="st">&quot;cense_ctl&quot;</span>, <span class="st">&quot;cense_ctl_new&quot;</span>, <span class="st">&quot;switch_ctl&quot;</span>, <span class="st">&quot;switch_ctl_new&quot;</span>, <span class="st">&quot;weight&quot;</span>, <span class="st">&quot;cum_prod_w&quot;</span>)])</span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
