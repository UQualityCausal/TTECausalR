<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Kevin Ying, Peirong Hao, Yizhe Xu" />

<meta name="date" content="2025-07-21" />

<title>A new-user, active comparator design; Intention-to-treat analysis</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">A new-user, active comparator design;
Intention-to-treat analysis</h1>
<h4 class="author">Kevin Ying, Peirong Hao, Yizhe Xu</h4>
<h4 class="date">2025-07-21</h4>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  <span class="at">collapse =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>  <span class="at">comment =</span> <span class="st">&quot;#&gt;&quot;</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2009</span>)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="fu">options</span>(<span class="at">warn =</span> <span class="sc">-</span><span class="dv">1</span>)</span></code></pre></div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>##Peirong, add an introduction to A new-user, active comparator
design; Intention-to-treat analysis</p>
</div>
<div id="load-packages" class="section level1">
<h1>Load packages</h1>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">library</span>(TrialEmulation)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="fu">library</span>(survminer)</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;R/generate observed data.R&quot;</span>)</span></code></pre></div>
<p>Simulate data</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Set seed</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">412</span>)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co">#simulate data</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>simdata0<span class="ot">=</span><span class="fu">generate.obs.data</span>(<span class="at">n=</span><span class="dv">1000</span>,<span class="at">J=</span><span class="dv">20</span>,<span class="at">beta0.trt0=</span><span class="dv">1</span>,<span class="at">beta.adherence=</span><span class="dv">2</span>, <span class="at">beta0.outcome=</span><span class="sc">-</span><span class="dv">5</span>, <span class="at">beta.trt.effect=</span><span class="sc">-</span><span class="fl">1.2</span>, <span class="at">beta0.censoring=</span><span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(id)`</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>simdata<span class="ot">=</span>simdata0<span class="sc">%&gt;%</span><span class="fu">select</span>(id, time, X1, X2, X3, X4, age, A, Y, C) </span></code></pre></div>
<p>Now we start to create a analysis-ready from the simulated data. We
will emulate a randomized clinic trial described below. Add a table here
to describe the trial design.</p>
<p>First, we create an eligible indicator. Our inclusion criteria are:
1)age &gt;=50, 2)no history of Y by current time, and 3)no treatment in
previous 2 years of current time</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>simdata <span class="ot">&lt;-</span> simdata <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">eligible =</span> <span class="fu">as.integer</span>(age <span class="sc">&gt;=</span> <span class="dv">50</span> <span class="sc">&amp;</span> <span class="fu">cumsum</span>(Y) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> (<span class="fu">lag</span>(A)<span class="sc">+</span><span class="fu">lag</span>(A,<span class="dv">2</span>)) <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code></pre></div>
<p>Let’s take a look on a sample.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>simdata<span class="sc">%&gt;%</span><span class="fu">filter</span>(id<span class="sc">==</span><span class="dv">2</span>)</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="co">#&gt; # A tibble: 20 × 11</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co">#&gt;       id  time    X1      X2    X3    X4   age     A     Y     C eligible</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;int&gt;</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co">#&gt;  1     2     0     1  0.177      1 0.654  43.7     1     0     0        0</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co">#&gt;  2     2     1     1 -0.0711     1 0.654  44.7     1     0     0        0</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="co">#&gt;  3     2     2     0 -0.363      1 0.654  45.7     1     0     0        0</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="co">#&gt;  4     2     3     0 -1.27       1 0.654  46.7     1     0     0        0</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="co">#&gt;  5     2     4     0  0.387      1 0.654  47.7     1     0     0        0</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="co">#&gt;  6     2     5     0 -1.96       1 0.654  48.7     1     0     0        0</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="co">#&gt;  7     2     6     1  1.20       1 0.654  49.7     1     0     0        0</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a><span class="co">#&gt;  8     2     7     0  0.960      1 0.654  50.7     1     0     0        0</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="co">#&gt;  9     2     8     0 -0.624      1 0.654  51.7     0     0     0        0</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a><span class="co">#&gt; 10     2     9     1  1.36       1 0.654  52.7     0     0     0        0</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="co">#&gt; 11     2    10     0 -0.893      1 0.654  53.7     0     0     0        1</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a><span class="co">#&gt; 12     2    11     1 -0.0871     1 0.654  54.7     0     0     0        1</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a><span class="co">#&gt; 13     2    12     0 -0.752      1 0.654  55.7     0     0     0        1</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a><span class="co">#&gt; 14     2    13     1 -0.142      1 0.654  56.7     1     0     0        1</span></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a><span class="co">#&gt; 15     2    14     1 -0.0428     1 0.654  57.7     1     0     0        0</span></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a><span class="co">#&gt; 16     2    15     0  0.965      1 0.654  58.7     1     0     0        0</span></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a><span class="co">#&gt; 17     2    16     0  0.887      1 0.654  59.7     1     0     0        0</span></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a><span class="co">#&gt; 18     2    17     1  0.0558     1 0.654  60.7     1     0     0        0</span></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a><span class="co">#&gt; 19     2    18     1  0.327      1 0.654  61.7     1     0     0        0</span></span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a><span class="co">#&gt; 20     2    19     0 -0.0961     1 0.654  62.7     0     0     0        0</span></span></code></pre></div>
<p>We can see that:<br />
At time 0 through 6, his age is below 50 and so e is not eligible for
the study. At time 7 through 9, his age is over 50 and he has no history
of Y but he has treatment within previous 2 years, so he is not
eligible. At time 10 through 13, his age is 50 and he has no history of
Y and no treatment in previous 2 years, so he is eligible. At time 14
and after, he has treatment in previous 2 years, so he is not eligible.
Now we identify the subjects who are eligible ever and the first time
they are eligible</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>eligible_info <span class="ot">&lt;-</span> simdata <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">first_eligible_time =</span> <span class="fu">min</span>(time[eligible <span class="sc">==</span> <span class="dv">1</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>            <span class="at">ever_eligible =</span> <span class="fu">any</span>(eligible <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code></pre></div>
<p>How many ever eligible?</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">table</span>(eligible_info<span class="sc">$</span>ever_eligible)</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co">#&gt; FALSE  TRUE </span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="co">#&gt;   737   232</span></span></code></pre></div>
<p>Check a few of them.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>eligible_info <span class="sc">%&gt;%</span> <span class="fu">filter</span>(id <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3 × 3</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="co">#&gt;      id first_eligible_time ever_eligible</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co">#&gt;   &lt;dbl&gt;               &lt;dbl&gt; &lt;lgl&gt;        </span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="co">#&gt; 1     1                 Inf FALSE        </span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="co">#&gt; 2     2                  10 TRUE         </span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="co">#&gt; 3     3                 Inf FALSE</span></span></code></pre></div>
<p>As we explained above, subject 2 is first eligible at time 10. And we
can also see that subject 1 and 3 are never eligible.</p>
<p>Now merge the information</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>simdata <span class="ot">&lt;-</span> simdata <span class="sc">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>  <span class="fu">left_join</span>(eligible_info, <span class="at">by =</span> <span class="st">&quot;id&quot;</span>) </span></code></pre></div>
<p>now we are ready to do the analysis We will perform
intention-to-treatment (ITT) analysis and per-protocol (PP) analysis.
Explain ITT and PP here. #Case I: A new-user, active comparator design;
Intention-to-treat analysis</p>
<p>Subjects become eligible at multiple times. One option is just use
the first time they are eligible. Below we prepare the data for analysis
using this option. In this option, we start follow up from the first
eligible time Select the eligible subjects and keep rows at and after
first eligible time.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>simdata1 <span class="ot">&lt;-</span> simdata <span class="sc">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>  <span class="fu">filter</span>(time <span class="sc">&gt;=</span> first_eligible_time) <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>ever_eligible)</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>simdata.one.trial <span class="ot">&lt;-</span> simdata1 <span class="sc">%&gt;%</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">follow_up =</span> time <span class="sc">-</span> first_eligible_time) <span class="sc">%&gt;%</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>first_eligible_time, <span class="sc">-</span>eligible) </span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>baseline<span class="ot">=</span>simdata.one.trial <span class="sc">%&gt;%</span><span class="fu">filter</span>(follow_up<span class="sc">==</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>  <span class="fu">select</span>(id, A, X1, X2, X3, X4, age) <span class="sc">%&gt;%</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">assigned_treatment =</span> A, <span class="at">X1_0 =</span> X1, <span class="at">X2_0 =</span> X2, <span class="at">X3_0 =</span> X3, <span class="at">X4_0 =</span> X4, <span class="at">age_0 =</span> age) </span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>simdata.one.trial<span class="ot">=</span>simdata.one.trial <span class="sc">%&gt;%</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>  <span class="fu">left_join</span>(baseline, <span class="at">by =</span> <span class="st">&quot;id&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>  <span class="fu">arrange</span>(id, follow_up)</span></code></pre></div>
<p>This data is ready for ITT analysis.</p>
<p>To perform appropriate analysis we should take into consideration the
censoring mechanism and the treatment assignment mechanism. Bellow are 4
different situations determined by the two mechanisms. 1) treatment
assignment can be seems random and censoring is non-informative.## Add
example here.##. In this situation, a standard ITT analysis can be
performed. 2) treatment assignment is not random and censoring is
non-informative. ## Add example here.##. In this situation, we need to
adjust the bias caused by confounding. We can use propensity score
weighting or regression with confounding variable added as covariates to
adjust the bias. 3) treatment assignment is random and censoring is
informative. ## Add example here.##. In this situation, we can use
inverse probability of censoring weighting (IPCW) to adjust the bias
caused by informative censoring. 4) treatment assignment is not random
and censoring is informative. ## Add example here.##. In this situation,
we need to adjust the bias caused by confounding and informative
censoring. We can use a combination of propensity score weighting of
treatment and censoring to adjust the bias.</p>
<p>Below we demonstrate the analysis under each of the 4 situations.</p>
<p>#Situdation 1: treatment assignment can be seems random and censoring
is non-informative. We can do a Cox regression in this situation. We
first convert the long format data (multiple rows per subject) to short
format data (one row per subject). We keep the baseline values and the
follow-up time and status</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co">#event time of subjects with event or censored</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a> event.cens.time<span class="ot">=</span> simdata.one.trial <span class="sc">%&gt;%</span><span class="fu">filter</span>(Y<span class="sc">==</span><span class="dv">1</span> <span class="sc">|</span> C<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>    <span class="at">follow_up =</span> <span class="fu">min</span>(follow_up, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a> </span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>event.cens.time<span class="ot">=</span>event.cens.time<span class="sc">%&gt;%</span><span class="fu">left_join</span>(simdata.one.trial)<span class="sc">%&gt;%</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>  <span class="fu">select</span>(id, assigned_treatment,X1_0, X2_0, X3_0, X4_0, age_0, follow_up, Y, C )<span class="sc">%&gt;%</span><span class="fu">mutate</span>(</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="fu">ifelse</span>(Y <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> C<span class="sc">==</span><span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>) </span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>  ) </span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(id, follow_up)`</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co">#follow-up time of other subjects</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>event.cens.time0<span class="ot">=</span>simdata.one.trial <span class="sc">%&gt;%</span><span class="fu">filter</span>(<span class="sc">!</span>id<span class="sc">%in%</span>event.cens.time<span class="sc">$</span>id) <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>    <span class="at">follow_up =</span> <span class="fu">max</span>(follow_up, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span><span class="fu">mutate</span>(</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="dv">0</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>  ) </span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>event.cens.time0<span class="ot">=</span>event.cens.time0<span class="sc">%&gt;%</span><span class="fu">left_join</span>(simdata.one.trial)<span class="sc">%&gt;%</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>  <span class="fu">select</span>(id, assigned_treatment,X1_0, X2_0, X3_0, X4_0, age_0, follow_up, outcome)</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(id, follow_up)`</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co">#combine the two data sets</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>simdata.short <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(event.cens.time, event.cens.time0) <span class="sc">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>  <span class="fu">arrange</span>(id)</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="co">#check if all subjects are included</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="fu">setequal</span>(<span class="fu">unique</span>(simdata.one.trial<span class="sc">$</span>id), <span class="fu">unique</span>(simdata.short<span class="sc">$</span>id))</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>Now we simply perform a Cox regression</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>cox_model <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(follow_up, outcome) <span class="sc">~</span> assigned_treatment, <span class="at">data =</span> simdata.short)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="fu">summary</span>(cox_model)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co">#&gt; coxph(formula = Surv(follow_up, outcome) ~ assigned_treatment, </span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="co">#&gt;     data = simdata.short)</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="co">#&gt;   n= 232, number of events= 63 </span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="co">#&gt;                      coef exp(coef) se(coef)     z Pr(&gt;|z|)</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a><span class="co">#&gt; assigned_treatment 0.2043    1.2266   0.3115 0.656    0.512</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a><span class="co">#&gt;                    exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a><span class="co">#&gt; assigned_treatment     1.227     0.8153    0.6661     2.259</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a><span class="co">#&gt; Concordance= 0.518  (se = 0.028 )</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a><span class="co">#&gt; Likelihood ratio test= 0.41  on 1 df,   p=0.5</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a><span class="co">#&gt; Wald test            = 0.43  on 1 df,   p=0.5</span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a><span class="co">#&gt; Score (logrank) test = 0.43  on 1 df,   p=0.5</span></span></code></pre></div>
<p>#situation 2: treatment assignment is not random and censoring is
non-informative. We can use propensity score weighting to adjust the
bias caused by confounding. We can use the data we prepared above to do
this analysis.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="co"># Fit a logistic regression model to estimate the propensity scores</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>ps_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(assigned_treatment <span class="sc">~</span> X1_0 <span class="sc">+</span> X2_0 <span class="sc">+</span> X3_0 <span class="sc">+</span> X4_0 <span class="sc">+</span> age_0, </span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>                 <span class="at">data =</span> simdata.short, </span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>                 <span class="at">family =</span> binomial)</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="co"># Calculate the propensity scores</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>p<span class="ot">=</span><span class="fu">predict</span>(ps_model, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a><span class="co"># Calculate the inverse probability of treatment weights</span></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>simdata.short<span class="ot">=</span>simdata.short<span class="sc">%&gt;%</span><span class="fu">mutate</span>(<span class="at">weight=</span><span class="fu">if_else</span>(assigned_treatment<span class="sc">==</span><span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>p, <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>p)))</span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="co">#check overlapping of the weight</span></span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>simdata.short<span class="sc">%&gt;%</span><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>weight, <span class="at">fill=</span><span class="fu">as.factor</span>(assigned_treatment))) <span class="sc">+</span></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">position=</span><span class="st">&quot;identity&quot;</span>, <span class="at">alpha=</span><span class="fl">0.5</span>, <span class="at">bins=</span><span class="dv">30</span>) <span class="sc">+</span></span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;Distribution of Weights by Treatment Group&quot;</span>, <span class="at">x=</span><span class="st">&quot;Weight&quot;</span>, <span class="at">y=</span><span class="st">&quot;Count&quot;</span>) <span class="sc">+</span></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="at">name=</span><span class="st">&quot;Treatment Group&quot;</span>) <span class="sc">+</span></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img role="img" src="data:image/png;base64,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" /><!-- --></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co">#truncate the weight at 97.5th percentile</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>simdata.short <span class="ot">&lt;-</span> simdata.short <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight =</span> <span class="fu">ifelse</span>(weight <span class="sc">&gt;</span> <span class="fu">quantile</span>(weight, <span class="fl">0.975</span>), <span class="fu">quantile</span>(weight, <span class="fl">0.975</span>), weight))</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="do">###here to add code to check banalce of the covariates</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="co">#run a weighted cox regression</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>weighted_cox_model <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(follow_up, outcome) <span class="sc">~</span> assigned_treatment, </span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>                             <span class="at">data =</span> simdata.short, </span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>                             <span class="at">weights =</span> weight)</span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a><span class="fu">summary</span>(weighted_cox_model)</span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a><span class="co">#&gt; coxph(formula = Surv(follow_up, outcome) ~ assigned_treatment, </span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a><span class="co">#&gt;     data = simdata.short, weights = weight)</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a><span class="co">#&gt;   n= 232, number of events= 63 </span></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a><span class="co">#&gt;                       coef exp(coef) se(coef) robust se      z Pr(&gt;|z|)</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a><span class="co">#&gt; assigned_treatment -0.3351    0.7153   0.2007    0.3675 -0.912    0.362</span></span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a><span class="co">#&gt;                    exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a><span class="co">#&gt; assigned_treatment    0.7153      1.398     0.348      1.47</span></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a><span class="co">#&gt; Concordance= 0.539  (se = 0.046 )</span></span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a><span class="co">#&gt; Likelihood ratio test= 2.85  on 1 df,   p=0.09</span></span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a><span class="co">#&gt; Wald test            = 0.83  on 1 df,   p=0.4</span></span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a><span class="co">#&gt; Score (logrank) test = 2.81  on 1 df,   p=0.09,   Robust = 0.93  p=0.3</span></span>
<span id="cb17-27"><a href="#cb17-27" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb17-28"><a href="#cb17-28" tabindex="-1"></a><span class="co">#&gt;   (Note: the likelihood ratio and score tests assume independence of</span></span>
<span id="cb17-29"><a href="#cb17-29" tabindex="-1"></a><span class="co">#&gt;      observations within a cluster, the Wald and robust score tests do not).</span></span></code></pre></div>
<p>#situation 3: treatment assignment is random and censoring is
informative. We can use inverse probability of censoring weighting
(IPCW) to adjust the bias caused by informative censoring.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co"># Fit a logistic regression model to estimate the censoring probabilities</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>censor_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(C <span class="sc">~</span> assigned_treatment <span class="sc">+</span> X1_0 <span class="sc">+</span> X2_0 <span class="sc">+</span> X3_0 <span class="sc">+</span> X4_0 <span class="sc">+</span> age_0, </span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>                     <span class="at">data =</span> simdata.one.trial, </span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>                     <span class="at">family =</span> binomial)</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a><span class="co"># Calculate the censoring probabilities</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>censor_probs <span class="ot">&lt;-</span> <span class="fu">predict</span>(censor_model, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a><span class="co"># Calculate the inverse probability of censoring weights</span></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>simdata.one.trial <span class="ot">&lt;-</span> simdata.one.trial <span class="sc">%&gt;%</span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">censor_weight =</span> <span class="fu">ifelse</span>(C <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span> <span class="sc">/</span> censor_probs, <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> censor_probs)))</span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a><span class="co">#check overlapping of the weight</span></span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>simdata.one.trial <span class="sc">%&gt;%</span></span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> censor_weight, <span class="at">fill =</span> <span class="fu">as.factor</span>(assigned_treatment))) <span class="sc">+</span></span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">position =</span> <span class="st">&quot;identity&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">bins =</span> <span class="dv">30</span>) <span class="sc">+</span></span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Distribution of Censoring Weights by Treatment Group&quot;</span>, </span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Censoring Weight&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Count&quot;</span>) <span class="sc">+</span></span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a>  <span class="fu">scale_fill_discrete</span>(<span class="at">name =</span> <span class="st">&quot;Treatment Group&quot;</span>) <span class="sc">+</span></span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img role="img" src="data:image/png;base64,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" /><!-- --></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co"># Truncate the censoring weights at the 97.5th percentile</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>simdata.one.trial <span class="ot">&lt;-</span> simdata.one.trial <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">censor_weight =</span> <span class="fu">ifelse</span>(censor_weight <span class="sc">&gt;</span> <span class="fu">quantile</span>(censor_weight, <span class="fl">0.975</span>), </span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>                                <span class="fu">quantile</span>(censor_weight, <span class="fl">0.975</span>), censor_weight))</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a><span class="do">###here to add code to check balance of the covariates</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a><span class="co"># Run a weighted pooled logistic regression</span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>weighted_ipcw_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> assigned_treatment<span class="sc">+</span>follow_up<span class="sc">+</span>follow_up<span class="sc">^</span><span class="dv">2</span>, </span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>                             <span class="at">data =</span> simdata.one.trial<span class="sc">%&gt;%</span><span class="fu">filter</span>(C<span class="sc">!=</span><span class="dv">0</span>), <span class="co">#In an time interval, we consider censoring first. If censoring happens, then we don&#39;t kow the outcome. </span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>                             <span class="at">weights =</span> censor_weight, </span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>                             <span class="at">family =</span> binomial)</span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a><span class="fu">summary</span>(weighted_ipcw_model)</span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a><span class="co">#&gt; glm(formula = Y ~ assigned_treatment + follow_up + follow_up^2, </span></span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a><span class="co">#&gt;     family = binomial, data = simdata.one.trial %&gt;% filter(C != </span></span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a><span class="co">#&gt;         0), weights = censor_weight)</span></span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a><span class="co">#&gt;                     Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a><span class="co">#&gt; (Intercept)         -2.81895    0.21592 -13.056  &lt; 2e-16 ***</span></span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a><span class="co">#&gt; assigned_treatment -16.88089  830.81367  -0.020  0.98379    </span></span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a><span class="co">#&gt; follow_up            0.10416    0.03361   3.099  0.00194 ** </span></span>
<span id="cb19-23"><a href="#cb19-23" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb19-24"><a href="#cb19-24" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb19-25"><a href="#cb19-25" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-26"><a href="#cb19-26" tabindex="-1"></a><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></span>
<span id="cb19-27"><a href="#cb19-27" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-28"><a href="#cb19-28" tabindex="-1"></a><span class="co">#&gt;     Null deviance: 457.50  on 55  degrees of freedom</span></span>
<span id="cb19-29"><a href="#cb19-29" tabindex="-1"></a><span class="co">#&gt; Residual deviance: 422.35  on 53  degrees of freedom</span></span>
<span id="cb19-30"><a href="#cb19-30" tabindex="-1"></a><span class="co">#&gt; AIC: 431.53</span></span>
<span id="cb19-31"><a href="#cb19-31" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb19-32"><a href="#cb19-32" tabindex="-1"></a><span class="co">#&gt; Number of Fisher Scoring iterations: 16</span></span></code></pre></div>
<p>situation 4: treatment assignment is not random and censoring is
informative. We can use a combination of propensity score weighting of
treatment and censoring to adjust the bias.We can use the weight we
calculated in situation 2 and 3 for this analysis</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>simdata.one.trial<span class="ot">=</span>simdata.one.trial<span class="sc">%&gt;%</span><span class="fu">left_join</span>(simdata.short<span class="sc">%&gt;%</span><span class="fu">select</span>(id, weight)<span class="sc">%&gt;%</span><span class="fu">rename</span>(<span class="at">trt.weight=</span>weight))<span class="sc">%&gt;%</span><span class="fu">mutate</span>(<span class="at">weight.TC=</span>trt.weight<span class="sc">*</span>censor_weight)</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="co">#&gt; Joining with `by = join_by(id)`</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>weighted_iptw_ipcw_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Y <span class="sc">~</span> assigned_treatment<span class="sc">+</span>follow_up<span class="sc">+</span>follow_up<span class="sc">^</span><span class="dv">2</span>, </span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>                             <span class="at">data =</span> simdata.one.trial<span class="sc">%&gt;%</span><span class="fu">filter</span>(C<span class="sc">!=</span><span class="dv">0</span>), <span class="co">#In an time interval, we consider censoring first. If censoring happens, then we don&#39;t kow the outcome. </span></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>                             <span class="at">weights =</span> weight.TC, </span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>                             <span class="at">family =</span> binomial)</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a><span class="fu">summary</span>(weighted_iptw_ipcw_model)</span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a><span class="co">#&gt; glm(formula = Y ~ assigned_treatment + follow_up + follow_up^2, </span></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a><span class="co">#&gt;     family = binomial, data = simdata.one.trial %&gt;% filter(C != </span></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a><span class="co">#&gt;         0), weights = weight.TC)</span></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a><span class="co">#&gt;                     Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a><span class="co">#&gt; (Intercept)         -2.74636    0.18833 -14.582  &lt; 2e-16 ***</span></span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a><span class="co">#&gt; assigned_treatment -18.24528  764.27117  -0.024 0.980954    </span></span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a><span class="co">#&gt; follow_up            0.10904    0.02944   3.703 0.000213 ***</span></span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb21-20"><a href="#cb21-20" tabindex="-1"></a><span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span></span>
<span id="cb21-21"><a href="#cb21-21" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb21-22"><a href="#cb21-22" tabindex="-1"></a><span class="co">#&gt;     Null deviance: 664.61  on 55  degrees of freedom</span></span>
<span id="cb21-23"><a href="#cb21-23" tabindex="-1"></a><span class="co">#&gt; Residual deviance: 551.15  on 53  degrees of freedom</span></span>
<span id="cb21-24"><a href="#cb21-24" tabindex="-1"></a><span class="co">#&gt; AIC: 555.61</span></span>
<span id="cb21-25"><a href="#cb21-25" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb21-26"><a href="#cb21-26" tabindex="-1"></a><span class="co">#&gt; Number of Fisher Scoring iterations: 16</span></span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
